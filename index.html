<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Kappa Tracker - Quest Progress Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <h1 class="title" style="margin: 0;">OBS KAPPA TRACKER</h1>
                <div class="user-info" id="user-info" style="display: none; font-size: 12px; color: #888; margin: 0;">
                    Welcome, <span id="user-display-name" style="color: #c7aa6a; font-weight: 600;">-</span>
                </div>
            </div>
            <nav class="nav">
                <a href="#" class="nav-link active" id="dashboard-tab">Dashboard</a>
                <a href="#" class="nav-link" id="finished-quests-tab">Finished Quests</a>
                <a href="#" class="nav-link" id="rankings-tab">Rankings</a>
                <a href="#" class="nav-link" id="profile-tab">Profile</a>
            </nav>
        </div>
        <div class="header-right">
            <button id="collector-progress-btn" class="collector-btn" title="Open Collector Progress" style="background: #6441a5; color: #fff;">
                <i class="fas fa-trophy"></i> COLLECTOR PROGRESS
            </button>
            <button id="kappa-overview-btn" class="kappa-overview-btn" title="Open Kappa Quest Overview" style="background: #6441a5; color: #fff;">
                <i class="fas fa-chart-bar"></i> KAPPA OVERVIEW
            </button>
            <button id="report-bug-btn" class="reset-btn" title="Report a Bug" style="background: #f44336; color: #fff;">
                <i class="fas fa-bug"></i>
            </button>
            <button id="request-feature-btn" class="reset-btn" title="Request a Feature" style="background: #4CAF50; color: #fff;">
                <i class="fas fa-lightbulb"></i>
            </button>
            <button id="complete-all-btn" class="reset-btn" title="Complete all 261 Kappa quests" style="background: #4CAF50; color: #fff; margin-left: 10px;">
                <i class="fas fa-check-double"></i> COMPLETE ALL
            </button>
            <button id="reset-progress-btn" class="reset-btn" title="Reset all progress">
                <i class="fas fa-redo"></i> RESET PROGRESS
            </button>
            <button id="logout-btn" class="reset-btn" title="Logout" style="margin-left: 10px;">
                <i class="fas fa-sign-out-alt"></i> LOGOUT
            </button>
        </div>
    </header>
    
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-content">
                <div class="level-section">
                    <label for="pmc-level">PMC LEVEL:</label>
                    <input type="number" id="pmc-level" min="1" max="79" value="1" class="level-input">
                </div>
                <div class="level-section">
                    <label for="prestige-level">PRESTIGE:</label>
                    <input type="number" id="prestige-level" min="0" max="4" value="0" class="level-input">
                </div>
                <div class="progress-section">
                    <div class="progress-label">COLLECTOR PROGRESS</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0% (0/0 quests)</div>
                </div>
                <div class="quest-mode-section">
                    <label class="quest-mode-toggle">
                        <input type="checkbox" id="show-future-quests" class="quest-mode-checkbox">
                        <span class="quest-mode-slider"></span>
                        <span class="quest-mode-label">Show All Future Quests</span>
                    </label>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Map Overview Section -->
            <section class="map-overview" id="map-overview">
                <div class="overview-stats">
                    <div class="stat-item">
                        <span class="stat-label">Markers needed:</span>
                        <span class="stat-value" id="markers-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Jammers needed:</span>
                        <span class="stat-value" id="jammers-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Cameras needed:</span>
                        <span class="stat-value" id="cameras-count">0</span>
                    </div>
                    <div class="stat-item keys-list-item">
                        <div class="stat-header">
                            <span class="stat-label">Keys needed:</span>
                            <span class="stat-value" id="keys-count">0</span>
                        </div>
                        <div class="keys-list" id="keys-list">None</div>
                    </div>
                    <div class="stat-item fir-list-item">
                        <div class="stat-header">
                            <span class="stat-label">FIR items needed:</span>
                        </div>
                        <div class="fir-list" id="fir-list">None</div>
                    </div>
                </div>
            </section>

            <!-- Map Tabs Section -->
            <section class="map-tabs-section">
                <div class="map-tabs" id="map-tabs">
                    <div class="loading">Loading maps...</div>
                </div>
            </section>

            <!-- Quests Section -->
            <section class="quests-section" id="quests-section">
                <div class="quests-grid" id="quests-grid">
                    <div class="loading">Loading quests...</div>
                </div>
            </section>

            <!-- Rankings Section -->
            <section class="rankings-section" id="rankings-section" style="display: none;">
                <div id="rankings-content"></div>
            </section>

            <!-- Profile Section -->
            <section class="profile-section" id="profile-section" style="display: none;">
                <div id="profile-content"></div>
            </section>
        </main>
    </div>

    <!-- Footer Status Bar -->
    <footer class="footer-statusbar">
        <p>Made by <a href="https://twitch.tv/mozula" target="_blank" rel="noopener noreferrer">twitch.tv/mozula</a> for free. Feel free to drop a follow!</p>
    </footer>

    <!-- Reset Progress Warning Dialog -->
    <div id="reset-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>⚠️ Reset Progress Warning</h3>
            </div>
            <div class="dialog-body">
                <p><strong>Are you sure you want to reset your progress?</strong></p>
                <p>This action will:</p>
                <ul>
                    <li>Reset your PMC level to 1</li>
                    <li>Clear all completed quests</li>
                    <li>Remove all progress tracking data</li>
                </ul>
                <p><strong>This action cannot be undone!</strong></p>
            </div>
            <div class="dialog-footer">
                <button id="cancel-reset" class="dialog-btn cancel-btn">Cancel</button>
                <button id="confirm-reset" class="dialog-btn confirm-btn">Reset Progress</button>
            </div>
        </div>
    </div>

    <!-- Complete All Confirmation Dialog -->
    <div id="complete-all-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>✓ Complete All Quests</h3>
            </div>
            <div class="dialog-body">
                <p><strong>Are you sure you want to complete all 261 Kappa quests?</strong></p>
                <p>This will:</p>
                <ul>
                    <li>Mark all 261 Kappa-required quests as completed</li>
                    <li>Update your completion rate to 100%</li>
                    <li>Update your rankings position</li>
                </ul>
                <p><strong>This action can be undone by uncompleting quests individually or using Reset Progress.</strong></p>
            </div>
            <div class="dialog-footer">
                <button id="cancel-complete-all" class="dialog-btn cancel-btn">Cancel</button>
                <button id="confirm-complete-all" class="dialog-btn confirm-btn">Complete All</button>
            </div>
        </div>
    </div>

    <!-- Gunsmith Build Image Dialog -->
    <div id="gunsmith-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 90%; max-height: 90vh;">
            <div class="dialog-header">
                <h3 id="gunsmith-title">Gunsmith Build</h3>
                <button id="close-gunsmith" style="background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; margin-left: auto;">&times;</button>
            </div>
            <div class="dialog-body" style="overflow-y: auto; max-height: 75vh;">
                <div id="gunsmith-images" style="display: flex; flex-direction: column; gap: 15px; align-items: center;"></div>
            </div>
        </div>
    </div>

    <!-- Report Dialog (Bug/Feature) -->
    <div id="report-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 500px;">
            <div class="dialog-header">
                <h3 id="report-dialog-title">Report Bug</h3>
            </div>
            <div class="dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #c7aa6a; margin-bottom: 5px; font-weight: 600;">Title:</label>
                    <input type="text" id="report-title" placeholder="Brief description" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid #3a3a3a; border-radius: 6px; color: #fff;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #c7aa6a; margin-bottom: 5px; font-weight: 600;">Description:</label>
                    <textarea id="report-description" placeholder="Provide details..." rows="5" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid #3a3a3a; border-radius: 6px; color: #fff; resize: vertical;"></textarea>
                </div>
                <div id="report-error" style="display: none; color: #ff6b6b; font-size: 14px; margin-bottom: 10px;"></div>
                <div id="report-success" style="display: none; color: #51cf66; font-size: 14px; margin-bottom: 10px;"></div>
            </div>
            <div class="dialog-footer">
                <button id="cancel-report" class="dialog-btn cancel-btn">Cancel</button>
                <button id="submit-report" class="dialog-btn confirm-btn">Submit</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Check authentication on page load
        fetch('/api/auth/status', { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (!data.authenticated) {
                    window.location.href = '/login';
                } else {
                    // Show user info
                    const userInfo = document.getElementById('user-info');
                    const displayName = document.getElementById('user-display-name');
                    if (userInfo && displayName) {
                        displayName.textContent = data.user.displayName || data.user.username;
                        userInfo.style.display = 'block';
                    }
                }
            })
            .catch(err => {
                console.error('Auth check error:', err);
                window.location.href = '/login';
            });

        // Logout functionality
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    await fetch('/api/auth/logout', { 
                        method: 'POST', 
                        credentials: 'include' 
                    });
                    window.location.href = '/login';
                });
            }

            // Complete All dialog functionality
            const completeAllDialog = document.getElementById('complete-all-dialog');
            const completeAllBtn = document.getElementById('complete-all-btn');
            const cancelCompleteAllBtn = document.getElementById('cancel-complete-all');
            const confirmCompleteAllBtn = document.getElementById('confirm-complete-all');
            
            if (completeAllBtn) {
                completeAllBtn.addEventListener('click', () => {
                    completeAllDialog.style.display = 'flex';
                });
            }
            
            if (cancelCompleteAllBtn) {
                cancelCompleteAllBtn.addEventListener('click', () => {
                    completeAllDialog.style.display = 'none';
                });
            }
            
            if (confirmCompleteAllBtn) {
                confirmCompleteAllBtn.addEventListener('click', async () => {
                    confirmCompleteAllBtn.disabled = true;
                    confirmCompleteAllBtn.textContent = 'Completing...';
                    
                    try {
                        // Call the Complete All function on the tracker
                        if (window.tracker) {
                            await window.tracker.completeAllQuests();
                        }
                        completeAllDialog.style.display = 'none';
                    } catch (error) {
                        console.error('Error completing all quests:', error);
                        alert('Failed to complete all quests. Please try again.');
                    } finally {
                        confirmCompleteAllBtn.disabled = false;
                        confirmCompleteAllBtn.textContent = 'Complete All';
                    }
                });
            }
            
            // Click outside to close
            if (completeAllDialog) {
                completeAllDialog.addEventListener('click', (e) => {
                    if (e.target === completeAllDialog) {
                        completeAllDialog.style.display = 'none';
                    }
                });
            }

            // Gunsmith build dialog functionality
            const gunsmithDialog = document.getElementById('gunsmith-dialog');
            const closeGunsmithBtn = document.getElementById('close-gunsmith');
            
            if (closeGunsmithBtn) {
                closeGunsmithBtn.addEventListener('click', () => {
                    gunsmithDialog.style.display = 'none';
                });
            }
            
            if (gunsmithDialog) {
                gunsmithDialog.addEventListener('click', (e) => {
                    if (e.target === gunsmithDialog) {
                        gunsmithDialog.style.display = 'none';
                    }
                });
            }

            // Report dialog functionality
            const reportDialog = document.getElementById('report-dialog');
            const reportBugBtn = document.getElementById('report-bug-btn');
            const requestFeatureBtn = document.getElementById('request-feature-btn');
            const cancelReportBtn = document.getElementById('cancel-report');
            const submitReportBtn = document.getElementById('submit-report');
            const reportTitle = document.getElementById('report-title');
            const reportDescription = document.getElementById('report-description');
            const reportError = document.getElementById('report-error');
            const reportSuccess = document.getElementById('report-success');
            const reportDialogTitle = document.getElementById('report-dialog-title');
            
            let currentReportType = 'bug';
            
            function openReportDialog(type) {
                currentReportType = type;
                reportDialogTitle.textContent = type === 'bug' ? 'Report a Bug' : 'Request a Feature';
                reportTitle.value = '';
                reportDescription.value = '';
                reportError.style.display = 'none';
                reportSuccess.style.display = 'none';
                reportDialog.style.display = 'flex';
            }
            
            function closeReportDialog() {
                reportDialog.style.display = 'none';
            }
            
            reportBugBtn.addEventListener('click', () => openReportDialog('bug'));
            requestFeatureBtn.addEventListener('click', () => openReportDialog('feature'));
            cancelReportBtn.addEventListener('click', closeReportDialog);
            
            reportDialog.addEventListener('click', (e) => {
                if (e.target === reportDialog) closeReportDialog();
            });
            
            submitReportBtn.addEventListener('click', async () => {
                const title = reportTitle.value.trim();
                const description = reportDescription.value.trim();
                
                reportError.style.display = 'none';
                reportSuccess.style.display = 'none';
                
                if (!title || title.length < 3) {
                    reportError.textContent = 'Title must be at least 3 characters';
                    reportError.style.display = 'block';
                    return;
                }
                
                if (!description || description.length < 10) {
                    reportError.textContent = 'Description must be at least 10 characters';
                    reportError.style.display = 'block';
                    return;
                }
                
                submitReportBtn.disabled = true;
                submitReportBtn.textContent = 'Submitting...';
                
                try {
                    const response = await fetch('/api/reports', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ type: currentReportType, title, description })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        reportSuccess.textContent = 'Thank you! Your report has been submitted.';
                        reportSuccess.style.display = 'block';
                        setTimeout(() => {
                            closeReportDialog();
                        }, 2000);
                    } else {
                        reportError.textContent = data.error || 'Failed to submit report';
                        reportError.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error submitting report:', error);
                    reportError.textContent = 'An error occurred. Please try again.';
                    reportError.style.display = 'block';
                } finally {
                    submitReportBtn.disabled = false;
                    submitReportBtn.textContent = 'Submit';
                }
            });

            // Initialize the quest tracker
            window.tracker = new QuestTracker();
        });
    </script>
</body>
</html>