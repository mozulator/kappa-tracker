<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>OBS Kappa Tracker - Track Your Escape From Tarkov Kappa Quest Progress</title>
    <meta name="title" content="OBS Kappa Tracker - Track Your Escape From Tarkov Kappa Quest Progress">
    <meta name="description" content="Track your Escape From Tarkov Kappa quest progression with OBS integration. Multi-user web application featuring a public leaderboard, quest tracking, and administrative tools for EFT players.">
    <meta name="keywords" content="Escape From Tarkov, EFT, Kappa, Quest Tracker, OBS, Tarkov Quests, Kappa Container, Quest Progress, Gaming Tracker, Tarkov Tools">
    <meta name="author" content="OBS Kappa Tracker">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://kappa-tracker.onrender.com/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kappa-tracker.onrender.com/">
    <meta property="og:title" content="OBS Kappa Tracker - Track Your Escape From Tarkov Kappa Quest Progress">
    <meta property="og:description" content="Track your Escape From Tarkov Kappa quest progression with OBS integration. Multi-user web application featuring a public leaderboard, quest tracking, and administrative tools for EFT players.">
    <meta property="og:image" content="https://kappa-tracker.onrender.com/imgs/kaban.png">
    <meta property="og:site_name" content="OBS Kappa Tracker">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kappa-tracker.onrender.com/">
    <meta property="twitter:title" content="OBS Kappa Tracker - Track Your Escape From Tarkov Kappa Quest Progress">
    <meta property="twitter:description" content="Track your Escape From Tarkov Kappa quest progression with OBS integration. Multi-user web application featuring a public leaderboard, quest tracking, and administrative tools for EFT players.">
    <meta property="twitter:image" content="https://kappa-tracker.onrender.com/imgs/kaban.png">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#c7aa6a">
    <meta name="msapplication-TileColor" content="#c7aa6a">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "OBS Kappa Tracker",
      "description": "A multi-user web application for tracking Escape From Tarkov Kappa quest progression, featuring OBS integration, a public leaderboard, and administrative tools.",
      "url": "https://kappa-tracker.onrender.com/",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "Quest Progress Tracking",
        "OBS Integration",
        "Public Leaderboard",
        "Prestige System",
        "Multi-user Support",
        "Twitch Integration",
        "Tarkov.dev Integration"
      ],
      "screenshot": "https://kappa-tracker.onrender.com/imgs/kaban.png",
      "author": {
        "@type": "Organization",
        "name": "OBS Kappa Tracker"
      }
    }
    </script>
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <h1 class="title" style="margin: 0;">OBS KAPPA TRACKER</h1>
                <div class="user-info" id="user-info" style="display: none; font-size: 12px; color: #888; margin: 0;">
                    Welcome, <span id="user-display-name" style="color: #c7aa6a; font-weight: 600;">-</span>
                </div>
            </div>
            <nav class="nav">
                <a href="#" class="nav-link active" id="dashboard-tab">Dashboard</a>
                <a href="#" class="nav-link" id="finished-quests-tab">Finished Quests</a>
                <a href="#" class="nav-link" id="fix-quests-tab" style="display: none;">
                    <i class="fas fa-tools"></i> Fix Quests
                </a>
                <a href="#" class="nav-link" id="rankings-tab">Rankings</a>
                <a href="#" class="nav-link" id="profile-tab">Profile</a>
                <div class="nav-dropdown">
                    <a href="#" class="nav-link" id="obs-integration-tab">
                        OBS Integration <i class="fas fa-chevron-down" style="font-size: 10px; margin-left: 4px;"></i>
                    </a>
                    <div class="dropdown-menu" id="obs-dropdown">
                        <a href="/collector-progress.html" target="_blank" class="dropdown-item" id="collector-progress-link">
                            <i class="fas fa-trophy"></i> Collector Progress
                        </a>
                        <a href="/kappa-overview.html" target="_blank" class="dropdown-item" id="kappa-overview-link">
                            <i class="fas fa-chart-bar"></i> Kappa Overview
                        </a>
                        <a href="https://www.youtube.com/watch?v=8ysn_HS_Y9k&feature=youtu.be" target="_blank" class="dropdown-item" id="obs-tutorial-link">
                            <i class="fas fa-video"></i> How to use?
                        </a>
                    </div>
                </div>
            </nav>
        </div>
        <div class="header-right">
            <button id="report-bug-btn" class="reset-btn report-bug" title="Report a Bug">
                <i class="fas fa-bug"></i> REPORT BUG
            </button>
            <button id="request-feature-btn" class="reset-btn request-feature" title="Request a Feature">
                <i class="fas fa-lightbulb"></i> REQUEST FEATURE
            </button>
            <button id="logout-btn" class="reset-btn" title="Logout" style="margin-left: 10px;">
                <i class="fas fa-sign-out-alt"></i> LOGOUT
            </button>
        </div>
    </header>
    
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- Player Stats Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-user"></i> PLAYER STATS
                    </div>
                    <div class="level-section">
                        <label for="pmc-level">PMC Level</label>
                        <input type="number" id="pmc-level" min="1" max="79" value="1" class="level-input">
                    </div>
                    <div class="level-section">
                        <label for="prestige-level">Prestige</label>
                        <input type="number" id="prestige-level" min="0" max="4" value="0" class="level-input">
                    </div>
                </div>

                <!-- Progress Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-chart-line"></i> KAPPA PROGRESS
                    </div>
                    <div class="progress-section">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text" id="progress-text">0% (0/0 quests)</div>
                    </div>
                </div>

                <!-- View Options Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-eye"></i> VIEW OPTIONS
                    </div>
                    <div class="quest-mode-section">
                        <label class="quest-mode-toggle">
                            <input type="checkbox" id="show-future-quests" class="quest-mode-checkbox">
                            <span class="quest-mode-slider"></span>
                            <span class="quest-mode-label">Show All Future Quests</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Actions Footer -->
            <div class="sidebar-footer">
                <button id="complete-all-btn-sidebar" class="sidebar-action-btn complete-all-action" title="Complete all 261 Kappa quests">
                    <i class="fas fa-check-double"></i> Complete All
                </button>
                <button id="reset-progress-btn-sidebar" class="sidebar-action-btn reset-action" title="Reset all progress">
                    <i class="fas fa-redo"></i> Reset Progress
                </button>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Map Overview Section -->
            <section class="map-overview" id="map-overview">
                <div class="overview-stats">
                    <div class="stat-item">
                        <span class="stat-label">Markers needed:</span>
                        <span class="stat-value" id="markers-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Jammers needed:</span>
                        <span class="stat-value" id="jammers-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Cameras needed:</span>
                        <span class="stat-value" id="cameras-count">0</span>
                    </div>
                    <div class="stat-item keys-list-item">
                        <div class="stat-header">
                            <span class="stat-label">Keys needed:</span>
                            <span class="stat-value" id="keys-count">0</span>
                        </div>
                        <div class="keys-list" id="keys-list">None</div>
                    </div>
                    <div class="stat-item fir-list-item">
                        <div class="stat-header">
                            <span class="stat-label">FIR items needed:</span>
                        </div>
                        <div class="fir-list" id="fir-list">None</div>
                    </div>
                </div>
            </section>

            <!-- Map Tabs Section -->
            <section class="map-tabs-section">
                <div class="map-tabs" id="map-tabs">
                    <div class="loading">Loading maps...</div>
                </div>
            </section>

            <!-- Quests Section -->
            <section class="quests-section" id="quests-section">
                <div class="quests-grid" id="quests-grid">
                    <div class="loading">Loading quests...</div>
                </div>
            </section>

            <!-- Rankings Section -->
            <section class="rankings-section" id="rankings-section" style="display: none;">
                <div id="rankings-content"></div>
            </section>

            <!-- Profile Section -->
            <section class="profile-section" id="profile-section" style="display: none;">
                <div id="profile-content"></div>
            </section>

            <!-- Fix Quests Section (Admin Only) -->
            <section class="fix-quests-section" id="fix-quests-section" style="display: none;">
                <div class="quest-search" style="margin-bottom: 30px;">
                    <input type="text" id="fix-quest-search" placeholder="üîç Search quests by name or trader..." style="width: 100%; padding: 15px; background: rgba(30, 30, 30, 0.8); border: 2px solid #3a3a3a; border-radius: 8px; color: #fff; font-size: 16px;">
                </div>
                <style>
                    /* Custom layout for fix quests cards */
                    .fix-quest-card {
                        padding: 15px;
                        display: flex;
                        flex-direction: column;
                        align-items: flex-start;
                        min-height: auto;
                        gap: 8px;
                    }
                    
                    .fix-quest-title {
                        font-size: 14px;
                        font-weight: 600;
                        color: #fff;
                        line-height: 1.4;
                        word-wrap: break-word;
                        width: 100%;
                        margin-bottom: 4px;
                    }
                    
                    .fix-quest-card .level-badge,
                    .fix-quest-card .trader-badge,
                    .fix-quest-card .map-badge,
                    .fix-quest-card .kappa-badge {
                        padding: 4px 8px;
                        font-size: 11px;
                        white-space: nowrap;
                    }
                    
                    .fix-quest-btn {
                        width: 100%;
                        padding: 10px;
                        font-size: 13px;
                        font-weight: 600;
                        margin-top: auto;
                        background: rgba(199, 170, 106, 0.2) !important;
                        border-color: #c7aa6a !important;
                        color: #c7aa6a !important;
                    }
                    
                    .fix-quest-btn:hover {
                        background: rgba(199, 170, 106, 0.3) !important;
                    }
                    
                    /* Custom checkbox styling */
                    input[type="checkbox"] {
                        appearance: none;
                        -webkit-appearance: none;
                        width: 20px;
                        height: 20px;
                        border: 2px solid #3a3a3a;
                        border-radius: 4px;
                        background: rgba(0, 0, 0, 0.5);
                        cursor: pointer;
                        position: relative;
                        transition: all 0.2s ease;
                    }
                    
                    input[type="checkbox"]:hover {
                        border-color: #c7aa6a;
                    }
                    
                    input[type="checkbox"]:checked {
                        background: rgba(199, 170, 106, 0.3);
                        border-color: #c7aa6a;
                    }
                    
                    input[type="checkbox"]:checked::after {
                        content: '‚úì';
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        color: #c7aa6a;
                        font-size: 14px;
                        font-weight: bold;
                    }
                </style>
                <div class="quests-grid" id="fix-quests-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <div class="loading">Loading quests...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Footer Status Bar -->
    <footer class="footer-statusbar">
        <p>Made by <a href="https://twitch.tv/mozula" target="_blank" rel="noopener noreferrer">twitch.tv/mozula</a> for free. Feel free to drop a follow!</p>
    </footer>

    <!-- Reset Progress Warning Dialog -->
    <div id="reset-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>‚ö†Ô∏è Reset Progress Warning</h3>
            </div>
            <div class="dialog-body">
                <p><strong>Are you sure you want to reset your progress?</strong></p>
                <p>This action will:</p>
                <ul>
                    <li>Reset your PMC level to 1</li>
                    <li>Clear all completed quests</li>
                    <li>Remove all progress tracking data</li>
                </ul>
                <p><strong>This action cannot be undone!</strong></p>
            </div>
            <div class="dialog-footer">
                <button id="cancel-reset" class="dialog-btn cancel-btn">Cancel</button>
                <button id="confirm-reset" class="dialog-btn confirm-btn">Reset Progress</button>
            </div>
        </div>
    </div>

    <!-- Complete All Confirmation Dialog -->
    <div id="complete-all-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>‚úì Complete All Quests</h3>
            </div>
            <div class="dialog-body">
                <p><strong>Are you sure you want to complete all 261 Kappa quests?</strong></p>
                <p>This will:</p>
                <ul>
                    <li>Mark all 261 Kappa-required quests as completed</li>
                    <li>Update your completion rate to 100%</li>
                    <li>Update your rankings position</li>
                </ul>
                <p><strong>This action can be undone by uncompleting quests individually or using Reset Progress.</strong></p>
            </div>
            <div class="dialog-footer">
                <button id="cancel-complete-all" class="dialog-btn cancel-btn">Cancel</button>
                <button id="confirm-complete-all" class="dialog-btn confirm-btn">Complete All</button>
            </div>
        </div>
    </div>

    <!-- Report Dialog (Bug/Feature) -->
    <div id="report-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 500px;">
            <div class="dialog-header">
                <h3 id="report-dialog-title">Report Bug</h3>
            </div>
            <div class="dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #c7aa6a; margin-bottom: 5px; font-weight: 600;">Title:</label>
                    <input type="text" id="report-title" placeholder="Brief description" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid #3a3a3a; border-radius: 6px; color: #fff;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #c7aa6a; margin-bottom: 5px; font-weight: 600;">Description:</label>
                    <textarea id="report-description" placeholder="Provide details..." rows="5" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid #3a3a3a; border-radius: 6px; color: #fff; resize: vertical;"></textarea>
                </div>
                <div id="report-error" style="display: none; color: #ff6b6b; font-size: 14px; margin-bottom: 10px;"></div>
                <div id="report-success" style="display: none; color: #51cf66; font-size: 14px; margin-bottom: 10px;"></div>
            </div>
            <div class="dialog-footer">
                <button id="cancel-report" class="dialog-btn cancel-btn">Cancel</button>
                <button id="submit-report" class="dialog-btn confirm-btn">Submit</button>
            </div>
        </div>
    </div>

    <!-- Quest Image Viewer Dialog -->
    <div id="quest-image-viewer" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 98vw; max-height: 98vh; width: 98%; height: 98vh;">
            <div class="dialog-header">
                <h3><i class="fas fa-image"></i> <span id="quest-image-quest-name">Quest Images</span></h3>
            </div>
            <div class="dialog-body" style="padding: 20px; flex: 1; display: flex; flex-direction: column;">
                <div style="position: relative; display: flex; justify-content: center; align-items: center; flex: 1;">
                    <button id="quest-image-prev" style="position: absolute; left: 10px; padding: 15px 20px; background: rgba(199, 170, 106, 0.2); border: 2px solid #c7aa6a; border-radius: 8px; color: #c7aa6a; cursor: pointer; font-size: 24px; z-index: 10;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <img id="quest-image-display" src="" alt="Quest Image" style="max-width: 95%; max-height: 85vh; object-fit: contain; border-radius: 8px;">
                    <button id="quest-image-next" style="position: absolute; right: 10px; padding: 15px 20px; background: rgba(199, 170, 106, 0.2); border: 2px solid #c7aa6a; border-radius: 8px; color: #c7aa6a; cursor: pointer; font-size: 24px; z-index: 10;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <span id="quest-image-counter" style="color: #c7aa6a; font-size: 16px; font-weight: 600;">1 / 1</span>
                </div>
            </div>
            <div class="dialog-footer">
                <button onclick="document.getElementById('quest-image-viewer').style.display='none'" class="dialog-btn cancel-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Quest Editor Dialog (Admin Only) -->
    <div id="quest-editor-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 1400px; max-height: 90vh; overflow-y: auto; width: 95%;">
            <div class="dialog-header">
                <h3><i class="fas fa-tools"></i> Edit Quest: <span id="editing-quest-name-dialog">Quest Name</span></h3>
            </div>
            <div class="dialog-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Left Column -->
                    <div>
                        <!-- Basic Info -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> Basic Information
                            </h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Quest Name</label>
                                <input type="text" id="edit-name-dialog" readonly style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #3a3a3a; border-radius: 6px; color: #888; cursor: not-allowed;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Trader</label>
                                    <select id="edit-trader-dialog" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 14px;">
                                        <option value="Prapor">Prapor</option>
                                        <option value="Therapist">Therapist</option>
                                        <option value="Fence">Fence</option>
                                        <option value="Skier">Skier</option>
                                        <option value="Peacekeeper">Peacekeeper</option>
                                        <option value="Mechanic">Mechanic</option>
                                        <option value="Ragman">Ragman</option>
                                        <option value="Jaeger">Jaeger</option>
                                        <option value="Lightkeeper">Lightkeeper</option>
                                        <option value="Ref">Ref</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Level Required</label>
                                    <input type="number" id="edit-level-dialog" min="1" max="79" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none;">
                                    <input type="checkbox" id="edit-kappa-required-dialog" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #c7aa6a; font-weight: 600; font-size: 14px;">Required for Kappa Container</span>
                                </label>
                            </div>
                        </div>

                        <!-- Map Location -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-map-marked-alt"></i> Map Location
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Map Name</label>
                            <select id="edit-map-dialog" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 14px;">
                                <option value="Any Location">Any Location</option>
                                <option value="Customs">Customs</option>
                                <option value="Woods">Woods</option>
                                <option value="Shoreline">Shoreline</option>
                                <option value="Interchange">Interchange</option>
                                <option value="Reserve">Reserve</option>
                                <option value="Factory">Factory</option>
                                <option value="The Lab">The Lab</option>
                                <option value="Lighthouse">Lighthouse</option>
                                <option value="Streets of Tarkov">Streets of Tarkov</option>
                                <option value="Ground Zero">Ground Zero</option>
                            </select>
                        </div>

                        <!-- Required Items (Simple) -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-box-open"></i> Required Items
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">MS2000 Markers</label>
                                    <input type="number" id="edit-markers-dialog" min="0" placeholder="0" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">Signal Jammers</label>
                                    <input type="number" id="edit-jammers-dialog" min="0" placeholder="0" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">WI-FI Cameras</label>
                                    <input type="number" id="edit-cameras-dialog" min="0" placeholder="0" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                            </div>

                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Keys Needed</label>
                            <div id="keys-editor-dialog" style="margin-bottom: 10px;">
                                <!-- Keys entries will be added here -->
                            </div>
                            <button onclick="addKeyEntryDialog()" style="padding: 8px 16px; background: rgba(199, 170, 106, 0.2); border: 2px solid #c7aa6a; border-radius: 6px; color: #c7aa6a; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-plus"></i> Add Key
                            </button>

                            <label style="display: block; color: #888; margin: 15px 0 5px 0; font-size: 12px; text-transform: uppercase;">Custom FIR Items</label>
                            <div id="fir-items-editor-dialog" style="margin-bottom: 10px;">
                                <!-- FIR items entries will be added here -->
                            </div>
                            <button onclick="addFirItemEntryDialog()" style="padding: 8px 16px; background: rgba(199, 170, 106, 0.2); border: 2px solid #c7aa6a; border-radius: 6px; color: #c7aa6a; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-plus"></i> Add FIR Item
                            </button>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div>
                        <!-- Prerequisite Quests -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-link"></i> Prerequisite Quests
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">Search and Add Prerequisite Quests</label>
                            <div style="position: relative;">
                                <input type="text" id="prereq-search-dialog" placeholder="Type to search quests..." style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                <div id="prereq-dropdown-dialog" style="position: absolute; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; background: rgba(20, 20, 20, 0.98); border: 2px solid #c7aa6a; border-radius: 6px; margin-top: 5px; z-index: 2000; display: none;"></div>
                            </div>
                            <div id="selected-prereqs-dialog" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
                                <!-- Selected prerequisites will appear here -->
                            </div>
                        </div>

                        <!-- Quest Images -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-images"></i> Quest Images
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">Image URLs (one per line)</label>
                            <textarea id="edit-images-dialog" rows="4" placeholder="https://example.com/image1.png&#10;https://example.com/image2.png" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 12px; resize: vertical;"></textarea>
                            <small style="color: #666; font-size: 11px;">Add image URLs (one per line). These will be displayed when users click the Images button.</small>
                            <div id="current-images-preview" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                                <!-- Image previews will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="quest-edit-alert" style="display: none; padding: 15px; border-radius: 8px; margin-top: 20px;"></div>
            </div>
            <div class="dialog-footer">
                <button id="cancel-quest-edit" class="dialog-btn cancel-btn">Cancel</button>
                <button id="save-quest-edit" class="dialog-btn confirm-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Check authentication BEFORE loading anything
        (async function() {
            try {
                const res = await fetch('/api/auth/status', { credentials: 'include' });
                const data = await res.json();
                
                if (!data.authenticated) {
                    window.location.href = '/login';
                    return; // Stop execution
                }
                
                    // Show user info
                    const userInfo = document.getElementById('user-info');
                    const displayName = document.getElementById('user-display-name');
                    if (userInfo && displayName) {
                        displayName.textContent = data.user.displayName || data.user.username;
                        userInfo.style.display = 'block';
                    }
                
                // Load tracker script only after auth confirmed
                const script = document.createElement('script');
                script.src = 'script.js';
                script.onload = function() {
                    // Initialize tracker after script loads
                    if (typeof QuestTracker !== 'undefined') {
                        window.tracker = new QuestTracker();
                    }
                };
                document.body.appendChild(script);
            } catch (err) {
                console.error('Auth check error:', err);
                window.location.href = '/login';
            }
        })();

        // Logout functionality
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    await fetch('/api/auth/logout', { 
                        method: 'POST', 
                        credentials: 'include' 
                    });
                    window.location.href = '/login';
                });
            }

            // Complete All dialog functionality
            const completeAllDialog = document.getElementById('complete-all-dialog');
            const completeAllBtnSidebar = document.getElementById('complete-all-btn-sidebar');
            const cancelCompleteAllBtn = document.getElementById('cancel-complete-all');
            const confirmCompleteAllBtn = document.getElementById('confirm-complete-all');
            
            // Connect sidebar Complete All button
            if (completeAllBtnSidebar) {
                completeAllBtnSidebar.addEventListener('click', () => {
                    completeAllDialog.style.display = 'flex';
                });
            }
            
            if (cancelCompleteAllBtn) {
                cancelCompleteAllBtn.addEventListener('click', () => {
                    completeAllDialog.style.display = 'none';
                });
            }
            
            if (confirmCompleteAllBtn) {
                confirmCompleteAllBtn.addEventListener('click', async () => {
                    confirmCompleteAllBtn.disabled = true;
                    confirmCompleteAllBtn.textContent = 'Completing...';
                    
                    try {
                        // Call the Complete All function on the tracker
                        if (window.tracker) {
                            await window.tracker.completeAllQuests();
                        }
                        completeAllDialog.style.display = 'none';
                    } catch (error) {
                        console.error('Error completing all quests:', error);
                        alert('Failed to complete all quests. Please try again.');
                    } finally {
                        confirmCompleteAllBtn.disabled = false;
                        confirmCompleteAllBtn.textContent = 'Complete All';
                    }
                });
            }
            
            // Click outside to close
            if (completeAllDialog) {
                completeAllDialog.addEventListener('click', (e) => {
                    if (e.target === completeAllDialog) {
                        completeAllDialog.style.display = 'none';
                    }
                });
            }

            // OBS Integration dropdown functionality
            const obsIntegrationTab = document.getElementById('obs-integration-tab');
            const obsDropdown = document.getElementById('obs-dropdown');
            const collectorProgressLink = document.getElementById('collector-progress-link');
            const kappaOverviewLink = document.getElementById('kappa-overview-link');
            
            if (obsIntegrationTab && obsDropdown) {
                // Toggle dropdown on click
                obsIntegrationTab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    obsDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!obsIntegrationTab.contains(e.target) && !obsDropdown.contains(e.target)) {
                        obsDropdown.classList.remove('show');
                    }
                });
            }
            
            // Update links with current username and handle clicks
            fetch('/api/auth/me', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.user && data.user.username) {
                        const username = data.user.username;
                        if (collectorProgressLink) {
                            collectorProgressLink.href = `/collector-progress.html?username=${username}`;
                        }
                        if (kappaOverviewLink) {
                            kappaOverviewLink.href = `/kappa-overview.html?username=${username}`;
                        }
                        
                        // Show Fix Quests button for admins
                        if (data.user.isAdmin) {
                            isAdminUser = true;
                            const fixQuestsTab = document.getElementById('fix-quests-tab');
                            if (fixQuestsTab) {
                                fixQuestsTab.style.display = 'block';
                            }
                            // Setup the tab functionality
                            setupFixQuestsTab();
                        }
                    }
                })
                .catch(err => console.error('Failed to get username:', err));
            
            // Close dropdown when clicking links
            if (collectorProgressLink) {
                collectorProgressLink.addEventListener('click', () => {
                    obsDropdown.classList.remove('show');
                });
            }
            
            if (kappaOverviewLink) {
                kappaOverviewLink.addEventListener('click', () => {
                    obsDropdown.classList.remove('show');
                });
            }

            // Report dialog functionality
            const reportDialog = document.getElementById('report-dialog');
            const reportBugBtn = document.getElementById('report-bug-btn');
            const requestFeatureBtn = document.getElementById('request-feature-btn');
            const cancelReportBtn = document.getElementById('cancel-report');
            const submitReportBtn = document.getElementById('submit-report');
            const reportTitle = document.getElementById('report-title');
            const reportDescription = document.getElementById('report-description');
            const reportError = document.getElementById('report-error');
            const reportSuccess = document.getElementById('report-success');
            const reportDialogTitle = document.getElementById('report-dialog-title');
            
            let currentReportType = 'bug';
            
            function openReportDialog(type) {
                currentReportType = type;
                reportDialogTitle.textContent = type === 'bug' ? 'Report a Bug' : 'Request a Feature';
                reportTitle.value = '';
                reportDescription.value = '';
                reportError.style.display = 'none';
                reportSuccess.style.display = 'none';
                reportDialog.style.display = 'flex';
            }
            
            function closeReportDialog() {
                reportDialog.style.display = 'none';
            }
            
            reportBugBtn.addEventListener('click', () => openReportDialog('bug'));
            requestFeatureBtn.addEventListener('click', () => openReportDialog('feature'));
            cancelReportBtn.addEventListener('click', closeReportDialog);
            
            reportDialog.addEventListener('click', (e) => {
                if (e.target === reportDialog) closeReportDialog();
            });
            
            submitReportBtn.addEventListener('click', async () => {
                const title = reportTitle.value.trim();
                const description = reportDescription.value.trim();
                
                reportError.style.display = 'none';
                reportSuccess.style.display = 'none';
                
                if (!title || title.length < 3) {
                    reportError.textContent = 'Title must be at least 3 characters';
                    reportError.style.display = 'block';
                    return;
                }
                
                if (!description || description.length < 10) {
                    reportError.textContent = 'Description must be at least 10 characters';
                    reportError.style.display = 'block';
                    return;
                }
                
                submitReportBtn.disabled = true;
                submitReportBtn.textContent = 'Submitting...';
                
                try {
                    const response = await fetch('/api/reports', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ type: currentReportType, title, description })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        reportSuccess.textContent = 'Thank you! Your report has been submitted.';
                        reportSuccess.style.display = 'block';
                        setTimeout(() => {
                            closeReportDialog();
                        }, 2000);
                    } else {
                        reportError.textContent = data.error || 'Failed to submit report';
                        reportError.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error submitting report:', error);
                    reportError.textContent = 'An error occurred. Please try again.';
                    reportError.style.display = 'block';
                } finally {
                    submitReportBtn.disabled = false;
                    submitReportBtn.textContent = 'Submit';
                }
            });

            // ========================================================================
            // FIX QUESTS TAB (ADMIN ONLY)
            // ========================================================================
            
            let allQuestsForEdit = [];
            let selectedQuestForEdit = null;
            let selectedPrereqsForEdit = new Set();
            let isAdminUser = false;
            let tarkovItems = []; // All items from tarkov.dev
            let tarkovItemsLoaded = false;

            // Fetch all items from tarkov.dev API
            async function fetchTarkovItems() {
                if (tarkovItemsLoaded && tarkovItems.length > 0) {
                    return tarkovItems;
                }

                try {
                    const query = `
                        query {
                            items {
                                id
                                name
                                shortName
                                iconLink
                            }
                        }
                    `;

                    const response = await fetch('https://api.tarkov.dev/graphql', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query })
                    });

                    const data = await response.json();
                    if (data.data && data.data.items) {
                        tarkovItems = data.data.items.sort((a, b) => a.name.localeCompare(b.name));
                        tarkovItemsLoaded = true;
                        console.log(`Loaded ${tarkovItems.length} items from tarkov.dev`);
                    }
                } catch (error) {
                    console.error('Failed to fetch items from tarkov.dev:', error);
                }

                return tarkovItems;
            }

            function setupFixQuestsTab() {
                const fixQuestsTab = document.getElementById('fix-quests-tab');
                const fixQuestsSection = document.getElementById('fix-quests-section');
                const questsSection = document.getElementById('quests-section');
                const rankingsSection = document.getElementById('rankings-section');
                const profileSection = document.getElementById('profile-section');
                const dashboardTab = document.getElementById('dashboard-tab');
                const finishedQuestsTab = document.getElementById('finished-quests-tab');
                const rankingsTab = document.getElementById('rankings-tab');
                const profileTab = document.getElementById('profile-tab');

                if (!fixQuestsTab) return;

                // Tab click handler
                fixQuestsTab.addEventListener('click', (e) => {
                    e.preventDefault();

                    // Switch tabs
                    [dashboardTab, finishedQuestsTab, fixQuestsTab, rankingsTab, profileTab].forEach(tab => {
                        if (tab) tab.classList.remove('active');
                    });
                    fixQuestsTab.classList.add('active');

                    // Switch sections
                    [questsSection, rankingsSection, profileSection].forEach(section => {
                        if (section) section.style.display = 'none';
                    });
                    
                    // Hide map sections
                    const mapOverview = document.getElementById('map-overview');
                    const mapTabsSection = document.querySelector('.map-tabs-section');
                    if (mapOverview) mapOverview.style.display = 'none';
                    if (mapTabsSection) mapTabsSection.style.display = 'none';
                    
                    if (fixQuestsSection) {
                        fixQuestsSection.style.display = 'block';
                        loadQuestsForFixing();
                    }
                });

                // Quest search
                const fixQuestSearch = document.getElementById('fix-quest-search');
                if (fixQuestSearch) {
                    fixQuestSearch.addEventListener('input', function() {
                        const search = this.value.toLowerCase();
                        const filtered = allQuestsForEdit.filter(q => 
                            q.name.toLowerCase().includes(search) ||
                            q.trader.toLowerCase().includes(search)
                        );
                        displayQuestsForFixing(filtered);
                    });
                }

                // Dialog handlers
                setupQuestEditDialog();
            }

            async function loadQuestsForFixing() {
                try {
                    const response = await fetch('/api/quests', { credentials: 'include' });
                    allQuestsForEdit = await response.json();
                    displayQuestsForFixing(allQuestsForEdit);
                } catch (error) {
                    console.error('Error loading quests for fixing:', error);
                    const grid = document.getElementById('fix-quests-grid');
                    if (grid) {
                        grid.innerHTML = '<div style="text-align:center;color:#ff6b6b;padding:40px;">Failed to load quests</div>';
                    }
                }
            }

            function displayQuestsForFixing(quests) {
                const grid = document.getElementById('fix-quests-grid');
                if (!grid) return;

                if (quests.length === 0) {
                    grid.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No quests found</div>';
                    return;
                }

                // Custom card layout for fix quests
                grid.innerHTML = quests.map(quest => `
                    <div class="quest-card fix-quest-card" data-quest-id="${quest.id}">
                        <div class="fix-quest-title">${quest.name}</div>
                        <span class="level-badge">Lvl ${quest.level}</span>
                        <span class="trader-badge">${quest.trader}</span>
                        ${quest.mapName && quest.mapName !== 'Any Location' ? `<span class="map-badge">${quest.mapName}</span>` : ''}
                        ${quest.requiredForKappa ? '<span class="kappa-badge" style="background: rgba(199, 170, 106, 0.3); color: #c7aa6a; border: 1px solid #c7aa6a;"><i class="fas fa-star"></i> Kappa</span>' : ''}
                        <button class="complete-btn fix-quest-btn" onclick="openQuestEditDialog('${quest.id}')">
                            <i class="fas fa-tools"></i> Fix Quest
                        </button>
                    </div>
                `).join('');
            }

            function setupQuestEditDialog() {
                const dialog = document.getElementById('quest-editor-dialog');
                const cancelBtn = document.getElementById('cancel-quest-edit');
                const saveBtn = document.getElementById('save-quest-edit');

                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        dialog.style.display = 'none';
                    });
                }

                if (saveBtn) {
                    saveBtn.addEventListener('click', saveQuestEdit);
                }

                // Prerequisite quest search
                const prereqSearch = document.getElementById('prereq-search-dialog');
                if (prereqSearch) {
                    prereqSearch.addEventListener('input', function() {
                        const search = this.value.toLowerCase();
                        const dropdown = document.getElementById('prereq-dropdown-dialog');
                        
                        if (search.length < 2) {
                            dropdown.style.display = 'none';
                            return;
                        }

                        const filtered = allQuestsForEdit.filter(q => 
                            q.name.toLowerCase().includes(search) && 
                            q.id !== selectedQuestForEdit.id &&
                            !selectedPrereqsForEdit.has(q.id)
                        );

                        if (filtered.length === 0) {
                            dropdown.innerHTML = '<div style="padding:10px;color:#888;">No quests found</div>';
                        } else {
                            dropdown.innerHTML = filtered.slice(0, 10).map(q => `
                                <div onclick="addPrereqDialog('${q.id}', '${q.name.replace(/'/g, "\\'")}', '${q.trader}')" style="padding:10px;cursor:pointer;color:#fff;border-bottom:1px solid #2a2a2a;">
                                    ${q.name} <span style="color:#888;">(${q.trader})</span>
                                </div>
                            `).join('');
                        }
                        dropdown.style.display = 'block';
                    });

                    prereqSearch.addEventListener('blur', function() {
                        setTimeout(() => {
                            document.getElementById('prereq-dropdown-dialog').style.display = 'none';
                        }, 200);
                    });
                }
            }

            window.openQuestEditDialog = async function(questId) {
                // Load quests if not already loaded
                if (allQuestsForEdit.length === 0) {
                    await loadQuestsForFixing();
                }
                
                selectedQuestForEdit = allQuestsForEdit.find(q => q.id === questId);
                if (!selectedQuestForEdit) {
                    console.error('Quest not found:', questId);
                    return;
                }

                const dialog = document.getElementById('quest-editor-dialog');
                
                // Populate basic info
                document.getElementById('editing-quest-name-dialog').textContent = selectedQuestForEdit.name;
                document.getElementById('edit-name-dialog').value = selectedQuestForEdit.name;
                document.getElementById('edit-trader-dialog').value = selectedQuestForEdit.trader;
                document.getElementById('edit-level-dialog').value = selectedQuestForEdit.level;
                document.getElementById('edit-kappa-required-dialog').checked = selectedQuestForEdit.requiredForKappa || false;
                document.getElementById('edit-map-dialog').value = selectedQuestForEdit.mapName || 'Any Location';

                // Load prerequisite quests
                selectedPrereqsForEdit = new Set(JSON.parse(selectedQuestForEdit.prerequisiteQuests || '[]'));
                updatePrereqsDisplayDialog();

                // Load required items
                const requiredItems = JSON.parse(selectedQuestForEdit.requiredItems || '[]');

                // Parse markers, jammers, cameras, keys, fir items
                let markers = 0, jammers = 0, cameras = 0;
                const keys = [];
                const firItems = [];

                requiredItems.forEach(item => {
                    if (item.category === 'markers') markers = Math.max(markers, item.count || 0);
                    else if (item.category === 'jammers') jammers = Math.max(jammers, item.count || 0);
                    else if (item.name && item.name.includes('WI-FI Camera')) cameras = Math.max(cameras, item.count || 0);
                    else if (item.category === 'keys') keys.push({ name: item.name, count: item.count || 1 });
                    else if (item.category === 'fir') firItems.push({ name: item.name, count: item.count || 1 });
                });

                document.getElementById('edit-markers-dialog').value = markers || '';
                document.getElementById('edit-jammers-dialog').value = jammers || '';
                document.getElementById('edit-cameras-dialog').value = cameras || '';

                // Display keys
                const keysEditor = document.getElementById('keys-editor-dialog');
                keysEditor.innerHTML = keys.map((key, idx) => `
                    <div style="display:flex;gap:10px;margin-bottom:10px;align-items:center;">
                        <input type="text" value="${key.name}" placeholder="Key name" data-key-idx="${idx}" style="flex:1;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <input type="number" value="${key.count}" min="1" placeholder="Count" data-key-count-idx="${idx}" style="width:80px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');

                // Display FIR items
                const firItemsEditor = document.getElementById('fir-items-editor-dialog');
                firItemsEditor.innerHTML = firItems.map((firItem, idx) => `
                    <div style="display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;position:relative;">
                        <div style="flex:1;position:relative;">
                            <input type="text" 
                                   value="${firItem.name}" 
                                   placeholder="Search items..." 
                                   data-fir-search-idx="${idx}" 
                                   autocomplete="off"
                                   style="width:100%;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                            <div class="fir-dropdown" data-fir-dropdown-idx="${idx}" style="position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:rgba(20,20,20,0.98);border:2px solid #c7aa6a;border-radius:6px;margin-top:2px;z-index:9999;display:none;"></div>
                            <input type="hidden" data-fir-item-idx="${idx}" value="${firItem.name}">
                        </div>
                        <input type="number" value="${firItem.count}" min="1" placeholder="Count" data-fir-count-idx="${idx}" style="width:80px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');

                // Setup search for existing FIR items
                firItems.forEach((firItem, idx) => {
                    const searchInput = document.querySelector(`[data-fir-search-idx="${idx}"]`);
                    const dropdown = document.querySelector(`[data-fir-dropdown-idx="${idx}"]`);
                    
                    if (searchInput && dropdown) {
                        searchInput.addEventListener('input', async function() {
                            await fetchTarkovItems(); // Ensure items are loaded
                            const searchTerm = this.value.toLowerCase().trim();
                            
                            if (searchTerm.length === 0) {
                                dropdown.style.display = 'none';
                                return;
                            }
                            
                            const filtered = tarkovItems.filter(item => 
                                item.name.toLowerCase().includes(searchTerm) || 
                                item.shortName.toLowerCase().includes(searchTerm)
                            ).slice(0, 50);
                            
                            if (filtered.length === 0) {
                                dropdown.innerHTML = '<div style="padding:8px;color:#888;">No items found</div>';
                                dropdown.style.display = 'block';
                                return;
                            }
                            
                            dropdown.innerHTML = filtered.map(item => `
                                <div onclick="selectFirItem('${idx}', '${item.name.replace(/'/g, "\\'")}', '${item.id}')" 
                                     style="padding:8px;cursor:pointer;color:#fff;border-bottom:1px solid #333;"
                                     onmouseover="this.style.background='rgba(199,170,106,0.2)'"
                                     onmouseout="this.style.background='transparent'">
                                    ${item.name} ${item.shortName ? `(${item.shortName})` : ''}
                                </div>
                            `).join('');
                            
                            dropdown.style.display = 'block';
                        });
                    }
                });

                // Load images
                const imagesTextarea = document.getElementById('edit-images-dialog');
                const imagesPreview = document.getElementById('current-images-preview');
                if (selectedQuestForEdit.images) {
                    try {
                        const images = JSON.parse(selectedQuestForEdit.images);
                        imagesTextarea.value = images.join('\n');
                        updateImagePreview();
                    } catch (e) {
                        imagesTextarea.value = '';
                    }
                } else {
                    imagesTextarea.value = '';
                    imagesPreview.innerHTML = '';
                }

                // Add image preview update on textarea change
                imagesTextarea.addEventListener('input', updateImagePreview);

                dialog.style.display = 'flex';
            };

            function updateImagePreview() {
                const textarea = document.getElementById('edit-images-dialog');
                const preview = document.getElementById('current-images-preview');
                const urls = textarea.value.split('\n').filter(url => url.trim() !== '');
                
                if (urls.length === 0) {
                    preview.innerHTML = '';
                    return;
                }
                
                preview.innerHTML = urls.map((url, idx) => `
                    <div style="position: relative; border: 2px solid #3a3a3a; border-radius: 6px; overflow: hidden; aspect-ratio: 1;">
                        <img src="${url.trim()}" alt="Preview ${idx + 1}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'100\\'%3E%3Crect fill=\\'%23333\\' width=\\'100\\' height=\\'100\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' fill=\\'%23888\\' font-size=\\'12\\'%3ENo Image%3C/text%3E%3C/svg%3E'">
                    </div>
                `).join('');
            }

            window.addKeyEntryDialog = function() {
                const keysEditor = document.getElementById('keys-editor-dialog');
                const idx = keysEditor.children.length;
                const entry = document.createElement('div');
                entry.style = 'display:flex;gap:10px;margin-bottom:10px;align-items:center;';
                entry.innerHTML = `
                    <input type="text" placeholder="Key name" data-key-idx="${idx}" style="flex:1;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                    <input type="number" value="1" min="1" placeholder="Count" data-key-count-idx="${idx}" style="width:80px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                    <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                keysEditor.appendChild(entry);
            };

            window.addFirItemEntryDialog = async function() {
                // Load items if not already loaded
                await fetchTarkovItems();
                
                const firItemsEditor = document.getElementById('fir-items-editor-dialog');
                const idx = firItemsEditor.children.length;
                const entry = document.createElement('div');
                entry.className = 'fir-item-entry';
                entry.style = 'display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;position:relative;';
                
                entry.innerHTML = `
                    <div style="flex:1;position:relative;">
                        <input type="text" 
                               placeholder="Search items..." 
                               data-fir-search-idx="${idx}" 
                               autocomplete="off"
                               style="width:100%;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <div class="fir-dropdown" data-fir-dropdown-idx="${idx}" style="position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:rgba(20,20,20,0.98);border:2px solid #c7aa6a;border-radius:6px;margin-top:2px;z-index:9999;display:none;"></div>
                        <input type="hidden" data-fir-item-idx="${idx}">
                    </div>
                    <input type="number" value="1" min="1" placeholder="Count" data-fir-count-idx="${idx}" style="width:80px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                    <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                firItemsEditor.appendChild(entry);
                
                // Setup search functionality
                const searchInput = entry.querySelector(`[data-fir-search-idx="${idx}"]`);
                const dropdown = entry.querySelector(`[data-fir-dropdown-idx="${idx}"]`);
                const hiddenInput = entry.querySelector(`[data-fir-item-idx="${idx}"]`);
                
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    if (searchTerm.length === 0) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    const filtered = tarkovItems.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) || 
                        item.shortName.toLowerCase().includes(searchTerm)
                    ).slice(0, 50); // Limit to 50 results for performance
                    
                    if (filtered.length === 0) {
                        dropdown.innerHTML = '<div style="padding:8px;color:#888;">No items found</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = filtered.map(item => `
                        <div onclick="selectFirItem('${idx}', '${item.name.replace(/'/g, "\\'")}', '${item.id}')" 
                             style="padding:8px;cursor:pointer;color:#fff;border-bottom:1px solid #333;"
                             onmouseover="this.style.background='rgba(199,170,106,0.2)'"
                             onmouseout="this.style.background='transparent'">
                            ${item.name} ${item.shortName ? `(${item.shortName})` : ''}
                        </div>
                    `).join('');
                    
                    dropdown.style.display = 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function closeDropdown(e) {
                    if (!entry.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            };

            window.selectFirItem = function(idx, itemName, itemId) {
                const searchInput = document.querySelector(`[data-fir-search-idx="${idx}"]`);
                const hiddenInput = document.querySelector(`[data-fir-item-idx="${idx}"]`);
                const dropdown = document.querySelector(`[data-fir-dropdown-idx="${idx}"]`);
                
                if (searchInput) searchInput.value = itemName;
                if (hiddenInput) hiddenInput.value = itemName; // Store the item name
                if (dropdown) dropdown.style.display = 'none';
            };

            window.addPrereqDialog = function(id, name, trader) {
                selectedPrereqsForEdit.add(id);
                updatePrereqsDisplayDialog();
                document.getElementById('prereq-search-dialog').value = '';
                document.getElementById('prereq-dropdown-dialog').style.display = 'none';
            };

            window.removePrereqDialog = function(id) {
                selectedPrereqsForEdit.delete(id);
                updatePrereqsDisplayDialog();
            };

            function updatePrereqsDisplayDialog() {
                const container = document.getElementById('selected-prereqs-dialog');
                if (selectedPrereqsForEdit.size === 0) {
                    container.innerHTML = '<p style="color:#888;">No prerequisite quests</p>';
                    return;
                }

                container.innerHTML = Array.from(selectedPrereqsForEdit).map(id => {
                    const quest = allQuestsForEdit.find(q => q.id === id);
                    return quest ? `
                        <div style="padding:8px 12px;background:rgba(199,170,106,0.2);border:1px solid #c7aa6a;border-radius:4px;color:#fff;display:flex;align-items:center;gap:8px;">
                            ${quest.name}
                            <i class="fas fa-times" onclick="removePrereqDialog('${id}')" style="cursor:pointer;color:#c83232;"></i>
                        </div>
                    ` : '';
                }).join('');
            }

            async function saveQuestEdit() {
                if (!selectedQuestForEdit) return;

                const saveBtn = document.getElementById('save-quest-edit');
                const alert = document.getElementById('quest-edit-alert');
                
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    // Build required items
                    const requiredItems = [];

                    // Add markers
                    const markers = parseInt(document.getElementById('edit-markers-dialog').value) || 0;
                    if (markers > 0) {
                        requiredItems.push({
                            name: 'MS2000 Marker',
                            count: markers,
                            category: 'markers',
                            type: 'mark'
                        });
                    }

                    // Add jammers
                    const jammers = parseInt(document.getElementById('edit-jammers-dialog').value) || 0;
                    if (jammers > 0) {
                        requiredItems.push({
                            name: 'Signal Jammer',
                            count: jammers,
                            category: 'jammers',
                            type: 'plantItem'
                        });
                    }

                    // Add cameras
                    const cameras = parseInt(document.getElementById('edit-cameras-dialog').value) || 0;
                    if (cameras > 0) {
                        requiredItems.push({
                            name: 'WI-FI Camera',
                            count: cameras,
                            category: 'any',
                            type: 'plantItem'
                        });
                    }

                    // Add keys
                    const keyEntries = document.querySelectorAll('#keys-editor-dialog > div');
                    keyEntries.forEach(entry => {
                        const nameInput = entry.querySelector('input[data-key-idx]');
                        const countInput = entry.querySelector('input[data-key-count-idx]');
                        if (nameInput && nameInput.value.trim()) {
                            requiredItems.push({
                                name: nameInput.value.trim(),
                                count: parseInt(countInput.value) || 1,
                                category: 'keys',
                                type: 'key'
                            });
                        }
                    });

                    // Add FIR items
                    const firItemEntries = document.querySelectorAll('#fir-items-editor-dialog > div');
                    firItemEntries.forEach(entry => {
                        const hiddenInput = entry.querySelector('input[type="hidden"]');
                        const countInput = entry.querySelector('input[data-fir-count-idx]');
                        if (hiddenInput && hiddenInput.value.trim()) {
                            requiredItems.push({
                                name: hiddenInput.value.trim(),
                                count: parseInt(countInput.value) || 1,
                                category: 'fir',
                                type: 'giveItem'
                            });
                        }
                    });

                    const finalRequiredItems = requiredItems;

                    // Get images
                    const imagesText = document.getElementById('edit-images-dialog').value;
                    const imageUrls = imagesText.split('\n').filter(url => url.trim() !== '').map(url => url.trim());

                    const updateData = {
                        trader: document.getElementById('edit-trader-dialog').value,
                        level: parseInt(document.getElementById('edit-level-dialog').value) || 1,
                        requiredForKappa: document.getElementById('edit-kappa-required-dialog').checked,
                        mapName: document.getElementById('edit-map-dialog').value,
                        prerequisiteQuests: JSON.stringify(Array.from(selectedPrereqsForEdit)),
                        requiredItems: JSON.stringify(finalRequiredItems),
                        images: JSON.stringify(imageUrls)
                    };

                    const response = await fetch(`/api/admin/quests/${selectedQuestForEdit.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(updateData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update quest');
                    }

                    // Show success
                    alert.style.display = 'block';
                    alert.style.background = 'rgba(76, 175, 80, 0.2)';
                    alert.style.border = '2px solid #4CAF50';
                    alert.style.color = '#4CAF50';
                    alert.textContent = '‚úÖ Quest updated successfully!';

                    // Reload quests in Fix Quests tab
                    await loadQuestsForFixing();
                    
                    // Reload quests in main tracker so changes appear immediately
                    if (window.tracker) {
                        await window.tracker.loadQuests();
                        window.tracker.updateUI();
                    }

                    // Close dialog after a moment
                    setTimeout(() => {
                        document.getElementById('quest-editor-dialog').style.display = 'none';
                        alert.style.display = 'none';
                    }, 1500);

                } catch (error) {
                    console.error('Error saving quest:', error);
                    alert.style.display = 'block';
                    alert.style.background = 'rgba(200, 50, 50, 0.2)';
                    alert.style.border = '2px solid #c83232';
                    alert.style.color = '#ff6b6b';
                    alert.textContent = '‚ùå Failed to save quest: ' + error.message;
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            }
        });
    </script>
</body>
</html>