<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>OBS Kappa Tracker - Track Your Escape From Tarkov Kappa Quest Progress</title>
    <meta name="title" content="OBS Kappa Tracker - Track Your Escape From Tarkov Kappa Quest Progress">
    <meta name="description" content="Track your Escape From Tarkov Kappa quest progression with OBS integration. Multi-user web application featuring a public leaderboard, quest tracking, and administrative tools for EFT players.">
    <meta name="keywords" content="Escape From Tarkov, EFT, Kappa, Quest Tracker, OBS, Tarkov Quests, Kappa Container, Quest Progress, Gaming Tracker, Tarkov Tools">
    <meta name="author" content="OBS Kappa Tracker">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://kappa-tracker.onrender.com/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kappa-tracker.onrender.com/">
    <meta property="og:title" content="OBS Kappa Tracker - Track Your Escape From Tarkov Kappa Quest Progress">
    <meta property="og:description" content="Track your Escape From Tarkov Kappa quest progression with OBS integration. Multi-user web application featuring a public leaderboard, quest tracking, and administrative tools for EFT players.">
    <meta property="og:image" content="https://kappa-tracker.onrender.com/imgs/kaban.png">
    <meta property="og:site_name" content="OBS Kappa Tracker">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kappa-tracker.onrender.com/">
    <meta property="twitter:title" content="OBS Kappa Tracker - Track Your Escape From Tarkov Kappa Quest Progress">
    <meta property="twitter:description" content="Track your Escape From Tarkov Kappa quest progression with OBS integration. Multi-user web application featuring a public leaderboard, quest tracking, and administrative tools for EFT players.">
    <meta property="twitter:image" content="https://kappa-tracker.onrender.com/imgs/kaban.png">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#c7aa6a">
    <meta name="msapplication-TileColor" content="#c7aa6a">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "OBS Kappa Tracker",
      "description": "A multi-user web application for tracking Escape From Tarkov Kappa quest progression, featuring OBS integration, a public leaderboard, and administrative tools.",
      "url": "https://kappa-tracker.onrender.com/",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "Quest Progress Tracking",
        "OBS Integration",
        "Public Leaderboard",
        "Prestige System",
        "Multi-user Support",
        "Twitch Integration",
        "Tarkov.dev Integration"
      ],
      "screenshot": "https://kappa-tracker.onrender.com/imgs/kaban.png",
      "author": {
        "@type": "Organization",
        "name": "OBS Kappa Tracker"
      }
    }
    </script>
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <h1 class="title" id="main-title" style="margin: 0;">OBS KAPPA TRACKER</h1>
            <nav class="nav">
                <a href="#" class="nav-link active" id="dashboard-tab">Dashboard</a>
                <a href="#" class="nav-link" id="finished-quests-tab">Finished Quests</a>
                <a href="#" class="nav-link" id="rankings-tab">Rankings</a>
                <a href="#" class="nav-link" id="collector-items-tab">
                    Collector Items
                </a>
                <div class="nav-dropdown">
                    <a href="#" class="nav-link" id="obs-integration-tab">
                        OBS Integration <i class="fas fa-chevron-down" style="font-size: 10px; margin-left: 4px;"></i>
                    </a>
                    <div class="dropdown-menu" id="obs-dropdown">
                        <a href="/collector-progress.html" target="_blank" class="dropdown-item" id="collector-progress-link">
                            <i class="fas fa-trophy"></i> Collector Progress
                        </a>
                        <a href="/kappa-overview.html" target="_blank" class="dropdown-item" id="kappa-overview-link">
                            <i class="fas fa-chart-bar"></i> Kappa Overview
                        </a>
                        <a href="/collector-items-overlay" target="_blank" class="dropdown-item" id="collector-items-overlay-link">
                            <i class="fas fa-box-open"></i> Collector Items
                        </a>
                    </div>
                </div>
                <div class="nav-dropdown">
                    <a href="#" class="nav-link" id="feedback-tab">
                        Feedback <i class="fas fa-chevron-down" style="font-size: 10px; margin-left: 4px;"></i>
                    </a>
                    <div class="dropdown-menu" id="feedback-dropdown">
                        <a href="#" class="dropdown-item" id="report-bug-link">
                            <i class="fas fa-bug"></i> Report a Bug
                        </a>
                        <a href="#" class="dropdown-item" id="report-quest-error-link">
                            <i class="fas fa-exclamation-triangle"></i> Report Quest Error
                        </a>
                        <a href="#" class="dropdown-item" id="request-feature-link">
                            <i class="fas fa-lightbulb"></i> Request a Feature
                        </a>
                    </div>
                </div>
                <a href="#" class="nav-link" id="how-to-use-tab">
                    How to Use
                </a>
            </nav>
        </div>
        <div class="header-right">
            <div class="nav-dropdown user-dropdown">
                <a href="#" class="user-avatar-link" id="user-dropdown-tab">
                    <img id="user-avatar" src="" alt="User" class="user-avatar-header">
                </a>
                <div class="dropdown-menu dropdown-menu-right" id="user-dropdown">
                    <a href="#" class="dropdown-item" id="account-link">
                        <i class="fas fa-user-cog"></i> Account
                    </a>
                    <a href="#" class="dropdown-item" id="statistics-link">
                        <i class="fas fa-chart-line"></i> Statistics
                    </a>
                    <a href="#" class="dropdown-item" id="fix-quests-tab" style="display: none;">
                        <i class="fas fa-wrench"></i> Fix Quests
                    </a>
                    <a href="/admin.html" target="_blank" class="dropdown-item" id="admin-dashboard-link" style="display: none;">
                        <i class="fas fa-shield-alt"></i> Admin Dashboard
                    </a>
                    <a href="#" class="dropdown-item" id="logout-link">
                        <i class="fas fa-sign-out-alt"></i> Log Out
                    </a>
                </div>            </div>
        </div>
    </header>
    
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- Progress Section - First -->
                <div class="sidebar-section sidebar-section-kappa-progress">
                    <div class="sidebar-section-title">
                        <i class="fas fa-chart-line"></i> KAPPA PROGRESS
                    </div>
                    <div class="progress-section">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text" id="progress-text">0% (0/0 quests)</div>
                    </div>
                </div>

                <!-- Player Stats Section -->
                <div class="sidebar-section sidebar-section-player-stats">
                    <div class="sidebar-section-title">
                        <i class="fas fa-user"></i> PLAYER STATS
                    </div>
                    <div class="level-sections-inline">
                        <div class="level-section">
                            <label for="prestige-level">Prestige</label>
                            <select id="prestige-level" class="level-input">
                                <option value="-1">PVE</option>
                                <option value="0" selected>P0</option>
                                <option value="1">P1</option>
                                <option value="2">P2</option>
                                <option value="3">P3</option>
                                <option value="4">P4</option>
                            </select>
                        </div>
                        <div class="level-section">
                            <label for="pmc-level">PMC Level</label>
                            <input type="number" id="pmc-level" min="1" max="79" value="1" class="level-input">
                        </div>
                    </div>
                </div>

                <!-- View Options Section -->
                <div class="sidebar-section sidebar-section-view-options">
                    <div class="sidebar-section-title">
                        <i class="fas fa-eye"></i> VIEW OPTIONS
                    </div>
                    <div class="quest-mode-section">
                        <label class="quest-mode-toggle">
                            <input type="checkbox" id="show-future-quests" class="quest-mode-checkbox">
                            <span class="quest-mode-slider"></span>
                            <span class="quest-mode-label">Show All Future Quests</span>
                        </label>
                    </div>
                    <div class="quest-mode-section" style="margin-top: 16px;">
                        <label class="quest-mode-toggle">
                            <input type="checkbox" id="sort-by-trader" class="quest-mode-checkbox">
                            <span class="quest-mode-slider"></span>
                            <span class="quest-mode-label">Sort Quests by Trader</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Actions Footer -->
            <div class="sidebar-footer">
                <button id="complete-all-btn-sidebar" class="sidebar-action-btn complete-all-action" title="Complete all 261 Kappa quests">
                    <i class="fas fa-check-double"></i> Complete All
                </button>
                <button id="reset-progress-btn-sidebar" class="sidebar-action-btn reset-action" title="Reset all progress">
                    <i class="fas fa-redo"></i> Reset Progress
                </button>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Dashboard Section -->
            <section class="dashboard" id="dashboard" style="display: block;">
                <div class="content-with-sidebar">
                    <div class="main-quests-area">
                        <!-- Map Tabs Section -->
                        <section class="map-tabs-section">
                            <div class="map-tabs" id="map-tabs">
                                <div class="loading">Loading maps...</div>
                            </div>
                        </section>

                        <!-- Quests Section -->
                        <section class="quests-section">
                            <div class="quests-grid" id="quests-grid">
                                <div class="loading">Loading quests...</div>
                            </div>
                        </section>
                    </div>

                    <!-- Right Sidebar with Quest Requirements -->
                    <aside class="right-sidebar" id="right-sidebar">
                        <div class="right-sidebar-content">
                            <div class="right-sidebar-title">
                                <i class="fas fa-info-circle"></i> QUEST REQUIREMENTS
                            </div>
                            <section class="map-overview" id="map-overview">
                                <div class="overview-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">Markers needed:</span>
                                        <span class="stat-value" id="markers-count">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Jammers needed:</span>
                                        <span class="stat-value" id="jammers-count">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Cameras needed:</span>
                                        <span class="stat-value" id="cameras-count">0</span>
                                    </div>
                                    <div class="stat-item keys-list-item">
                                        <div class="stat-header">
                                            <span class="stat-label">Keys needed:</span>
                                            <span class="stat-value" id="keys-count">0</span>
                                        </div>
                                        <div class="keys-list" id="keys-list">None</div>
                                    </div>
                                    <div class="stat-item fir-list-item">
                                        <div class="stat-header">
                                            <span class="stat-label">FIR items needed:</span>
                                        </div>
                                        <div class="fir-list" id="fir-list">None</div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </aside>
                </div>
            </section>

            <!-- Finished Quests Section -->
            <section class="finished-quests" id="finished-quests" style="display: none;">
                <section class="map-tabs-section">
                    <div class="map-tabs" id="map-tabs-finished">
                        <div class="loading">Loading maps...</div>
                    </div>
                </section>
                <section class="quests-section">
                    <div class="quests-grid" id="quests-grid-finished">
                        <div class="loading">Loading quests...</div>
                    </div>
                </section>
            </section>

            <!-- Fix Quests Section -->
            <section class="fix-quests" id="fix-quests" style="display: none;">
                <div class="quest-search" style="margin-bottom: 30px;">
                    <input type="text" id="fix-quest-search" placeholder="üîç Search quests by name or trader..." style="width: 100%; padding: 15px; background: rgba(30, 30, 30, 0.8); border: 2px solid #3a3a3a; border-radius: 8px; color: #fff; font-size: 16px;">
                </div>
                <div class="quests-grid" id="fix-quests-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <div class="loading">Loading quests...</div>
                </div>
            </section>

            <!-- Rankings Section -->
            <section class="rankings" id="rankings" style="display: none;">
                <div id="rankings-content"></div>
            </section>

            <!-- Profile Section -->
            <section class="profile" id="profile" style="display: none;">
                <div id="profile-content"></div>
            </section>

            <!-- Collector Items Section -->
            <section class="collector-items" id="collector-items" style="display: none;">
                <div style="margin-bottom: 30px;">
                    <h2 style="color: var(--text-highlight); font-size: 2rem; margin-bottom: 10px;">
                        <i class="fas fa-box-open"></i> Collector Items Tracker <span id="collector-title-count" style="color: var(--subtext); font-size: 1.5rem;"></span>
                    </h2>
                    <p style="color: var(--subtext); font-size: 0.9rem;">
                        Track all Found in Raid items needed for the Collector quest. Click items to mark as found.
                    </p>
                </div>

                <div class="collector-split-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100vh - 300px);">
                    <!-- Needed Items (Left Side) -->
                    <div class="collector-needed" style="background: var(--post-bg); border: 2px solid var(--post-border); border-radius: 8px; padding: 20px; overflow-y: auto;">
                        <h3 style="color: var(--text-highlight); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; position: sticky; top: 0; background: var(--post-bg); padding-bottom: 10px; border-bottom: 2px solid var(--post-border);">
                            <i class="fas fa-search"></i> 
                            <span>Needed Items</span>
                            <span id="needed-count" style="background: rgba(220, 38, 38, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; margin-left: auto;"></span>
                        </h3>
                        <div id="collector-needed-grid" class="collector-grid"></div>
                    </div>

                    <!-- Found Items (Right Side) -->
                    <div class="collector-found" style="background: var(--post-bg); border: 2px solid var(--post-border); border-radius: 8px; padding: 20px; overflow-y: auto;">
                        <h3 style="color: var(--text-highlight); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; position: sticky; top: 0; background: var(--post-bg); padding-bottom: 10px; border-bottom: 2px solid var(--post-border);">
                            <i class="fas fa-check-circle"></i> 
                            <span>Found Items</span>
                            <span id="found-count" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; margin-left: auto;"></span>
                        </h3>
                        <div id="collector-found-grid" class="collector-grid"></div>
                    </div>
                </div>
            </section>

            <!-- Statistics Section -->
            <section class="statistics" id="statistics" style="display: none;">
                <!-- Header with User Selector -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 20px;">
                    <h2 style="color: var(--text-highlight); font-size: 2rem; margin: 0;">
                        <i class="fas fa-chart-line"></i> Statistics
                    </h2>
                    <div class="user-selector-dropdown" id="user-selector-container" style="position: relative;">
                        <button class="user-selector-btn" id="user-selector-btn">
                            <i class="fas fa-user-friends"></i> Select Users
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="user-selector-menu" id="user-selector-menu">
                            <!-- User checkboxes will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Statistics Container -->
                <div class="statistics-container">
                    <!-- Left Section: Graph -->
                    <div class="statistics-section statistics-graph-section">
                        <div class="section-header">
                            <h2><i class="fas fa-chart-line"></i> Quest Progress Over Time</h2>
                        </div>
                        <div id="user-legend" class="user-legend"></div>
                        <div class="chart-container">
                            <canvas id="questProgressChart"></canvas>
                        </div>
                    </div>

                    <!-- Right Section: Activity Log -->
                    <div class="statistics-section statistics-log-section">
                        <div class="section-header">
                            <h2><i class="fas fa-history"></i> Quest Completion Log</h2>
                            <div class="log-filters">
                                <select id="user-filter" class="log-filter-select">
                                    <option value="all">All Users</option>
                                </select>
                            </div>
                        </div>
                        <div class="activity-log" id="activity-log">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin"></i> Loading activity...
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- How to Use Section -->
            <section class="how-to-use" id="how-to-use" style="display: none;">
                <div style="max-width: 1200px; margin: 0 auto;">
                    <h2 style="color: var(--text-highlight); font-size: 1.8rem; margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-question-circle"></i> How to Use Kappa Tracker
                    </h2>
                    
                    <!-- Quick Start -->
                    <div class="help-section">
                        <h3><i class="fas fa-rocket"></i> Quick Start</h3>
                        <p>Welcome to Kappa Tracker! Track your Escape From Tarkov quest progress towards the Kappa Container.</p>
                        <ol>
                            <li>Create an account and log in</li>
                            <li>Set your PMC level and prestige (select "PVE" if you play PVE mode)</li>
                            <li>Check off quests as you complete them</li>
                            <li>View your progress and compare with other players</li>
                        </ol>
                    </div>

                    <!-- Dashboard -->
                    <div class="help-section">
                        <h3><i class="fas fa-home"></i> Dashboard</h3>
                        <p><strong>Your main quest tracking hub.</strong> All quests are organized by map locations or Trader.</p>
                        <ul>
                            <li><strong>Quest Cards:</strong> Click a quest card to mark it as complete/incomplete</li>
                            <li><strong>Map Tabs:</strong> Filter quests by map location or trader</li>
                            <li><strong>Future Quests:</strong> Toggle to show quests you haven't unlocked yet</li>
                            <li><strong>Prerequisites:</strong> See which quests unlock other quests</li>
                        </ul>
                    </div>

                    <!-- Collector Items -->
                    <div class="help-section">
                        <h3><i class="fas fa-box-open"></i> Collector Items</h3>
                        <p>Track all Found in Raid items needed for the Collector quest (required for Kappa).</p>
                        <ul>
                            <li>Click items to mark as found</li>
                            <li>Items automatically move between "Needed" and "Found" lists</li>
                            <li>Progress bar shows your completion percentage</li>
                        </ul>
                    </div>

                    <!-- Rankings -->
                    <div class="help-section">
                        <h3><i class="fas fa-trophy"></i> Rankings</h3>
                        <p>View the global leaderboard and compare your progress.</p>
                        <ul>
                            <li><strong>PVP/PVE Toggle:</strong> Switch between PVP and PVE leaderboards</li>
                            <li><strong>Sort Options:</strong> Sort by prestige or completion percentage</li>
                        </ul>
                    </div>

                    <!-- OBS Integration -->
                    <div class="help-section">
                        <h3><i class="fas fa-video"></i> OBS Integration</h3>
                        <p><strong>Show your quest progress on stream!</strong></p>
                        
                        <div class="help-subsection">
                            <h4><i class="fas fa-trophy"></i> Collector Progress</h4>
                            <p><strong>Recommended Size: 500x100</strong></p>
                            <ol>
                                <li>In OBS, add a <strong>Browser Source</strong></li>
                                <li>Go to <strong>OBS Integration ‚Üí Collector Progress</strong></li>
                                <li>Copy the URL and paste it into the Browser Source</li>
                                <li>Set Width: <code>500</code>, Height: <code>100</code></li>
                                <li>Position the overlay on your stream</li>
                            </ol>
                        </div>

                        <div class="help-subsection">
                            <h4><i class="fas fa-chart-bar"></i> Kappa Overview</h4>
                            <p><strong>Recommended: Full stream size in a separate scene</strong></p>
                            <ol>
                                <li>Create a <strong>new scene</strong> in OBS called "Kappa Progress"</li>
                                <li>Add a <strong>Browser Source</strong> to this scene</li>
                                <li>Go to <strong>OBS Integration ‚Üí Kappa Overview</strong></li>
                                <li>Copy the URL and paste it into the Browser Source</li>
                                <li>Set Width and Height to match your stream resolution (e.g., <code>1920x1080</code>)</li>
                                <li>Use this scene to show viewers your current Kappa quest progress</li>
                            </ol>
                        </div>

                        <div class="help-subsection">
                            <h4><i class="fas fa-box-open"></i> Collector Items</h4>
                            <p><strong>Recommended: Full stream size in a separate scene</strong></p>
                            <ol>
                                <li>Create a <strong>new scene</strong> in OBS called "Collector Items"</li>
                                <li>Add a <strong>Browser Source</strong> to this scene</li>
                                <li>Go to <strong>OBS Integration ‚Üí Collector Items</strong></li>
                                <li>Copy the URL and paste it into the Browser Source</li>
                                <li>Set Width and Height to match your stream resolution (e.g., <code>1920x1080</code>)</li>
                                <li>Show viewers which collector items you still need</li>
                            </ol>
                        </div>

                        <div class="help-note">
                            <i class="fas fa-info-circle"></i>
                            <strong>Pro Tip:</strong> All OBS overlays update automatically as you check off quests and items!
                        </div>
                    </div>

                    <!-- Profile & Settings -->
                    <div class="help-section">
                        <h3><i class="fas fa-user"></i> Profile & Settings</h3>
                        <ul>
                            <li><strong>PMC Level & Prestige:</strong> Keep your character info up to date</li>
                            <li><strong>Display Name:</strong> How your name appears on the leaderboard</li>
                            <li><strong>Twitch Integration:</strong> Link your Twitch account to fetch your profile avatar image</li>
                            <li><strong>Tarkov.dev ID:</strong> Link your Tarkov.dev profile</li>
                        </ul>
                    </div>

                    <!-- Statistics -->
                    <div class="help-section">
                        <h3><i class="fas fa-chart-line"></i> Statistics</h3>
                        <p>Compare your progress with friends and track your quest completion over time.</p>
                        <ul>
                            <li><strong>User Selection:</strong> Click "Select Users" to choose which users appear on the graph</li>
                            <li><strong>Saved Preferences:</strong> Your selections are automatically saved - quickly check how your homies are progressing!</li>
                            <li><strong>Progress Chart:</strong> Visual timeline showing quest completions over time</li>
                            <li><strong>Activity Log:</strong> See recent quest completions from selected users</li>
                            <li><strong>Color Legend:</strong> Each user has their own profile color for easy identification</li>
                        </ul>
                    </div>

                    <!-- Feedback -->
                    <div class="help-section">
                        <h3><i class="fas fa-comment-dots"></i> Feedback</h3>
                        <p>Help improve Kappa Tracker!</p>
                        <ul>
                            <li><strong>Report a Bug:</strong> Found something broken? Let us know!</li>
                            <li><strong>Report Quest Error:</strong> Incorrect quest info? Report it!</li>
                            <li><strong>Request a Feature:</strong> Have an idea? We'd love to hear it!</li>
                        </ul>
                    </div>

                    <div class="help-footer" style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(199, 170, 106, 0.08); border-radius: 6px;">
                        <p style="color: var(--text-highlight); font-size: 0.95rem; margin-bottom: 6px;">
                            <i class="fas fa-heart"></i> Made by <a href="https://twitch.tv/mozula" target="_blank" style="color: var(--text-highlight); text-decoration: underline;">twitch.tv/mozula</a> for free
                        </p>
                        <p style="color: var(--subtext); font-size: 0.85rem;">
                            Feel free to drop a follow! Need help? Found a bug? Use the Feedback menu!
                        </p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Footer Status Bar -->
    <footer class="footer-statusbar">
        <p>Made by <a href="https://twitch.tv/mozula" target="_blank" rel="noopener noreferrer">twitch.tv/mozula</a> for free. Feel free to drop a follow!</p>
    </footer>

    <!-- Reset Progress Warning Dialog -->
    <div id="reset-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>‚ö†Ô∏è Reset Progress Warning</h3>
            </div>
            <div class="dialog-body">
                <p><strong>Are you sure you want to reset your progress?</strong></p>
                <p>This action will:</p>
                <ul>
                    <li>Reset your PMC level to 1</li>
                    <li>Clear all completed quests</li>
                    <li>Remove all progress tracking data</li>
                </ul>
                <p><strong>This action cannot be undone!</strong></p>
            </div>
            <div class="dialog-footer">
                <button id="cancel-reset" class="dialog-btn cancel-btn">Cancel</button>
                <button id="confirm-reset" class="dialog-btn confirm-btn">Reset Progress</button>
            </div>
        </div>
    </div>

    <!-- Complete All Confirmation Dialog -->
    <div id="complete-all-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>‚úì Complete All Quests</h3>
            </div>
            <div class="dialog-body">
                <p><strong>Are you sure you want to complete all 261 Kappa quests?</strong></p>
                <p>This will:</p>
                <ul>
                    <li>Mark all 261 Kappa-required quests as completed</li>
                    <li>Update your completion rate to 100%</li>
                    <li>Update your rankings position</li>
                </ul>
                <p><strong>This action can be undone by uncompleting quests individually or using Reset Progress.</strong></p>
            </div>
            <div class="dialog-footer">
                <button id="cancel-complete-all" class="dialog-btn cancel-btn">Cancel</button>
                <button id="confirm-complete-all" class="dialog-btn confirm-btn">Complete All</button>
            </div>
        </div>
    </div>

    <!-- Report Dialog (Bug/Feature) -->
    <div id="report-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 500px;">
            <div class="dialog-header">
                <h3 id="report-dialog-title">Report Bug</h3>
            </div>
            <div class="dialog-body">
                <div id="quest-search-container" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; color: #c7aa6a; margin-bottom: 5px; font-weight: 600;">Quest Name:</label>
                    <input type="text" id="report-quest-search" placeholder="Search for a quest..." style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid #3a3a3a; border-radius: 6px; color: #fff;">
                    <div id="quest-suggestions" style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.6); border: 1px solid #3a3a3a; border-radius: 6px; margin-top: 5px; display: none;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #c7aa6a; margin-bottom: 5px; font-weight: 600;">Title:</label>
                    <input type="text" id="report-title" placeholder="Brief description" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid #3a3a3a; border-radius: 6px; color: #fff;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #c7aa6a; margin-bottom: 5px; font-weight: 600;">Description:</label>
                    <textarea id="report-description" placeholder="Provide details..." rows="5" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid #3a3a3a; border-radius: 6px; color: #fff; resize: vertical;"></textarea>
                </div>
                <div id="report-error" style="display: none; color: #ff6b6b; font-size: 14px; margin-bottom: 10px;"></div>
                <div id="report-success" style="display: none; color: #51cf66; font-size: 14px; margin-bottom: 10px;"></div>
            </div>
            <div class="dialog-footer">
                <button id="cancel-report" class="dialog-btn cancel-btn">Cancel</button>
                <button id="submit-report" class="dialog-btn confirm-btn">Submit</button>
            </div>
        </div>
    </div>

    <!-- Quest Image Viewer Dialog -->
    <div id="quest-image-viewer" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 98vw; max-height: 98vh; width: 98%; height: 98vh;">
            <div class="dialog-header">
                <h3><i class="fas fa-image"></i> <span id="quest-image-quest-name">Quest Images</span></h3>
                <button class="dialog-close-btn" onclick="document.getElementById('quest-image-viewer').style.display='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="dialog-body" style="padding: 20px; flex: 1; display: flex; flex-direction: column;">
                <div style="position: relative; display: flex; justify-content: center; align-items: center; flex: 1;">
                    <button id="quest-image-prev" style="position: absolute; left: 10px; padding: 15px 20px; background: rgba(199, 170, 106, 0.2); border: 2px solid #c7aa6a; border-radius: 8px; color: #c7aa6a; cursor: pointer; font-size: 24px; z-index: 10;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <img id="quest-image-display" src="" alt="Quest Image" style="max-width: 95%; max-height: 85vh; object-fit: contain; border-radius: 8px;">
                    <button id="quest-image-next" style="position: absolute; right: 10px; padding: 15px 20px; background: rgba(199, 170, 106, 0.2); border: 2px solid #c7aa6a; border-radius: 8px; color: #c7aa6a; cursor: pointer; font-size: 24px; z-index: 10;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <span id="quest-image-counter" style="color: #c7aa6a; font-size: 16px; font-weight: 600;">1 / 1</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quest Editor Dialog (Admin Only) -->
    <div id="quest-editor-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 1400px; max-height: 90vh; overflow-y: auto; width: 95%;">
            <div class="dialog-header">
                <h3><i class="fas fa-tools"></i> Fix Quest</h3>
                <button class="dialog-close-btn" onclick="document.getElementById('quest-editor-dialog').style.display='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Left Column -->
                    <div>
                        <!-- Basic Info -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> Basic Information
                            </h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Quest Name</label>
                                <input type="text" id="edit-name-dialog" readonly style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #3a3a3a; border-radius: 6px; color: #888; cursor: not-allowed;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Trader</label>
                                    <select id="edit-trader-dialog" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 14px;">
                                        <option value="Prapor">Prapor</option>
                                        <option value="Therapist">Therapist</option>
                                        <option value="Fence">Fence</option>
                                        <option value="Skier">Skier</option>
                                        <option value="Peacekeeper">Peacekeeper</option>
                                        <option value="Mechanic">Mechanic</option>
                                        <option value="Ragman">Ragman</option>
                                        <option value="Jaeger">Jaeger</option>
                                        <option value="Lightkeeper">Lightkeeper</option>
                                        <option value="Ref">Ref</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Level Required</label>
                                    <input type="number" id="edit-level-dialog" min="1" max="79" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Unlock After (Hours)</label>
                                    <input type="number" id="edit-unlock-hours-dialog" min="0" max="168" placeholder="0" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none;">
                                    <input type="checkbox" id="edit-kappa-required-dialog" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #c7aa6a; font-weight: 600; font-size: 14px;">Required for Kappa Container</span>
                                </label>
                            </div>
                        </div>

                        <!-- Map Location -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-map-marked-alt"></i> Map Location
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Map Name</label>
                            <select id="edit-map-dialog" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 14px;">
                                <option value="Any Location">Any Location</option>
                                <option value="Customs">Customs</option>
                                <option value="Woods">Woods</option>
                                <option value="Shoreline">Shoreline</option>
                                <option value="Interchange">Interchange</option>
                                <option value="Reserve">Reserve</option>
                                <option value="Factory">Factory</option>
                                <option value="The Lab">The Lab</option>
                                <option value="Lighthouse">Lighthouse</option>
                                <option value="Streets of Tarkov">Streets of Tarkov</option>
                                <option value="Ground Zero">Ground Zero</option>
                            </select>
                        </div>

                        <!-- Required Items (Simple) -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-box-open"></i> Required Items
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">MS2000 Markers</label>
                                    <input type="number" id="edit-markers-dialog" min="0" placeholder="0" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">Signal Jammers</label>
                                    <input type="number" id="edit-jammers-dialog" min="0" placeholder="0" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                                <div>
                                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">WI-FI Cameras</label>
                                    <input type="number" id="edit-cameras-dialog" min="0" placeholder="0" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                </div>
                            </div>

                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Keys Needed</label>
                            <div id="keys-editor-dialog" style="margin-bottom: 10px;">
                                <!-- Keys entries will be added here -->
                            </div>
                            <button onclick="addKeyEntryDialog()" style="padding: 8px 16px; background: rgba(199, 170, 106, 0.2); border: 2px solid #c7aa6a; border-radius: 6px; color: #c7aa6a; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-plus"></i> Add Key
                            </button>

                            <label style="display: block; color: #888; margin: 15px 0 5px 0; font-size: 12px; text-transform: uppercase;">Custom FIR Items</label>
                            <div id="fir-items-editor-dialog" style="margin-bottom: 10px;">
                                <!-- FIR items entries will be added here -->
                            </div>
                            <button onclick="addFirItemEntryDialog()" style="padding: 8px 16px; background: rgba(199, 170, 106, 0.2); border: 2px solid #c7aa6a; border-radius: 6px; color: #c7aa6a; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-plus"></i> Add FIR Item
                            </button>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div>
                        <!-- Prerequisite Quests -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-link"></i> Prerequisite Quests
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">Search and Add Prerequisite Quests</label>
                            <div style="position: relative;">
                                <input type="text" id="prereq-search-dialog" placeholder="Type to search quests..." style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                <div id="prereq-dropdown-dialog" style="position: absolute; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; background: rgba(20, 20, 20, 0.98); border: 2px solid #c7aa6a; border-radius: 6px; margin-top: 5px; z-index: 2000; display: none;"></div>
                            </div>
                            <div id="selected-prereqs-dialog" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
                                <!-- Selected prerequisites will appear here -->
                            </div>
                        </div>

                        <!-- Auto Complete Quests -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-magic"></i> Auto Complete Quests When This Quest is Completed
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">Search and Add Quests to Auto-Complete</label>
                            <div style="position: relative;">
                                <input type="text" id="autocomplete-search-dialog" placeholder="Type to search quests..." style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff;">
                                <div id="autocomplete-dropdown-dialog" style="position: absolute; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; background: rgba(20, 20, 20, 0.98); border: 2px solid #c7aa6a; border-radius: 6px; margin-top: 5px; z-index: 2000; display: none;"></div>
                            </div>
                            <div id="selected-autocomplete-dialog" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
                                <!-- Selected auto-complete quests will appear here -->
                            </div>
                            <small style="color: #666; font-size: 11px; margin-top: 8px; display: block;">When users complete this quest, the selected quests will be automatically marked as completed. Uncompleting this quest will also uncomplete them.</small>
                        </div>

                        <!-- Quest Images -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-images"></i> Quest Images
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">Image URLs (one per line)</label>
                            <textarea id="edit-images-dialog" rows="4" placeholder="https://example.com/image1.png&#10;https://example.com/image2.png" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 12px; resize: vertical;"></textarea>
                            <small style="color: #666; font-size: 11px;">Add image URLs (one per line). These will be displayed when users click the Images button.</small>
                            <div id="current-images-preview" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                                <!-- Image previews will appear here -->
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-sticky-note"></i> Quest Notes
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px;">Additional notes or tips for this quest</label>
                            <textarea id="edit-notes-dialog" rows="3" placeholder="Add any helpful notes, tips, or important information about this quest..." style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 12px; resize: vertical;"></textarea>
                            <small style="color: #666; font-size: 11px;">These notes will be displayed in the quest card below the objectives.</small>
                        </div>

                        <!-- Shopping List (Gunsmith Quests Only) -->
                        <div id="shopping-list-section-dialog" style="margin-bottom: 25px; display: none;">
                            <h4 style="color: #c7aa6a; margin: 0 0 15px 0; border-bottom: 2px solid #3a3a3a; padding-bottom: 10px;">
                                <i class="fas fa-shopping-cart"></i> Shopping List
                            </h4>
                            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">Attachments to Buy</label>
                            <div id="shopping-list-editor-dialog" style="margin-bottom: 10px;">
                                <!-- Shopping list items will be added here -->
                            </div>
                            <button onclick="addShoppingListItemDialog()" style="padding: 8px 16px; background: #c7aa6a; border: none; border-radius: 4px; color: #000; cursor: pointer; font-weight: 600; font-size: 12px;">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                            <small style="display: block; color: #666; font-size: 11px; margin-top: 10px;">Add items needed to buy from traders for this Gunsmith quest.</small>
                        </div>
                    </div>
                </div>

                <div id="quest-edit-alert" style="display: none; padding: 15px; border-radius: 8px; margin-top: 20px;"></div>
            </div>
            <div class="dialog-footer">
                <button id="cancel-quest-edit" class="dialog-btn cancel-btn" onclick="document.getElementById('quest-editor-dialog').style.display='none'">Cancel</button>
                <button id="save-quest-edit" class="dialog-btn confirm-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Check authentication BEFORE loading anything
        (async function() {
            try {
                const res = await fetch('/api/auth/status', { credentials: 'include' });
                const data = await res.json();
                
                if (!data.authenticated) {
                    window.location.href = '/login';
                    return; // Stop execution
                }
                
                    // Store user info for later use
                    window.currentUserId = data.user.id;
                    window.currentUser = data.user;
                
                // Load user avatar now that we have user data
                if (typeof window.loadUserAvatar === 'function') {
                    window.loadUserAvatar();
                }
                
                // Load tracker script only after auth confirmed
                const script = document.createElement('script');
                script.src = '/js/script.js?v=' + Date.now();
                script.onload = function() {
                    // Initialize tracker after script loads
                    if (typeof QuestTracker !== 'undefined') {
                        window.tracker = new QuestTracker();
                        
                        // Check if coming from admin log
                        const adminQuestData = localStorage.getItem('openQuestFromAdmin');
                        if (adminQuestData) {
                            try {
                                const data = JSON.parse(adminQuestData);
                                // Only process if less than 10 seconds old
                                if (Date.now() - data.timestamp < 10000) {
                                    localStorage.removeItem('openQuestFromAdmin');
                                    // Wait for tracker to initialize and quests to load
                                    setTimeout(() => {
                                        openQuestFromAdminLog(data.questName, data.changedFields);
                                    }, 1500);
                                }
                            } catch (e) {
                                console.error('Error parsing admin quest data:', e);
                                localStorage.removeItem('openQuestFromAdmin');
                            }
                        }
                    }
                };
                document.body.appendChild(script);
            } catch (err) {
                console.error('Auth check error:', err);
                window.location.href = '/login';
            }
        })();

        // Global function to load user avatar (called after auth check)
        window.loadUserAvatar = async function() {
            const userDropdownTab = document.getElementById('user-dropdown-tab');
            const userAvatar = document.getElementById('user-avatar');
            
            if (!window.currentUser || !userAvatar) return;
                
                const displayName = window.currentUser.displayName || window.currentUser.username;
                
                // Helper to show default avatar
                function showDefaultAvatar() {
                    const initial = displayName.charAt(0).toUpperCase();
                    userAvatar.style.display = 'none';
                    
                    // Check if default avatar already exists
                    const existing = userDropdownTab.querySelector('.default-avatar-initial');
                    if (existing) return;
                    
                    const defaultAvatar = document.createElement('div');
                    defaultAvatar.className = 'user-avatar-header default-avatar-initial';
                    defaultAvatar.textContent = initial;
                    defaultAvatar.title = displayName;
                    userDropdownTab.insertBefore(defaultAvatar, userAvatar);
                }
                
                // Try 1: Use avatarUrl from database
                if (window.currentUser.avatarUrl) {
                    userAvatar.src = window.currentUser.avatarUrl;
                    userAvatar.alt = displayName;
                    userAvatar.style.display = 'block';
                    
                    // Handle load error
                    userAvatar.onerror = async function() {
                        console.log('Avatar URL failed, trying Twitch API...');
                        await tryTwitchAvatar();
                    };
                    return;
                }
                
                // Try 2: Fetch from Twitch API if no avatarUrl
                async function tryTwitchAvatar() {
                    if (window.currentUser.twitchName) {
                        try {
                            const response = await fetch(`https://decapi.me/twitch/avatar/${window.currentUser.twitchName}`);
                            if (response.ok) {
                                const avatarUrl = await response.text();
                                if (avatarUrl && avatarUrl.trim().startsWith('http')) {
                                    userAvatar.src = avatarUrl.trim();
                                    userAvatar.alt = displayName;
                                    userAvatar.style.display = 'block';
                                    
                                    // Handle error on Twitch avatar too
                                    userAvatar.onerror = function() {
                                        showDefaultAvatar();
                                    };
                                    return;
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching Twitch avatar:', error);
                        }
                    }
                    
                    // Try 3: Show default avatar with initial
                    showDefaultAvatar();
                }
                
                await tryTwitchAvatar();
        };
        
        // Logout and User dropdown functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Setup user dropdown
            const userDropdownTab = document.getElementById('user-dropdown-tab');
            const userDropdown = document.getElementById('user-dropdown');
            const accountLink = document.getElementById('account-link');
            const logoutLink = document.getElementById('logout-link');
            
            // Toggle user dropdown
            if (userDropdownTab && userDropdown) {
                userDropdownTab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    userDropdown.classList.toggle('show');
                    // Close other dropdowns
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                        if (menu !== userDropdown) menu.classList.remove('show');
                    });
                });
                
                // Close dropdown when clicking any item inside it
                userDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        userDropdown.classList.remove('show');
                    });
                });
            }
            
            // Handle account link (profile)
            if (accountLink) {
                accountLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (window.tracker) {
                        window.tracker.switchToProfile();
                    }
                    userDropdown.classList.remove('show');
                });
            }
            
            // Handle logout
            if (logoutLink) {
                logoutLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await fetch('/api/auth/logout', { 
                        method: 'POST', 
                        credentials: 'include' 
                    });
                    window.location.href = '/login';
                });
            }

            // Complete All dialog functionality
            const completeAllDialog = document.getElementById('complete-all-dialog');
            const completeAllBtnSidebar = document.getElementById('complete-all-btn-sidebar');
            const cancelCompleteAllBtn = document.getElementById('cancel-complete-all');
            const confirmCompleteAllBtn = document.getElementById('confirm-complete-all');
            
            // Connect sidebar Complete All button
            if (completeAllBtnSidebar) {
                completeAllBtnSidebar.addEventListener('click', () => {
                    completeAllDialog.style.display = 'flex';
                });
            }
            
            if (cancelCompleteAllBtn) {
                cancelCompleteAllBtn.addEventListener('click', () => {
                    completeAllDialog.style.display = 'none';
                });
            }
            
            if (confirmCompleteAllBtn) {
                confirmCompleteAllBtn.addEventListener('click', async () => {
                    confirmCompleteAllBtn.disabled = true;
                    confirmCompleteAllBtn.textContent = 'Completing...';
                    
                    try {
                        // Call the Complete All function on the tracker
                        if (window.tracker) {
                            await window.tracker.completeAllQuests();
                        }
                        completeAllDialog.style.display = 'none';
                    } catch (error) {
                        console.error('Error completing all quests:', error);
                        alert('Failed to complete all quests. Please try again.');
                    } finally {
                        confirmCompleteAllBtn.disabled = false;
                        confirmCompleteAllBtn.textContent = 'Complete All';
                    }
                });
            }
            
            // Click outside to close
            if (completeAllDialog) {
                completeAllDialog.addEventListener('click', (e) => {
                    if (e.target === completeAllDialog) {
                        completeAllDialog.style.display = 'none';
                    }
                });
            }

            // OBS Integration dropdown functionality
            const obsIntegrationTab = document.getElementById('obs-integration-tab');
            const obsDropdown = document.getElementById('obs-dropdown');
            const collectorProgressLink = document.getElementById('collector-progress-link');
            const kappaOverviewLink = document.getElementById('kappa-overview-link');
            const collectorItemsOverlayLink = document.getElementById('collector-items-overlay-link');
            
            if (obsIntegrationTab && obsDropdown) {
                // Toggle dropdown on click
                obsIntegrationTab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    obsDropdown.classList.toggle('show');
                    // Close other dropdowns
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                        if (menu !== obsDropdown) menu.classList.remove('show');
                    });
                });
            }
            
            // Feedback dropdown functionality
            const feedbackTab = document.getElementById('feedback-tab');
            const feedbackDropdown = document.getElementById('feedback-dropdown');
            const reportBugLink = document.getElementById('report-bug-link');
            const requestFeatureLink = document.getElementById('request-feature-link');
            
            if (feedbackTab && feedbackDropdown) {
                // Toggle dropdown on click
                feedbackTab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    feedbackDropdown.classList.toggle('show');
                    // Close other dropdowns
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                        if (menu !== feedbackDropdown) menu.classList.remove('show');
                    });
                });
            }
            
            // Handle report bug from dropdown
            if (reportBugLink) {
                reportBugLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openReportDialog('bug');
                    feedbackDropdown.classList.remove('show');
                });
            }
            
            // Handle report quest error from dropdown
            const reportQuestErrorLink = document.getElementById('report-quest-error-link');
            if (reportQuestErrorLink) {
                reportQuestErrorLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openReportDialog('quest-error');
                    feedbackDropdown.classList.remove('show');
                });
            }
            
            // Handle request feature from dropdown
            if (requestFeatureLink) {
                requestFeatureLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openReportDialog('feature');
                    feedbackDropdown.classList.remove('show');
                });
            }
            
            // Close all dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                const dropdowns = document.querySelectorAll('.nav-dropdown');
                let clickedInside = false;
                dropdowns.forEach(dropdown => {
                    if (dropdown.contains(e.target)) {
                        clickedInside = true;
                    }
                });
                if (!clickedInside) {
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
            
            // Update links with current username and handle clicks
            fetch('/api/auth/me', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.user && data.user.username) {
                        const username = data.user.username;
                        if (collectorProgressLink) {
                            collectorProgressLink.href = `/collector-progress.html?username=${username}`;
                        }
                        if (kappaOverviewLink) {
                            kappaOverviewLink.href = `/kappa-overview.html?username=${username}`;
                        }
                        if (collectorItemsOverlayLink) {
                            collectorItemsOverlayLink.href = `/collector-items-overlay?username=${username}`;
                        }
                        
                        // Show Fix Quests button for admins
                        if (data.user.isAdmin) {
                            isAdminUser = true;
                            const fixQuestsTab = document.getElementById('fix-quests-tab');
                            if (fixQuestsTab) {
                                fixQuestsTab.style.display = 'block';
                            }
                            // Show Admin Dashboard link in user dropdown
                            const adminDashboardLink = document.getElementById('admin-dashboard-link');
                            if (adminDashboardLink) {
                                adminDashboardLink.style.display = 'block';
                            }
                            // Setup the tab functionality
                            // setupFixQuestsTab(); // Disabled - now handled by script.js QuestTracker class
                        }
                    }
                })
                .catch(err => console.error('Failed to get username:', err));
            
            // Close dropdown when clicking links
            if (collectorProgressLink) {
                collectorProgressLink.addEventListener('click', () => {
                    obsDropdown.classList.remove('show');
                });
            }
            
            if (kappaOverviewLink) {
                kappaOverviewLink.addEventListener('click', () => {
                    obsDropdown.classList.remove('show');
                });
            }

            // Report dialog functionality
            const reportDialog = document.getElementById('report-dialog');
            const reportBugBtn = document.getElementById('report-bug-btn');
            const requestFeatureBtn = document.getElementById('request-feature-btn');
            const cancelReportBtn = document.getElementById('cancel-report');
            const submitReportBtn = document.getElementById('submit-report');
            const reportTitle = document.getElementById('report-title');
            const reportDescription = document.getElementById('report-description');
            const reportError = document.getElementById('report-error');
            const reportSuccess = document.getElementById('report-success');
            const reportDialogTitle = document.getElementById('report-dialog-title');
            
            let currentReportType = 'bug';
            let selectedQuest = null;
            
            function openReportDialog(type) {
                currentReportType = type;
                if (type === 'bug') {
                    reportDialogTitle.textContent = 'Report a Bug';
                } else if (type === 'quest-error') {
                    reportDialogTitle.textContent = 'Report Quest Error';
                } else {
                    reportDialogTitle.textContent = 'Request a Feature';
                }
                
                // Show/hide quest search based on type
                const questSearchContainer = document.getElementById('quest-search-container');
                if (questSearchContainer) {
                    questSearchContainer.style.display = type === 'quest-error' ? 'block' : 'none';
                }
                
                reportTitle.value = '';
                reportDescription.value = '';
                document.getElementById('report-quest-search').value = '';
                document.getElementById('quest-suggestions').style.display = 'none';
                selectedQuest = null;
                reportError.style.display = 'none';
                reportSuccess.style.display = 'none';
                reportDialog.style.display = 'flex';
            }
            
            function closeReportDialog() {
                reportDialog.style.display = 'none';
            }
            
            if (reportBugBtn) reportBugBtn.addEventListener('click', () => openReportDialog('bug'));
            if (requestFeatureBtn) requestFeatureBtn.addEventListener('click', () => openReportDialog('feature'));
            cancelReportBtn.addEventListener('click', closeReportDialog);
            
            reportDialog.addEventListener('click', (e) => {
                if (e.target === reportDialog) closeReportDialog();
            });
            
            // Quest search functionality
            const questSearchInput = document.getElementById('report-quest-search');
            const questSuggestions = document.getElementById('quest-suggestions');
            
            if (questSearchInput) {
                questSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    
                    if (searchTerm.length < 2) {
                        questSuggestions.style.display = 'none';
                        return;
                    }
                    
                    // Get quests from window.tracker
                    const quests = window.tracker?.quests || [];
                    const matches = quests
                        .filter(q => q.name.toLowerCase().includes(searchTerm))
                        .slice(0, 10); // Limit to 10 results
                    
                    if (matches.length === 0) {
                        questSuggestions.style.display = 'none';
                        return;
                    }
                    
                    questSuggestions.innerHTML = matches.map(quest => `
                        <div class="quest-suggestion-item" data-quest-id="${quest.id}" data-quest-name="${quest.name}" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #2a2a2a; color: #fff; transition: background 0.2s;">
                            <div style="font-weight: 600;">${quest.name}</div>
                            <div style="font-size: 0.85rem; color: #888;">${quest.trader}</div>
                        </div>
                    `).join('');
                    
                    questSuggestions.style.display = 'block';
                    
                    // Add click handlers to suggestions
                    questSuggestions.querySelectorAll('.quest-suggestion-item').forEach(item => {
                        item.addEventListener('mouseover', () => {
                            item.style.background = 'rgba(199, 170, 106, 0.2)';
                        });
                        item.addEventListener('mouseout', () => {
                            item.style.background = 'transparent';
                        });
                        item.addEventListener('click', () => {
                            selectedQuest = {
                                id: item.dataset.questId,
                                name: item.dataset.questName
                            };
                            questSearchInput.value = item.dataset.questName;
                            questSuggestions.style.display = 'none';
                        });
                    });
                });
            }
            
            submitReportBtn.addEventListener('click', async () => {
                const title = reportTitle.value.trim();
                const description = reportDescription.value.trim();
                
                reportError.style.display = 'none';
                reportSuccess.style.display = 'none';
                
                // Validate quest selection for quest-error type
                if (currentReportType === 'quest-error' && !selectedQuest) {
                    reportError.textContent = 'Please select a quest from the search';
                    reportError.style.display = 'block';
                    return;
                }
                
                if (!title || title.length < 3) {
                    reportError.textContent = 'Title must be at least 3 characters';
                    reportError.style.display = 'block';
                    return;
                }
                
                if (!description || description.length < 10) {
                    reportError.textContent = 'Description must be at least 10 characters';
                    reportError.style.display = 'block';
                    return;
                }
                
                submitReportBtn.disabled = true;
                submitReportBtn.textContent = 'Submitting...';
                
                try {
                    const reportData = { 
                        type: currentReportType === 'quest-error' ? 'bug' : currentReportType, 
                        title, 
                        description
                    };
                    
                    // Include quest info if it's a quest error
                    if (currentReportType === 'quest-error' && selectedQuest) {
                        reportData.questName = selectedQuest.name;
                        reportData.questId = selectedQuest.id;
                    }
                    
                    const response = await fetch('/api/reports', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(reportData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        reportSuccess.textContent = 'Thank you! Your report has been submitted.';
                        reportSuccess.style.display = 'block';
                        setTimeout(() => {
                            closeReportDialog();
                        }, 2000);
                    } else {
                        reportError.textContent = data.error || 'Failed to submit report';
                        reportError.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error submitting report:', error);
                    reportError.textContent = 'An error occurred. Please try again.';
                    reportError.style.display = 'block';
                } finally {
                    submitReportBtn.disabled = false;
                    submitReportBtn.textContent = 'Submit';
                }
            });

            // ========================================================================
            // FIX QUESTS TAB (ADMIN ONLY)
            // ========================================================================
            
            let allQuestsForEdit = [];
            let selectedQuestForEdit = null;
            let selectedPrereqsForEdit = new Set();
            let selectedAutoCompleteForEdit = new Set();
            let isAdminUser = false;
            let tarkovItems = []; // All items from tarkov.dev
            let tarkovItemsLoaded = false;

            // Fetch all items from tarkov.dev API
            async function fetchTarkovItems() {
                if (tarkovItemsLoaded && tarkovItems.length > 0) {
                    return tarkovItems;
                }

                // Check localStorage cache first
                const CACHE_KEY = 'tarkov-items-cache';
                const CACHE_EXPIRY_KEY = 'tarkov-items-cache-expiry';
                const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

                try {
                    const cachedData = localStorage.getItem(CACHE_KEY);
                    const cacheExpiry = localStorage.getItem(CACHE_EXPIRY_KEY);

                    // Use cached data if valid
                    if (cachedData && cacheExpiry && Date.now() < parseInt(cacheExpiry)) {
                        tarkovItems = JSON.parse(cachedData);
                        tarkovItemsLoaded = true;
                        console.log(`[Admin] Loaded ${tarkovItems.length} items from cache`);
                        return tarkovItems;
                    }

                    // Fetch from API if no valid cache
                    console.log('[Admin] Fetching items from tarkov.dev API...');
                    const query = `
                        query {
                            items {
                                id
                                name
                                shortName
                                iconLink
                                gridImageLink
                            }
                        }
                    `;

                    const response = await fetch('https://api.tarkov.dev/graphql', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query })
                    });

                    const data = await response.json();
                    if (data.data && data.data.items) {
                        tarkovItems = data.data.items.sort((a, b) => a.name.localeCompare(b.name));
                        tarkovItemsLoaded = true;
                        
                        // Cache the data
                        localStorage.setItem(CACHE_KEY, JSON.stringify(tarkovItems));
                        localStorage.setItem(CACHE_EXPIRY_KEY, (Date.now() + CACHE_DURATION).toString());
                        
                        console.log(`[Admin] Loaded ${tarkovItems.length} items from tarkov.dev API and cached`);
                    }
                } catch (error) {
                    console.error('[Admin] Failed to fetch items from tarkov.dev:', error);
                }

                return tarkovItems;
            }

            function setupFixQuestsTab() {
                const fixQuestsTab = document.getElementById('fix-quests-tab');
                const fixQuestsSection = document.getElementById('fix-quests-section');
                const questsSection = document.getElementById('quests-section');
                const rankingsSection = document.getElementById('rankings-section');
                const profileSection = document.getElementById('profile-section');
                const dashboardTab = document.getElementById('dashboard-tab');
                const finishedQuestsTab = document.getElementById('finished-quests-tab');
                const rankingsTab = document.getElementById('rankings-tab');
                const profileTab = document.getElementById('profile-tab');

                if (!fixQuestsTab) return;

                // Tab click handler
                fixQuestsTab.addEventListener('click', (e) => {
                    e.preventDefault();

                    // Switch tabs
                    [dashboardTab, finishedQuestsTab, fixQuestsTab, rankingsTab, profileTab].forEach(tab => {
                        if (tab) tab.classList.remove('active');
                    });
                    fixQuestsTab.classList.add('active');

                    // Switch sections
                    [questsSection, rankingsSection, profileSection].forEach(section => {
                        if (section) section.style.display = 'none';
                    });
                    
                    // Hide map sections
                    const mapOverview = document.getElementById('map-overview');
                    const mapTabsSection = document.querySelector('.map-tabs-section');
                    if (mapOverview) mapOverview.style.display = 'none';
                    if (mapTabsSection) mapTabsSection.style.display = 'none';
                    
                    if (fixQuestsSection) {
                        fixQuestsSection.style.display = 'block';
                        loadQuestsForFixing();
                    }
                });

                // Dialog handlers
                setupQuestEditDialog();
            }

            async function loadQuestsForFixing() {
                try {
                    const response = await fetch('/api/quests', { credentials: 'include' });
                    allQuestsForEdit = await response.json();
                    displayQuestsForFixing(allQuestsForEdit);
                } catch (error) {
                    console.error('Error loading quests for fixing:', error);
                    const grid = document.getElementById('fix-quests-grid');
                    if (grid) {
                        grid.innerHTML = '<div style="text-align:center;color:#ff6b6b;padding:40px;">Failed to load quests</div>';
                    }
                }
            }

            function displayQuestsForFixing(quests) {
                const grid = document.getElementById('fix-quests-grid');
                if (!grid) return;

                if (quests.length === 0) {
                    grid.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No quests found</div>';
                    return;
                }

                // Custom card layout for fix quests
                grid.innerHTML = quests.map(quest => `
                    <div class="fix-quest-card" data-quest-name="${quest.name.toLowerCase()}" data-trader="${quest.trader.toLowerCase()}" style="display: flex;">
                        <div class="fix-quest-title">${quest.name}</div>
                        <span class="level-badge">Lvl ${quest.level}</span>
                        <span class="trader-badge">${quest.trader}</span>
                        ${quest.mapName && quest.mapName !== 'Any Location' ? `<span class="map-badge">${quest.mapName}</span>` : ''}
                        ${quest.requiredForKappa ? '<span class="kappa-badge" style="background: rgba(199, 170, 106, 0.3); color: #c7aa6a; border: 1px solid #c7aa6a;"><i class="fas fa-star"></i> Kappa</span>' : ''}
                        <button class="complete-btn fix-quest-btn" onclick="openQuestEditDialog('${quest.id}')">
                            <i class="fas fa-tools"></i> Fix Quest
                        </button>
                    </div>
                `).join('');
            }

            function setupQuestEditDialog() {
                // Prerequisite quest search - Using same pattern as Report Quest Error dialog
                const prereqSearch = document.getElementById('prereq-search-dialog');
                const prereqDropdown = document.getElementById('prereq-dropdown-dialog');
                
                if (prereqSearch) {
                    prereqSearch.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase().trim();
                        
                        if (searchTerm.length < 2) {
                            prereqDropdown.style.display = 'none';
                            return;
                        }
                        
                        // Filter quests by name, excluding current quest and already selected
                        const matches = allQuestsForEdit
                            .filter(q => 
                                q.name.toLowerCase().includes(searchTerm) && 
                                q.id !== selectedQuestForEdit.id &&
                                !selectedPrereqsForEdit.has(q.id)
                            )
                            .slice(0, 10); // Limit to 10 results
                        
                        if (matches.length === 0) {
                            prereqDropdown.style.display = 'none';
                            return;
                        }
                        
                        prereqDropdown.innerHTML = matches.map(quest => `
                            <div class="prereq-suggestion-item" data-quest-id="${quest.id}" data-quest-name="${quest.name}" data-trader="${quest.trader}" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #2a2a2a; color: #fff; transition: background 0.2s;">
                                <div style="font-weight: 600;">${quest.name}</div>
                                <div style="font-size: 0.85rem; color: #888;">${quest.trader}</div>
                            </div>
                        `).join('');
                        
                        prereqDropdown.style.display = 'block';
                        
                        // Add click handlers to suggestions
                        prereqDropdown.querySelectorAll('.prereq-suggestion-item').forEach(item => {
                            item.addEventListener('mouseover', () => {
                                item.style.background = 'rgba(199, 170, 106, 0.2)';
                            });
                            item.addEventListener('mouseout', () => {
                                item.style.background = 'transparent';
                            });
                            item.addEventListener('click', () => {
                                selectedPrereqsForEdit.add(item.dataset.questId);
                                updatePrereqsDisplayDialog();
                                prereqSearch.value = '';
                                prereqDropdown.style.display = 'none';
                            });
                        });
                    });
                }

                // Auto-complete quest search - Using same pattern as Report Quest Error dialog
                const autocompleteSearch = document.getElementById('autocomplete-search-dialog');
                const autocompleteDropdown = document.getElementById('autocomplete-dropdown-dialog');
                
                if (autocompleteSearch) {
                    autocompleteSearch.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase().trim();
                        
                        if (searchTerm.length < 2) {
                            autocompleteDropdown.style.display = 'none';
                            return;
                        }
                        
                        // Filter quests by name, excluding current quest and already selected
                        const matches = allQuestsForEdit
                            .filter(q => 
                                q.name.toLowerCase().includes(searchTerm) && 
                                q.id !== selectedQuestForEdit.id &&
                                !selectedAutoCompleteForEdit.has(q.id)
                            )
                            .slice(0, 10); // Limit to 10 results
                        
                        if (matches.length === 0) {
                            autocompleteDropdown.style.display = 'none';
                            return;
                        }
                        
                        autocompleteDropdown.innerHTML = matches.map(quest => `
                            <div class="autocomplete-suggestion-item" data-quest-id="${quest.id}" data-quest-name="${quest.name}" data-trader="${quest.trader}" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #2a2a2a; color: #fff; transition: background 0.2s;">
                                <div style="font-weight: 600;">${quest.name}</div>
                                <div style="font-size: 0.85rem; color: #888;">${quest.trader}</div>
                            </div>
                        `).join('');
                        
                        autocompleteDropdown.style.display = 'block';
                        
                        // Add click handlers to suggestions
                        autocompleteDropdown.querySelectorAll('.autocomplete-suggestion-item').forEach(item => {
                            item.addEventListener('mouseover', () => {
                                item.style.background = 'rgba(199, 170, 106, 0.2)';
                            });
                            item.addEventListener('mouseout', () => {
                                item.style.background = 'transparent';
                            });
                            item.addEventListener('click', () => {
                                selectedAutoCompleteForEdit.add(item.dataset.questId);
                                updateAutoCompleteDisplayDialog();
                                autocompleteSearch.value = '';
                                autocompleteDropdown.style.display = 'none';
                            });
                        });
                    });
                }
            }

            // Call setup to attach event listeners
            setupQuestEditDialog();

            window.openQuestFromAdminLog = async function(questName, changedFields) {
                // Switch to Fix Quests tab
                if (window.tracker) {
                    window.tracker.switchToFixQuests();
                }
                
                // Wait for Fix Quests to load
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Load quests if not already loaded
                if (allQuestsForEdit.length === 0) {
                    await loadQuestsForFixing();
                }
                
                // Find quest by name
                const quest = allQuestsForEdit.find(q => q.name === questName);
                if (!quest) {
                    console.error('Quest not found:', questName);
                    alert(`Quest "${questName}" not found`);
                    return;
                }
                
                // Open the dialog and highlight changed fields
                await window.openQuestEditDialog(quest.id, changedFields);
            };

            window.openQuestEditDialog = async function(questId, changedFields = []) {
                // Load quests if not already loaded
                if (allQuestsForEdit.length === 0) {
                    await loadQuestsForFixing();
                }
                
                selectedQuestForEdit = allQuestsForEdit.find(q => q.id === questId);
                if (!selectedQuestForEdit) {
                    console.error('Quest not found:', questId);
                    return;
                }

                const dialog = document.getElementById('quest-editor-dialog');
                
                // Clear any previous highlights
                setTimeout(() => {
                    dialog.querySelectorAll('[style*="border"]').forEach(el => {
                        if (el.style.border && el.style.border.includes('red')) {
                            el.style.border = '';
                        }
                    });
                }, 100);
                
                // Populate basic info
                document.getElementById('edit-name-dialog').value = selectedQuestForEdit.name;
                document.getElementById('edit-trader-dialog').value = selectedQuestForEdit.trader;
                document.getElementById('edit-level-dialog').value = selectedQuestForEdit.level;
                document.getElementById('edit-unlock-hours-dialog').value = selectedQuestForEdit.unlockAfterHours || 0;
                document.getElementById('edit-kappa-required-dialog').checked = selectedQuestForEdit.requiredForKappa || false;
                document.getElementById('edit-map-dialog').value = selectedQuestForEdit.mapName || 'Any Location';

                // Load prerequisite quests
                selectedPrereqsForEdit = new Set(JSON.parse(selectedQuestForEdit.prerequisiteQuests || '[]'));
                updatePrereqsDisplayDialog();

                // Load auto-complete quests
                selectedAutoCompleteForEdit = new Set(JSON.parse(selectedQuestForEdit.autoCompleteQuests || '[]'));
                updateAutoCompleteDisplayDialog();

                // Load required items
                const requiredItems = JSON.parse(selectedQuestForEdit.requiredItems || '[]');

                // Parse markers, jammers, cameras, keys, fir items
                let markers = 0, jammers = 0, cameras = 0;
                const keys = [];
                const firItems = [];

                requiredItems.forEach(item => {
                    if (item.category === 'markers') markers = Math.max(markers, item.count || 0);
                    else if (item.category === 'jammers') jammers = Math.max(jammers, item.count || 0);
                    else if (item.name && item.name.includes('WI-FI Camera')) cameras = Math.max(cameras, item.count || 0);
                    else if (item.category === 'keys') keys.push({ name: item.name, count: item.count || 1 });
                    else if (item.category === 'fir') firItems.push({ name: item.name, count: item.count || 1 });
                });

                document.getElementById('edit-markers-dialog').value = markers || '';
                document.getElementById('edit-jammers-dialog').value = jammers || '';
                document.getElementById('edit-cameras-dialog').value = cameras || '';

                // Display keys
                const keysEditor = document.getElementById('keys-editor-dialog');
                keysEditor.innerHTML = keys.map((key, idx) => `
                    <div style="display:flex;gap:10px;margin-bottom:10px;align-items:center;">
                        <input type="text" value="${key.name}" placeholder="Key name" data-key-idx="${idx}" style="flex:1;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <input type="number" value="${key.count}" min="1" placeholder="Count" data-key-count-idx="${idx}" style="width:80px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');

                // Display FIR items
                const firItemsEditor = document.getElementById('fir-items-editor-dialog');
                firItemsEditor.innerHTML = firItems.map((firItem, idx) => `
                    <div style="display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;position:relative;">
                        <div style="flex:1;position:relative;">
                            <input type="text" 
                                   value="${firItem.name}" 
                                   placeholder="Search items..." 
                                   data-fir-search-idx="${idx}" 
                                   autocomplete="off"
                                   style="width:100%;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                            <div class="fir-dropdown" data-fir-dropdown-idx="${idx}" style="position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:rgba(20,20,20,0.98);border:2px solid #c7aa6a;border-radius:6px;margin-top:2px;z-index:9999;display:none;"></div>
                            <input type="hidden" data-fir-item-idx="${idx}" value="${firItem.name}">
                        </div>
                        <input type="number" value="${firItem.count}" min="1" placeholder="Count" data-fir-count-idx="${idx}" style="width:80px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');

                // Setup search for existing FIR items
                firItems.forEach((firItem, idx) => {
                    const searchInput = document.querySelector(`[data-fir-search-idx="${idx}"]`);
                    const dropdown = document.querySelector(`[data-fir-dropdown-idx="${idx}"]`);
                    
                    if (searchInput && dropdown) {
                        searchInput.addEventListener('input', async function() {
                            await fetchTarkovItems(); // Ensure items are loaded
                            const searchTerm = this.value.toLowerCase().trim();
                            
                            if (searchTerm.length === 0) {
                                dropdown.style.display = 'none';
                                return;
                            }
                            
                            const filtered = tarkovItems.filter(item => 
                                item.name.toLowerCase().includes(searchTerm) || 
                                item.shortName.toLowerCase().includes(searchTerm)
                            ).slice(0, 50);
                            
                            if (filtered.length === 0) {
                                dropdown.innerHTML = '<div style="padding:8px;color:#888;">No items found</div>';
                                dropdown.style.display = 'block';
                                return;
                            }
                            
                            dropdown.innerHTML = filtered.map(item => `
                                <div onclick="selectFirItem('${idx}', '${item.name.replace(/'/g, "\\'")}', '${item.id}')" 
                                     style="padding:8px;cursor:pointer;color:#fff;border-bottom:1px solid #333;"
                                     onmouseover="this.style.background='rgba(199,170,106,0.2)'"
                                     onmouseout="this.style.background='transparent'">
                                    ${item.name} ${item.shortName ? `(${item.shortName})` : ''}
                                </div>
                            `).join('');
                            
                            dropdown.style.display = 'block';
                        });
                    }
                });

                // Load images
                const imagesTextarea = document.getElementById('edit-images-dialog');
                const imagesPreview = document.getElementById('current-images-preview');
                if (selectedQuestForEdit.images) {
                    try {
                        const images = JSON.parse(selectedQuestForEdit.images);
                        imagesTextarea.value = images.join('\n');
                        updateImagePreview();
                    } catch (e) {
                        imagesTextarea.value = '';
                    }
                } else {
                    imagesTextarea.value = '';
                    imagesPreview.innerHTML = '';
                }

                // Add image preview update on textarea change
                imagesTextarea.addEventListener('input', updateImagePreview);

                // Load notes
                const notesTextarea = document.getElementById('edit-notes-dialog');
                notesTextarea.value = selectedQuestForEdit.notes || '';

                // Load and display shopping list for Gunsmith quests
                const shoppingListSection = document.getElementById('shopping-list-section-dialog');
                const isGunsmithQuest = selectedQuestForEdit.name && selectedQuestForEdit.name.startsWith('Gunsmith');
                
                if (isGunsmithQuest) {
                    shoppingListSection.style.display = 'block';
                    
                    // Parse and display shopping list
                    const shoppingList = JSON.parse(selectedQuestForEdit.shoppingList || '[]');
                    const shoppingListEditor = document.getElementById('shopping-list-editor-dialog');
                    
                    shoppingListEditor.innerHTML = shoppingList.map((item, idx) => `
                        <div style="display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;">
                            <div style="flex:1;position:relative;">
                                <input type="text" 
                                       value="${item.name || ''}" 
                                       placeholder="Search item name..." 
                                       data-shopping-search-idx="${idx}" 
                                       autocomplete="off"
                                       style="width:100%;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                                <div class="shopping-dropdown" data-shopping-dropdown-idx="${idx}" style="position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:rgba(20,20,20,0.98);border:2px solid #c7aa6a;border-radius:6px;margin-top:2px;z-index:9999;display:none;"></div>
                                <input type="hidden" data-shopping-item-idx="${idx}" value="${item.name || ''}">
                            </div>
                            <select data-shopping-trader-idx="${idx}" style="width:140px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                                <option value="">Trader</option>
                                <option value="Base Weapon" ${item.trader === 'Base Weapon' ? 'selected' : ''}>Base Weapon</option>
                                <option value="Prapor" ${item.trader === 'Prapor' ? 'selected' : ''}>Prapor</option>
                                <option value="Therapist" ${item.trader === 'Therapist' ? 'selected' : ''}>Therapist</option>
                                <option value="Fence" ${item.trader === 'Fence' ? 'selected' : ''}>Fence</option>
                                <option value="Skier" ${item.trader === 'Skier' ? 'selected' : ''}>Skier</option>
                                <option value="Peacekeeper" ${item.trader === 'Peacekeeper' ? 'selected' : ''}>Peacekeeper</option>
                                <option value="Mechanic" ${item.trader === 'Mechanic' ? 'selected' : ''}>Mechanic</option>
                                <option value="Ragman" ${item.trader === 'Ragman' ? 'selected' : ''}>Ragman</option>
                                <option value="Jaeger" ${item.trader === 'Jaeger' ? 'selected' : ''}>Jaeger</option>
                                <option value="Ref" ${item.trader === 'Ref' ? 'selected' : ''}>Ref</option>
                                <option value="Loot Only" ${item.trader === 'Loot Only' ? 'selected' : ''}>Loot Only</option>
                            </select>
                            <input type="number" value="${item.loyaltyLevel || 1}" min="1" max="4" placeholder="LL" data-shopping-ll-idx="${idx}" style="width:60px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;" title="Loyalty Level">
                            <label style="display:flex;align-items:center;gap:4px;white-space:nowrap;color:#888;font-size:12px;">
                                <input type="checkbox" data-shopping-barter-idx="${idx}" ${item.isBarter ? 'checked' : ''} style="margin:0;">
                                Barter
                            </label>
                            <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                    
                    // Setup search for existing items
                    await fetchTarkovItems();
                    shoppingList.forEach((item, idx) => {
                        const searchInput = document.querySelector(`[data-shopping-search-idx="${idx}"]`);
                        const dropdown = document.querySelector(`[data-shopping-dropdown-idx="${idx}"]`);
                        const hiddenInput = document.querySelector(`[data-shopping-item-idx="${idx}"]`);
                        
                        if (searchInput && dropdown) {
                            searchInput.addEventListener('input', function() {
                                const searchTerm = this.value.toLowerCase().trim();
                                
                                if (searchTerm.length === 0) {
                                    dropdown.style.display = 'none';
                                    return;
                                }
                                
                                const filtered = tarkovItems.filter(item => 
                                    item.name.toLowerCase().includes(searchTerm) || 
                                    (item.shortName && item.shortName.toLowerCase().includes(searchTerm))
                                ).slice(0, 50);
                                
                                if (filtered.length === 0) {
                                    dropdown.innerHTML = '<div style="padding:8px;color:#888;">No items found</div>';
                                    dropdown.style.display = 'block';
                                    return;
                                }
                                
                                dropdown.innerHTML = filtered.map(item => `
                                    <div onclick="selectShoppingItem(${idx}, '${item.name.replace(/'/g, "\\'")}', '${item.id}')" 
                                         style="padding:8px;cursor:pointer;color:#fff;border-bottom:1px solid #333;"
                                         onmouseover="this.style.background='rgba(199,170,106,0.2)'"
                                         onmouseout="this.style.background='transparent'">
                                        ${item.name} ${item.shortName ? `(${item.shortName})` : ''}
                                    </div>
                                `).join('');
                                
                                dropdown.style.display = 'block';
                            });
                        }
                    });
                } else {
                    shoppingListSection.style.display = 'none';
                }

                // Setup save button event listener
                const saveBtn = document.getElementById('save-quest-edit');
                if (saveBtn) {
                    console.log('Attaching save button event listener');
                    // Clone and replace to remove all old event listeners
                    const newSaveBtn = saveBtn.cloneNode(true);
                    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                    newSaveBtn.addEventListener('click', saveQuestEdit);
                }

                // Add event listeners for closing the dialog
                // Click outside to close
                const handleOverlayClick = (e) => {
                    if (e.target.id === 'quest-editor-dialog') {
                        dialog.style.display = 'none';
                        dialog.removeEventListener('click', handleOverlayClick);
                        document.removeEventListener('keydown', handleEscapeKey);
                    }
                };

                // Escape key to close
                const handleEscapeKey = (e) => {
                    if (e.key === 'Escape' || e.key === 'Esc') {
                        if (dialog.style.display === 'flex') {
                            dialog.style.display = 'none';
                            dialog.removeEventListener('click', handleOverlayClick);
                            document.removeEventListener('keydown', handleEscapeKey);
                        }
                    }
                };

                dialog.addEventListener('click', handleOverlayClick);
                document.addEventListener('keydown', handleEscapeKey);

                dialog.style.display = 'flex';
                
                // Highlight changed fields if provided
                if (changedFields && changedFields.length > 0) {
                    setTimeout(() => {
                        const fieldMapping = {
                            'trader': ['edit-trader-dialog'],
                            'level': ['edit-level-dialog'],
                            'mapName': ['edit-map-dialog'],
                            'requiredForKappa': ['edit-kappa-required-dialog'],
                            'notes': ['edit-notes-dialog'],
                            'images': ['edit-images-dialog'],
                            'shoppingList': ['shopping-list-section-dialog'],
                            'prerequisiteQuests': ['selected-prereqs-dialog'],
                            'requiredItems': ['edit-markers-dialog', 'edit-jammers-dialog', 'edit-cameras-dialog', 'keys-editor-dialog', 'fir-items-editor-dialog']
                        };
                        
                        const uniqueFields = [...new Set(changedFields)]; // Remove duplicates
                        let firstElement = null;
                        
                        uniqueFields.forEach(field => {
                            const elementIds = fieldMapping[field];
                            if (elementIds) {
                                elementIds.forEach(elementId => {
                                    const element = document.getElementById(elementId);
                                    if (element) {
                                        element.style.border = '3px solid #f44336';
                                        element.style.boxShadow = '0 0 10px rgba(244, 67, 54, 0.5)';
                                        
                                        // Track first element for scrolling
                                        if (!firstElement) {
                                            firstElement = element;
                                        }
                                    }
                                });
                            }
                        });
                        
                        // Scroll to first highlighted field
                        if (firstElement) {
                            firstElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 300);
                }
            };

            function updateImagePreview() {
                const textarea = document.getElementById('edit-images-dialog');
                const preview = document.getElementById('current-images-preview');
                const urls = textarea.value.split('\n').filter(url => url.trim() !== '');
                
                if (urls.length === 0) {
                    preview.innerHTML = '';
                    return;
                }
                
                preview.innerHTML = urls.map((url, idx) => `
                    <div style="position: relative; border: 2px solid #3a3a3a; border-radius: 6px; overflow: hidden; aspect-ratio: 1;">
                        <img src="${url.trim()}" alt="Preview ${idx + 1}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'100\\'%3E%3Crect fill=\\'%23333\\' width=\\'100\\' height=\\'100\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' fill=\\'%23888\\' font-size=\\'12\\'%3ENo Image%3C/text%3E%3C/svg%3E'">
                    </div>
                `).join('');
            }

            window.addKeyEntryDialog = function() {
                const keysEditor = document.getElementById('keys-editor-dialog');
                const idx = keysEditor.children.length;
                const entry = document.createElement('div');
                entry.style = 'display:flex;gap:10px;margin-bottom:10px;align-items:center;';
                entry.innerHTML = `
                    <input type="text" placeholder="Key name" data-key-idx="${idx}" style="flex:1;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                    <input type="number" value="1" min="1" placeholder="Count" data-key-count-idx="${idx}" style="width:80px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                    <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                keysEditor.appendChild(entry);
            };

            window.addFirItemEntryDialog = async function() {
                // Load items if not already loaded
                await fetchTarkovItems();
                
                const firItemsEditor = document.getElementById('fir-items-editor-dialog');
                const idx = firItemsEditor.children.length;
                const entry = document.createElement('div');
                entry.className = 'fir-item-entry';
                entry.style = 'display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;position:relative;';
                
                entry.innerHTML = `
                    <div style="flex:1;position:relative;">
                        <input type="text" 
                               placeholder="Search items..." 
                               data-fir-search-idx="${idx}" 
                               autocomplete="off"
                               style="width:100%;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <div class="fir-dropdown" data-fir-dropdown-idx="${idx}" style="position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:rgba(20,20,20,0.98);border:2px solid #c7aa6a;border-radius:6px;margin-top:2px;z-index:9999;display:none;"></div>
                        <input type="hidden" data-fir-item-idx="${idx}">
                    </div>
                    <input type="number" value="1" min="1" placeholder="Count" data-fir-count-idx="${idx}" style="width:80px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                    <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                firItemsEditor.appendChild(entry);
                
                // Setup search functionality
                const searchInput = entry.querySelector(`[data-fir-search-idx="${idx}"]`);
                const dropdown = entry.querySelector(`[data-fir-dropdown-idx="${idx}"]`);
                const hiddenInput = entry.querySelector(`[data-fir-item-idx="${idx}"]`);
                
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    if (searchTerm.length === 0) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    const filtered = tarkovItems.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) || 
                        item.shortName.toLowerCase().includes(searchTerm)
                    ).slice(0, 50); // Limit to 50 results for performance
                    
                    if (filtered.length === 0) {
                        dropdown.innerHTML = '<div style="padding:8px;color:#888;">No items found</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = filtered.map(item => `
                        <div onclick="selectFirItem('${idx}', '${item.name.replace(/'/g, "\\'")}', '${item.id}')" 
                             style="padding:8px;cursor:pointer;color:#fff;border-bottom:1px solid #333;"
                             onmouseover="this.style.background='rgba(199,170,106,0.2)'"
                             onmouseout="this.style.background='transparent'">
                            ${item.name} ${item.shortName ? `(${item.shortName})` : ''}
                        </div>
                    `).join('');
                    
                    dropdown.style.display = 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function closeDropdown(e) {
                    if (!entry.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            };

            window.selectFirItem = function(idx, itemName, itemId) {
                const searchInput = document.querySelector(`[data-fir-search-idx="${idx}"]`);
                const hiddenInput = document.querySelector(`[data-fir-item-idx="${idx}"]`);
                const dropdown = document.querySelector(`[data-fir-dropdown-idx="${idx}"]`);
                
                if (searchInput) searchInput.value = itemName;
                if (hiddenInput) hiddenInput.value = itemName; // Store the item name
                if (dropdown) dropdown.style.display = 'none';
            };

            window.addShoppingListItemDialog = async function() {
                // Load items if not already loaded
                await fetchTarkovItems();
                
                const shoppingListEditor = document.getElementById('shopping-list-editor-dialog');
                const idx = shoppingListEditor.children.length;
                const entry = document.createElement('div');
                entry.style = 'display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;';
                
                entry.innerHTML = `
                    <div style="flex:1;position:relative;">
                        <input type="text" 
                               placeholder="Search item name..." 
                               data-shopping-search-idx="${idx}" 
                               autocomplete="off"
                               style="width:100%;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <div class="shopping-dropdown" data-shopping-dropdown-idx="${idx}" style="position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:rgba(20,20,20,0.98);border:2px solid #c7aa6a;border-radius:6px;margin-top:2px;z-index:9999;display:none;"></div>
                        <input type="hidden" data-shopping-item-idx="${idx}">
                    </div>
                    <select data-shopping-trader-idx="${idx}" style="width:140px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;">
                        <option value="">Trader</option>
                        <option value="Base Weapon">Base Weapon</option>
                        <option value="Prapor">Prapor</option>
                        <option value="Therapist">Therapist</option>
                        <option value="Fence">Fence</option>
                        <option value="Skier">Skier</option>
                        <option value="Peacekeeper">Peacekeeper</option>
                        <option value="Mechanic">Mechanic</option>
                        <option value="Ragman">Ragman</option>
                        <option value="Jaeger">Jaeger</option>
                        <option value="Ref">Ref</option>
                        <option value="Loot Only">Loot Only</option>
                    </select>
                    <input type="number" value="1" min="1" max="4" placeholder="LL" data-shopping-ll-idx="${idx}" style="width:60px;padding:8px;background:rgba(0,0,0,0.5);border:2px solid #3a3a3a;border-radius:6px;color:#fff;" title="Loyalty Level">
                    <label style="display:flex;align-items:center;gap:4px;white-space:nowrap;color:#888;font-size:12px;">
                        <input type="checkbox" data-shopping-barter-idx="${idx}" style="margin:0;">
                        Barter
                    </label>
                    <button onclick="this.parentElement.remove()" style="padding:8px 12px;background:#c83232;border:none;border-radius:4px;color:#fff;cursor:pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                shoppingListEditor.appendChild(entry);
                
                // Setup search functionality
                const searchInput = entry.querySelector(`[data-shopping-search-idx="${idx}"]`);
                const dropdown = entry.querySelector(`[data-shopping-dropdown-idx="${idx}"]`);
                const hiddenInput = entry.querySelector(`[data-shopping-item-idx="${idx}"]`);
                
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    if (searchTerm.length === 0) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    const filtered = tarkovItems.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) || 
                        (item.shortName && item.shortName.toLowerCase().includes(searchTerm))
                    ).slice(0, 50);
                    
                    if (filtered.length === 0) {
                        dropdown.innerHTML = '<div style="padding:8px;color:#888;">No items found</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = filtered.map(item => `
                        <div onclick="selectShoppingItem(${idx}, '${item.name.replace(/'/g, "\\'")}', '${item.id}')" 
                             style="padding:8px;cursor:pointer;color:#fff;border-bottom:1px solid #333;"
                             onmouseover="this.style.background='rgba(199,170,106,0.2)'"
                             onmouseout="this.style.background='transparent'">
                            ${item.name} ${item.shortName ? `(${item.shortName})` : ''}
                        </div>
                    `).join('');
                    
                    dropdown.style.display = 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!entry.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            };

            window.selectShoppingItem = function(idx, itemName, itemId) {
                const searchInput = document.querySelector(`[data-shopping-search-idx="${idx}"]`);
                const hiddenInput = document.querySelector(`[data-shopping-item-idx="${idx}"]`);
                const dropdown = document.querySelector(`[data-shopping-dropdown-idx="${idx}"]`);
                
                if (searchInput) searchInput.value = itemName;
                if (hiddenInput) hiddenInput.value = itemName;
                if (dropdown) dropdown.style.display = 'none';
            };

            window.addPrereqDialog = function(id, name, trader) {
                selectedPrereqsForEdit.add(id);
                updatePrereqsDisplayDialog();
                document.getElementById('prereq-search-dialog').value = '';
                document.getElementById('prereq-dropdown-dialog').style.display = 'none';
            };

            window.removePrereqDialog = function(id) {
                selectedPrereqsForEdit.delete(id);
                updatePrereqsDisplayDialog();
            };

            function updatePrereqsDisplayDialog() {
                const container = document.getElementById('selected-prereqs-dialog');
                if (selectedPrereqsForEdit.size === 0) {
                    container.innerHTML = '<p style="color:#888;">No prerequisite quests</p>';
                    return;
                }

                container.innerHTML = Array.from(selectedPrereqsForEdit).map(id => {
                    const quest = allQuestsForEdit.find(q => q.id === id);
                    return quest ? `
                        <div style="padding:8px 12px;background:rgba(199,170,106,0.2);border:1px solid #c7aa6a;border-radius:4px;color:#fff;display:flex;align-items:center;gap:8px;">
                            ${quest.name}
                            <i class="fas fa-times" onclick="removePrereqDialog('${id}')" style="cursor:pointer;color:#c83232;"></i>
                        </div>
                    ` : '';
                }).join('');
            }

            window.addAutoCompleteDialog = function(id, name, trader) {
                selectedAutoCompleteForEdit.add(id);
                updateAutoCompleteDisplayDialog();
                document.getElementById('autocomplete-search-dialog').value = '';
                document.getElementById('autocomplete-dropdown-dialog').style.display = 'none';
            };

            window.removeAutoCompleteDialog = function(id) {
                selectedAutoCompleteForEdit.delete(id);
                updateAutoCompleteDisplayDialog();
            };

            function updateAutoCompleteDisplayDialog() {
                const container = document.getElementById('selected-autocomplete-dialog');
                if (selectedAutoCompleteForEdit.size === 0) {
                    container.innerHTML = '<p style="color:#888;">No auto-complete quests</p>';
                    return;
                }

                container.innerHTML = Array.from(selectedAutoCompleteForEdit).map(id => {
                    const quest = allQuestsForEdit.find(q => q.id === id);
                    return quest ? `
                        <div style="padding:8px 12px;background:rgba(199,170,106,0.2);border:1px solid #c7aa6a;border-radius:4px;color:#fff;display:flex;align-items:center;gap:8px;">
                            ${quest.name}
                            <i class="fas fa-times" onclick="removeAutoCompleteDialog('${id}')" style="cursor:pointer;color:#c83232;"></i>
                        </div>
                    ` : '';
                }).join('');
            }

            async function saveQuestEdit() {
                console.log('saveQuestEdit called, selectedQuestForEdit:', selectedQuestForEdit);
                if (!selectedQuestForEdit) {
                    console.log('No quest selected for edit, returning');
                    return;
                }

                const saveBtn = document.getElementById('save-quest-edit');
                const alert = document.getElementById('quest-edit-alert');
                
                console.log('Save button:', saveBtn);
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    // Build required items
                    const requiredItems = [];

                    // Add markers
                    const markers = parseInt(document.getElementById('edit-markers-dialog').value) || 0;
                    if (markers > 0) {
                        requiredItems.push({
                            name: 'MS2000 Marker',
                            count: markers,
                            category: 'markers',
                            type: 'mark'
                        });
                    }

                    // Add jammers
                    const jammers = parseInt(document.getElementById('edit-jammers-dialog').value) || 0;
                    if (jammers > 0) {
                        requiredItems.push({
                            name: 'Signal Jammer',
                            count: jammers,
                            category: 'jammers',
                            type: 'plantItem'
                        });
                    }

                    // Add cameras
                    const cameras = parseInt(document.getElementById('edit-cameras-dialog').value) || 0;
                    if (cameras > 0) {
                        requiredItems.push({
                            name: 'WI-FI Camera',
                            count: cameras,
                            category: 'any',
                            type: 'plantItem'
                        });
                    }

                    // Add keys
                    const keyEntries = document.querySelectorAll('#keys-editor-dialog > div');
                    keyEntries.forEach(entry => {
                        const nameInput = entry.querySelector('input[data-key-idx]');
                        const countInput = entry.querySelector('input[data-key-count-idx]');
                        if (nameInput && nameInput.value.trim()) {
                            requiredItems.push({
                                name: nameInput.value.trim(),
                                count: parseInt(countInput.value) || 1,
                                category: 'keys',
                                type: 'key'
                            });
                        }
                    });

                    // Add FIR items
                    const firItemEntries = document.querySelectorAll('#fir-items-editor-dialog > div');
                    firItemEntries.forEach(entry => {
                        const hiddenInput = entry.querySelector('input[type="hidden"]');
                        const countInput = entry.querySelector('input[data-fir-count-idx]');
                        if (hiddenInput && hiddenInput.value.trim()) {
                            requiredItems.push({
                                name: hiddenInput.value.trim(),
                                count: parseInt(countInput.value) || 1,
                                category: 'fir',
                                type: 'giveItem'
                            });
                        }
                    });

                    const finalRequiredItems = requiredItems;

                    // Get images
                    const imagesText = document.getElementById('edit-images-dialog').value;
                    const imageUrls = imagesText.split('\n').filter(url => url.trim() !== '').map(url => url.trim());

                    // Get notes
                    const notes = document.getElementById('edit-notes-dialog').value.trim();

                    // Get shopping list (for Gunsmith quests)
                    const shoppingListItems = [];
                    const shoppingListEntries = document.querySelectorAll('#shopping-list-editor-dialog > div');
                    shoppingListEntries.forEach((entry, idx) => {
                        const nameInput = entry.querySelector(`[data-shopping-item-idx="${idx}"]`) || entry.querySelector(`[data-shopping-search-idx="${idx}"]`);
                        const traderSelect = entry.querySelector(`[data-shopping-trader-idx="${idx}"]`);
                        const loyaltyInput = entry.querySelector(`[data-shopping-ll-idx="${idx}"]`);
                        const barterCheckbox = entry.querySelector(`[data-shopping-barter-idx="${idx}"]`);
                        
                        if (nameInput && nameInput.value && nameInput.value.trim()) {
                            shoppingListItems.push({
                                name: nameInput.value.trim(),
                                trader: traderSelect ? traderSelect.value : '',
                                loyaltyLevel: loyaltyInput ? parseInt(loyaltyInput.value) || 1 : 1,
                                isBarter: barterCheckbox ? barterCheckbox.checked : false
                            });
                        }
                    });

                    const updateData = {
                        trader: document.getElementById('edit-trader-dialog').value,
                        level: parseInt(document.getElementById('edit-level-dialog').value) || 1,
                        unlockAfterHours: parseInt(document.getElementById('edit-unlock-hours-dialog').value) || 0,
                        requiredForKappa: document.getElementById('edit-kappa-required-dialog').checked,
                        mapName: document.getElementById('edit-map-dialog').value,
                        prerequisiteQuests: JSON.stringify(Array.from(selectedPrereqsForEdit)),
                        autoCompleteQuests: JSON.stringify(Array.from(selectedAutoCompleteForEdit)),
                        requiredItems: JSON.stringify(finalRequiredItems),
                        images: JSON.stringify(imageUrls),
                        notes: notes || null,
                        shoppingList: JSON.stringify(shoppingListItems)
                    };

                    console.log('Sending update data:', updateData);
                    const response = await fetch(`/api/admin/quests/${selectedQuestForEdit.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(updateData)
                    });

                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error response:', errorData);
                        throw new Error(errorData.error || 'Failed to update quest');
                    }

                    // Show success
                    alert.style.display = 'block';
                    alert.style.background = 'rgba(76, 175, 80, 0.2)';
                    alert.style.border = '2px solid #4CAF50';
                    alert.style.color = '#4CAF50';
                    alert.textContent = '‚úÖ Quest updated successfully!';

                    // Reload quests in Fix Quests tab
                    await loadQuestsForFixing();
                    
                    // Reload quests in main tracker so changes appear immediately
                    if (window.tracker) {
                        await window.tracker.loadQuests();
                        window.tracker.updateUI();
                    }

                    // Close dialog after a moment
                    setTimeout(() => {
                        document.getElementById('quest-editor-dialog').style.display = 'none';
                        alert.style.display = 'none';
                    }, 1500);

                } catch (error) {
                    console.error('Error saving quest:', error);
                    alert.style.display = 'block';
                    alert.style.background = 'rgba(200, 50, 50, 0.2)';
                    alert.style.border = '2px solid #c83232';
                    alert.style.color = '#ff6b6b';
                    alert.textContent = '‚ùå Failed to save quest: ' + error.message;
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            }
        });

        // ========================================================================
        // COLLECTOR ITEMS TRACKER
        // ========================================================================

        let collectorItems = [];
        let collectorFoundItems = new Set();
        let tarkovItemsGlobal = []; // Global items cache
        let tarkovItemsLoadedGlobal = false;

        // Global function to fetch items from tarkov.dev (available to all users)
        async function fetchTarkovItemsGlobal() {
            if (tarkovItemsLoadedGlobal && tarkovItemsGlobal.length > 0) {
                return tarkovItemsGlobal;
            }

            // Check localStorage cache first
            const CACHE_KEY = 'tarkov-items-cache';
            const CACHE_EXPIRY_KEY = 'tarkov-items-cache-expiry';
            const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                const cacheExpiry = localStorage.getItem(CACHE_EXPIRY_KEY);

                // Use cached data if valid
                if (cachedData && cacheExpiry && Date.now() < parseInt(cacheExpiry)) {
                    tarkovItemsGlobal = JSON.parse(cachedData);
                    tarkovItemsLoadedGlobal = true;
                    console.log(`Loaded ${tarkovItemsGlobal.length} items from cache`);
                    return tarkovItemsGlobal;
                }

                // Fetch from API if no valid cache
                console.log('Fetching items from tarkov.dev API...');
                const query = `
                    query {
                        items {
                            id
                            name
                            shortName
                            iconLink
                            gridImageLink
                        }
                    }
                `;

                const response = await fetch('https://api.tarkov.dev/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                if (data.data && data.data.items) {
                    tarkovItemsGlobal = data.data.items.sort((a, b) => a.name.localeCompare(b.name));
                    tarkovItemsLoadedGlobal = true;
                    
                    // Cache the data
                    localStorage.setItem(CACHE_KEY, JSON.stringify(tarkovItemsGlobal));
                    localStorage.setItem(CACHE_EXPIRY_KEY, (Date.now() + CACHE_DURATION).toString());
                    
                    console.log(`Loaded ${tarkovItemsGlobal.length} items from tarkov.dev API and cached`);
                }
            } catch (error) {
                console.error('Failed to fetch items from tarkov.dev:', error);
            }

            return tarkovItemsGlobal;
        }

        // Setup Collector Items tab
        const collectorTab = document.getElementById('collector-items-tab');
        if (collectorTab) {
            collectorTab.addEventListener('click', (e) => {
                e.preventDefault();
                showCollectorSection();
            });
        }

        function showCollectorSection() {
            // Use the tracker's showView method if available
            if (window.tracker) {
                window.tracker.currentView = 'collector-items';
                window.tracker.showView('collector-items');
                window.tracker.updateNavigationState();
                loadCollectorItems();
            } else {
                // Fallback if tracker not loaded
                const collectorItems = document.getElementById('collector-items');
                if (collectorItems) {
                    collectorItems.style.display = 'block';
                    loadCollectorItems();
                }
            }
        }

        async function loadCollectorItems() {
            try {
                // Fetch quests to find Collector quest
                const response = await fetch('/api/quests');
                const quests = await response.json();
                
                // Find Collector quest - must be exact match
                const collectorQuest = quests.find(q => 
                    q.name.toLowerCase() === 'collector' && q.trader === 'Fence'
                );

                if (!collectorQuest) {
                    console.warn('Collector quest not found. Looking for quest with name "Collector" and trader "Fence"');
                    console.log('Available Fence quests:', quests.filter(q => q.trader === 'Fence').map(q => q.name));
                    displayCollectorItems([]);
                    return;
                }

                console.log('Found Collector quest:', collectorQuest.name);

                // Parse required items - Collector quest has ALL items as FIR items of type "giveItem"
                const requiredItems = JSON.parse(collectorQuest.requiredItems || '[]');
                console.log('Total required items in Collector quest:', requiredItems.length);
                
                // For Collector quest, ALL items with type "giveItem" are FIR items
                // Filter for giveItem type (these are the FIR items to collect)
                const firItems = requiredItems.filter(item => 
                    item.type === 'giveItem' || item.category === 'fir'
                );
                
                console.log('FIR items to collect:', firItems.length);
                
                // Fetch item images from tarkov.dev
                const items = await fetchTarkovItemsGlobal();
                
                // Enrich items with tarkov.dev data
                collectorItems = firItems.map(item => {
                    const itemName = item.name.replace(/_/g, ' '); // Remove underscores
                    const tarkovItem = items.find(ti => 
                        ti.name.toLowerCase() === itemName.toLowerCase() ||
                        ti.shortName.toLowerCase() === itemName.toLowerCase()
                    );
                    
                    return {
                        ...item,
                        name: itemName, // Use cleaned name
                        image: tarkovItem?.iconLink || tarkovItem?.gridImageLink || null,
                        id: tarkovItem?.id || item.name
                    };
                });

                // Load user progress from server
                try {
                    const progressResponse = await fetch('/api/collector-items');
                    if (progressResponse.ok) {
                        const progressData = await progressResponse.json();
                        collectorFoundItems = new Set(progressData.foundItems || []);
                    } else {
                        // Fallback to localStorage if server fails
                        const savedProgress = localStorage.getItem(`collector-progress-${window.currentUserId}`);
                        if (savedProgress) {
                            collectorFoundItems = new Set(JSON.parse(savedProgress));
                        } else {
                            collectorFoundItems = new Set();
                        }
                    }
                } catch (error) {
                    console.error('Error loading progress from server:', error);
                    // Fallback to localStorage
                    const savedProgress = localStorage.getItem(`collector-progress-${window.currentUserId}`);
                    if (savedProgress) {
                        collectorFoundItems = new Set(JSON.parse(savedProgress));
                    } else {
                        collectorFoundItems = new Set();
                    }
                }

                displayCollectorItems(collectorItems);
            } catch (error) {
                console.error('Error loading collector items:', error);
                displayCollectorItems([]);
            }
        }

        function displayCollectorItems(items) {
            const neededGrid = document.getElementById('collector-needed-grid');
            const foundGrid = document.getElementById('collector-found-grid');
            const neededCount = document.getElementById('needed-count');
            const foundCount = document.getElementById('found-count');
            const titleCount = document.getElementById('collector-title-count');

            if (!neededGrid || !foundGrid) return;

            // Split items into needed and found
            const neededItems = items.filter(item => !collectorFoundItems.has(item.id));
            const foundItems = items.filter(item => collectorFoundItems.has(item.id));

            // Update counts
            if (neededCount) neededCount.textContent = `${neededItems.length}`;
            if (foundCount) foundCount.textContent = `${foundItems.length}`;
            
            // Update title count
            if (titleCount) {
                titleCount.textContent = `(${foundItems.length}/${items.length})`;
            }

            // Render needed items
            if (neededItems.length === 0) {
                neededGrid.innerHTML = '<p style="color: var(--subtext); text-align: center; padding: 40px;">üéâ All items found!</p>';
            } else {
                neededGrid.innerHTML = neededItems.map(item => renderCollectorItem(item, false)).join('');
            }

            // Render found items
            if (foundItems.length === 0) {
                foundGrid.innerHTML = '';
            } else {
                foundGrid.innerHTML = foundItems.map(item => renderCollectorItem(item, true)).join('');
            }

            // Add click handlers
            document.querySelectorAll('.collector-item').forEach(el => {
                el.addEventListener('click', () => {
                    const itemId = el.dataset.itemId;
                    toggleCollectorItem(itemId);
                });
            });
        }

        function renderCollectorItem(item, isFound) {
            const imageUrl = item.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect fill="%23333" width="100" height="100"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" fill="%23888" font-size="12"%3ENo Image%3C/text%3E%3C/svg%3E';
            
            return `
                <div class="collector-item ${isFound ? 'found' : 'needed'}" data-item-id="${item.id}" title="Click to ${isFound ? 'unmark' : 'mark'} as found">
                    ${isFound ? '<div class="collector-item-check"><i class="fas fa-check"></i></div>' : ''}
                    ${item.count > 1 ? `<div class="collector-item-count">x${item.count}</div>` : ''}
                    <img src="${imageUrl}" 
                         alt="${item.name}" 
                         class="collector-item-image"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'100\\'%3E%3Crect fill=\\'%23333\\' width=\\'100\\' height=\\'100\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' fill=\\'%23888\\' font-size=\\'12\\'%3ENo Image%3C/text%3E%3C/svg%3E'">
                    <div class="collector-item-name">${item.name}</div>
                </div>
            `;
        }

        async function toggleCollectorItem(itemId) {
            if (collectorFoundItems.has(itemId)) {
                collectorFoundItems.delete(itemId);
            } else {
                collectorFoundItems.add(itemId);
            }

            const foundItemsArray = Array.from(collectorFoundItems);

            // Save progress to localStorage (as backup)
            localStorage.setItem(
                `collector-progress-${window.currentUserId}`, 
                JSON.stringify(foundItemsArray)
            );

            // Save progress to server
            try {
                await fetch('/api/collector-items/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ foundItems: foundItemsArray })
                });
            } catch (error) {
                console.error('Error saving to server:', error);
            }

            // Re-render
            displayCollectorItems(collectorItems);
        }

        // Store current user ID when available
        window.currentUserId = null;

    </script>

    <!-- Global Chat UI -->
    <div id="global-chat-button" class="global-chat-btn">
        <i class="fas fa-comments"></i>
        <span id="chat-unread-badge" class="chat-unread-badge" style="display: none;"></span>
    </div>

    <div id="global-chat-box" class="global-chat-box" style="display: none;">
        <div class="global-chat-header">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-comments"></i>
                <span>Global Chat</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button id="purge-chat-btn" class="purge-chat-btn" style="display: none;" title="Purge Chat (Admin Only)">
                    <i class="fas fa-broom"></i>
                </button>
                <button id="close-chat-btn" class="close-chat-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="global-chat-messages" id="global-chat-messages">
            <!-- Messages will be loaded here -->
        </div>
        <div class="global-chat-input-area">
            <textarea id="global-chat-input" placeholder="Type your message..." rows="1" maxlength="500"></textarea>
            <button id="global-chat-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        // Global Chat Functionality
        let globalChatOpen = false;
        let globalChatMessages = [];
        let lastGlobalChatId = null;
        let globalChatPollInterval = null;

        // Initialize global chat
        function initGlobalChat() {
            const chatButton = document.getElementById('global-chat-button');
            const chatBox = document.getElementById('global-chat-box');
            const closeChatBtn = document.getElementById('close-chat-btn');
            const chatInput = document.getElementById('global-chat-input');
            const sendBtn = document.getElementById('global-chat-send-btn');
            const purgeChatBtn = document.getElementById('purge-chat-btn');

            // Show purge button for admins
            if (window.currentUser && window.currentUser.isAdmin) {
                purgeChatBtn.style.display = 'block';
            }

            // Toggle chat box
            chatButton.addEventListener('click', () => {
                globalChatOpen = !globalChatOpen;
                chatBox.style.display = globalChatOpen ? 'flex' : 'none';
                if (globalChatOpen) {
                    loadGlobalChat();
                    startGlobalChatPolling();
                    // Clear unread badge
                    document.getElementById('chat-unread-badge').style.display = 'none';
                } else {
                    stopGlobalChatPolling();
                }
            });

            // Close chat
            closeChatBtn.addEventListener('click', () => {
                globalChatOpen = false;
                chatBox.style.display = 'none';
                stopGlobalChatPolling();
            });

            // Send message
            sendBtn.addEventListener('click', () => sendGlobalMessage());
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendGlobalMessage();
                }
            });

            // Purge chat (admin only)
            purgeChatBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to purge all chat messages?')) return;
                
                try {
                    const response = await fetch('/api/global-chat/purge', {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (response.ok) {
                        globalChatMessages = [];
                        displayGlobalChatMessages();
                    }
                } catch (error) {
                    console.error('Error purging chat:', error);
                }
            });

            // Auto-expand textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }

        async function loadGlobalChat() {
            try {
                const response = await fetch('/api/global-chat', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    globalChatMessages = data.messages || [];
                    if (globalChatMessages.length > 0) {
                        lastGlobalChatId = globalChatMessages[globalChatMessages.length - 1].id;
                    }
                    displayGlobalChatMessages();
                }
            } catch (error) {
                console.error('Error loading global chat:', error);
            }
        }

        function displayGlobalChatMessages() {
            const container = document.getElementById('global-chat-messages');
            if (globalChatMessages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No messages yet. Be the first to say hello!</div>';
                return;
            }

            container.innerHTML = globalChatMessages.map(msg => {
                const displayName = msg.displayName || msg.username;
                const timeStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const profileColor = msg.profileColor || '#c7aa6a';
                
                return `
                    <div class="global-chat-message">
                        <div class="global-chat-avatar" style="background: ${profileColor};">
                            ${msg.avatarUrl ? 
                                `<img src="${msg.avatarUrl}" alt="${displayName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'">` : 
                                displayName.charAt(0).toUpperCase()
                            }
                        </div>
                        <div class="global-chat-bubble">
                            <div class="global-chat-header-info">
                                <span class="global-chat-name" style="color: ${profileColor};">${displayName}</span>
                                <span class="global-chat-time">${timeStr}</span>
                            </div>
                            <div class="global-chat-text">${escapeHtml(msg.message)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        async function sendGlobalMessage() {
            const input = document.getElementById('global-chat-input');
            const message = input.value.trim();
            
            if (!message) return;

            try {
                const response = await fetch('/api/global-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ message })
                });

                if (response.ok) {
                    input.value = '';
                    input.style.height = 'auto';
                    await loadGlobalChat();
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function startGlobalChatPolling() {
            if (globalChatPollInterval) return;
            globalChatPollInterval = setInterval(async () => {
                try {
                    const url = lastGlobalChatId ? 
                        `/api/global-chat?after=${lastGlobalChatId}` : 
                        '/api/global-chat';
                    const response = await fetch(url, { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.messages && data.messages.length > 0) {
                            globalChatMessages.push(...data.messages);
                            lastGlobalChatId = globalChatMessages[globalChatMessages.length - 1].id;
                            displayGlobalChatMessages();
                            
                            // Show unread badge if chat is closed
                            if (!globalChatOpen) {
                                const badge = document.getElementById('chat-unread-badge');
                                badge.style.display = 'flex';
                                badge.textContent = data.messages.length;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error polling chat:', error);
                }
            }, 3000); // Poll every 3 seconds
        }

        function stopGlobalChatPolling() {
            if (globalChatPollInterval) {
                clearInterval(globalChatPollInterval);
                globalChatPollInterval = null;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize chat when user is logged in
        if (window.currentUser) {
            initGlobalChat();
            // Start polling for new messages even when chat is closed
            startGlobalChatPolling();
        }
    </script>
</body>
</html>