<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Kappa Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0d0d0d;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .admin-header {
            background: linear-gradient(135deg, rgba(199, 170, 106, 0.2) 0%, rgba(0, 0, 0, 0.6) 100%);
            border-bottom: 2px solid #3a3a3a;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            color: #c7aa6a;
            font-size: 28px;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            color: #c7aa6a;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #c7aa6a;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(199, 170, 106, 0.2);
        }

        .dashboard-container {
            flex: 1;
            display: grid;
            grid-template-columns: 0.7fr 1.3fr 1fr 1fr;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }

        .panel {
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid #3a3a3a;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: rgba(199, 170, 106, 0.1);
            border-bottom: 2px solid #3a3a3a;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            color: #c7aa6a;
            font-size: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            background: #c7aa6a;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: #c7aa6a;
            border-radius: 4px;
        }

        .user-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            flex-direction: column;
            align-items: flex-start;
            gap: 32px;
        }

        .user-card:hover {
            border-color: #c7aa6a;
            background: rgba(0, 0, 0, 0.6);
        }

        .user-info-section {
            flex: 1;
        }

        .user-info-section .name {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-info-section .details {
            color: #888;
            font-size: 13px;
        }

        .user-info-section .username {
            color: #c7aa6a;
            font-weight: 600;
        }

        .user-info-section .date {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            width: 100%;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-approve {
            background: #4CAF50;
            color: #fff;
        }

        .btn-approve:hover {
            background: #45a049;
        }

        .btn-delete {
            background: #f44336;
            color: #fff;
        }

        .btn-delete:hover {
            background: #da190b;
        }

        .btn-warning {
            background: #ff9800;
            color: #fff;
        }

        .btn-warning:hover {
            background: #e68900;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading, .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .loading i, .empty-state i {
            font-size: 36px;
            margin-bottom: 12px;
            color: #555;
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .notification.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stats-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-mini {
            flex: 1;
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #c7aa6a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-mini .value {
            color: #c7aa6a;
            font-size: 24px;
            font-weight: 700;
        }

        .stat-mini .label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .user-email {
            color: #888;
            filter: blur(5px);
            transition: filter 0.2s;
            cursor: help;
        }

        .user-email:hover {
            filter: blur(0px);
        }

        /* Chat Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c7aa6a;
            border-radius: 4px;
        }

        .chat-message {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .chat-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            flex-shrink: 0;
            font-size: 12px;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-bubble {
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #3a3a3a;
            padding: 6px 10px;
            border-radius: 8px;
            flex: 1;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .chat-name {
            font-weight: 600;
            color: #c7aa6a;
            font-size: 12px;
        }

        .chat-time {
            font-size: 10px;
            color: #666;
        }

        .chat-text {
            color: #ddd;
            font-size: 13px;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .chat-input-area {
            border-top: 2px solid #3a3a3a;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            padding: 10px 14px;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #c7aa6a;
        }

        .chat-send-btn {
            background: #c7aa6a;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: #d4b870;
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 1600px) {
            .dashboard-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                overflow-y: auto;
            }
        }

        .report-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .report-type-bug {
            background: #f44336;
            color: #fff;
        }

        .report-type-feature {
            background: #4CAF50;
            color: #fff;
        }

        .report-type-quest-error {
            background: #ff9800;
            color: #fff;
        }

        .report-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .status-pending {
            background: #ff9800;
            color: #000;
        }

        .status-reviewed {
            background: #2196F3;
            color: #fff;
        }

        .status-resolved {
            background: #4CAF50;
            color: #fff;
        }

        .status-closed {
            background: #666;
            color: #fff;
        }

        .btn-resolve {
            background: #4CAF50;
            color: #fff;
        }

        .btn-resolve:hover {
            background: #45a049;
        }

        .btn-close {
            background: #666;
            color: #fff;
        }

        .btn-close:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <div class="admin-header">
        <h1><i class="fas fa-shield-alt"></i> ADMIN DASHBOARD</h1>
        <div class="nav-links">
            <a href="/"><i class="fas fa-home"></i> Dashboard</a>
            <a href="/rankings.html"><i class="fas fa-trophy"></i> Rankings</a>
            <a href="#" onclick="loadData()"><i class="fas fa-sync"></i> Refresh</a>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Admin Log Panel -->
        <div class="panel">
            <div class="panel-header">
                <h2>
                    <i class="fas fa-history"></i>
                    Admin Log
                    <span class="badge" id="log-count">0</span>
                </h2>
                <button onclick="clearAdminLogs()" class="btn-danger" style="padding: 8px 16px; font-size: 12px; border-radius: 6px; cursor: pointer; background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545; transition: all 0.3s;">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
            <div class="panel-content" id="admin-log-list">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <!-- Admin Chat Panel -->
        <div class="panel">
            <div class="panel-header">
                <h2>
                    <i class="fas fa-comments"></i>
                    Admin Chat
                </h2>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <textarea id="chat-input" class="chat-input" placeholder="Type your message..." rows="1"></textarea>
                        <button id="chat-send-btn" class="chat-send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Users Panel -->
        <div class="panel">
            <div class="panel-header">
                <h2>
                    <i class="fas fa-users"></i>
                    All Users
                    <span class="badge" id="users-count">0</span>
                </h2>
            </div>
            <div class="panel-content">
                <div class="stats-row">
                    <div class="stat-mini">
                        <div class="value" id="total-users">0</div>
                        <div class="label">Total Users</div>
                    </div>
                    <div class="stat-mini">
                        <div class="value" id="approved-users">0</div>
                        <div class="label">On Leaderboard</div>
                    </div>
                    <div class="stat-mini">
                        <div class="value" id="admin-users">0</div>
                        <div class="label">Admins</div>
                    </div>
                </div>
                <div id="all-users-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Panel -->
        <div class="panel">
            <div class="panel-header">
                <h2>
                    <i class="fas fa-flag"></i>
                    Bug Reports & Features
                    <span class="badge" id="reports-count">0</span>
                </h2>
            </div>
            <div class="panel-content">
                <div class="stats-row">
                    <div class="stat-mini">
                        <div class="value" id="pending-reports">0</div>
                        <div class="label">Pending</div>
                    </div>
                    <div class="stat-mini">
                        <div class="value" id="bug-reports">0</div>
                        <div class="label">Bugs</div>
                    </div>
                    <div class="stat-mini">
                        <div class="value" id="feature-reports">0</div>
                        <div class="label">Features</div>
                    </div>
                </div>
                <div id="reports-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminLogs = [];
        let allUsers = [];
        let reports = [];

        async function loadData() {
            await Promise.all([loadAdminLogs(), loadAllUsers(), loadReports()]);
        }

        async function loadAdminLogs() {
            try {
                const response = await fetch('/api/admin/logs', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Access denied. Admin privileges required.', 'error');
                        setTimeout(() => window.location.href = '/', 2000);
                        return;
                    }
                    throw new Error('Failed to load admin logs');
                }

                const data = await response.json();
                adminLogs = data.logs;
                
                displayAdminLogs();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('admin-log-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load</p>
                    </div>
                `;
            }
        }

        async function loadAllUsers() {
            try {
                const response = await fetch('/api/admin/all-users', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load users');

                const data = await response.json();
                allUsers = data.users;
                
                displayAllUsers();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('all-users-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load</p>
                    </div>
                `;
            }
        }

        function updateStats() {
            document.getElementById('total-users').textContent = allUsers.length;
            document.getElementById('approved-users').textContent = allUsers.filter(u => u.approved).length;
            document.getElementById('admin-users').textContent = allUsers.filter(u => u.isAdmin).length;
        }

        function displayAdminLogs() {
            const container = document.getElementById('admin-log-list');
            const countEl = document.getElementById('log-count');
            
            countEl.textContent = adminLogs.length;

            if (adminLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p>No admin actions logged yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = adminLogs.map(log => {
                const actionIcons = {
                    'approved_user': '<i class="fas fa-trophy" style="color: #4CAF50;"></i>',
                    'removed_user': '<i class="fas fa-ban" style="color: #ff9800;"></i>',
                    'deleted_user': '<i class="fas fa-trash" style="color: #f44336;"></i>',
                    'granted_admin': '<i class="fas fa-crown" style="color: #ffd700;"></i>',
                    'revoked_admin': '<i class="fas fa-user-minus" style="color: #ff9800;"></i>',
                    'verified_user': '<i class="fas fa-circle-check" style="color: #2196F3;"></i>',
                    'unverified_user': '<i class="fas fa-times-circle" style="color: #ff9800;"></i>',
                    'added_to_leaderboard': '<i class="fas fa-trophy" style="color: #4CAF50;"></i>',
                    'removed_from_leaderboard': '<i class="fas fa-user-slash" style="color: #ff9800;"></i>',
                    'fixed_quest': '<i class="fas fa-wrench" style="color: #2196F3;"></i>'
                };
                
                const icon = actionIcons[log.action] || '<i class="fas fa-cog"></i>';
                
                // Parse quest fix description (format: "QuestName|Change1|Change2|...")
                let displayContent = log.description;
                let changesHtml = '';
                
                if (log.action === 'fixed_quest' && log.description.includes('|')) {
                    const parts = log.description.split('|');
                    const questName = parts[0];
                    const changes = parts.slice(1);
                    
                    // Extract field names that were changed for highlighting
                    const changedFields = changes.map(change => {
                        if (change.includes('Trader:')) return 'trader';
                        if (change.includes('Level:')) return 'level';
                        if (change.includes('Map:')) return 'mapName';
                        if (change.includes('Kappa:')) return 'requiredForKappa';
                        if (change.includes('Notes')) return 'notes';
                        if (change.includes('Images:')) return 'images';
                        if (change.includes('Shopping list:')) return 'shoppingList';
                        if (change.includes('Prerequisites')) return 'prerequisiteQuests';
                        // All item-related changes map to requiredItems
                        if (change.includes('Markers:') || 
                            change.includes('Cameras:') || 
                            change.includes('Jammers:') ||
                            change.includes('Keys:') ||
                            change.includes('FIR items:') ||
                            change.includes('Required items')) return 'requiredItems';
                        return null;
                    }).filter(f => f);
                    
                    displayContent = `<strong style="color: #c7aa6a;">Quest:</strong> <a href="#" onclick="openQuestFromLog('${questName.replace(/'/g, "\\'")}', ${JSON.stringify(changedFields).replace(/"/g, '&quot;')}); return false;" style="color: #2196F3; text-decoration: none; border-bottom: 1px dotted #2196F3;">${questName}</a>`;
                    if (changes.length > 0) {
                        changesHtml = `
                            <div style="margin-top: 6px; padding-left: 28px; font-size: 12px; color: #aaa;">
                                ${changes.map(change => `
                                    <div style="margin: 2px 0; padding: 3px 8px; background: rgba(33, 150, 243, 0.1); border-left: 2px solid #2196F3; border-radius: 3px;">
                                        <i class="fas fa-arrow-right" style="font-size: 10px; margin-right: 6px; color: #2196F3;"></i>${change}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }
                
                return `
                    <div class="user-card" style="padding: 12px; border-left: 3px solid ${log.action === 'fixed_quest' ? '#2196F3' : log.action.includes('delete') ? '#f44336' : log.action.includes('admin') ? '#ffd700' : '#4CAF50'};">
                        <div class="user-info-section" style="flex: 1;">
                            <div class="name" style="font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                ${icon}
                                <span>${displayContent}</span>
                            </div>
                            ${changesHtml}
                            <div class="date" style="margin-top: 6px; font-size: 11px; color: #666;">
                                <i class="fas fa-user-shield" style="margin-right: 4px;"></i>
                                <span style="color: #c7aa6a;">${log.adminUsername}</span>
                                <span style="margin: 0 6px;">‚Ä¢</span>
                                <i class="fas fa-clock" style="margin-right: 4px;"></i>
                                ${new Date(log.createdAt).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayAllUsers() {
            const container = document.getElementById('all-users-list');
            const countEl = document.getElementById('users-count');
            
            countEl.textContent = allUsers.length;

            if (allUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <p>No users found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allUsers.map(user => `
                <div class="user-card" id="user-${user.id}">
                    <div class="user-info-section">
                        <div class="name">
                            ${user.displayName || user.username}
                            ${user.isAdmin ? '<i class="fas fa-crown" style="color: #ffd700; margin-left: 8px;" title="Admin"></i>' : ''}
                            ${user.verified ? '<i class="fas fa-circle-check" style="color: #2196F3; margin-left: 8px;" title="Verified User"></i>' : ''}
                            ${!user.approved ? '<i class="fas fa-ban" style="color: #ff9800; margin-left: 8px;" title="Not on Leaderboard"></i>' : '<i class="fas fa-trophy" style="color: #4CAF50; margin-left: 8px;" title="On Leaderboard"></i>'}
                        </div>
                        <div class="details">
                            <span class="username">@${user.username}</span> ‚Ä¢ <span class="user-email" style="filter: blur(4px); cursor: pointer;" onmouseover="this.style.filter='blur(0px)'" onmouseout="this.style.filter='blur(4px)'" title="Hover to reveal">${user.email}</span>
                        </div>
                        <div class="date">
                            Joined: ${new Date(user.createdAt).toLocaleDateString()} ‚Ä¢ 
                            Quests: ${user.progress?.totalCompleted || 0}
                        </div>
                    </div>
                    <div class="action-buttons">
                        ${user.approved ? `
                            <button class="btn btn-warning" onclick="toggleLeaderboard('${user.id}', '${user.username}', false)" title="Remove from Leaderboard">
                                <i class="fas fa-trophy"></i>
                            </button>
                        ` : `
                            <button class="btn btn-approve" onclick="toggleLeaderboard('${user.id}', '${user.username}', true)" title="Add to Leaderboard">
                                <i class="fas fa-trophy"></i>
                            </button>
                        `}
                        ${user.verified ? `
                            <button class="btn btn-warning" onclick="toggleVerified('${user.id}', '${user.username}', false)" title="Remove Verification">
                                <i class="fas fa-circle-check"></i>
                            </button>
                        ` : `
                            <button class="btn btn-approve" onclick="toggleVerified('${user.id}', '${user.username}', true)" style="background: #2196F3; color: #fff;" title="Verify User">
                                <i class="fas fa-circle-check"></i>
                            </button>
                        `}
                        ${!user.isAdmin ? `
                            <button class="btn btn-approve" onclick="toggleAdmin('${user.id}', '${user.username}', true)" style="background: #ffd700; color: #000;" title="Make Admin">
                                <i class="fas fa-crown"></i>
                            </button>
                            <button class="btn btn-delete" onclick="deleteUser('${user.id}', '${user.username}')" title="Delete User">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button class="btn btn-warning" onclick="toggleAdmin('${user.id}', '${user.username}', false)" title="Remove Admin">
                                <i class="fas fa-crown"></i>
                            </button>
                        `}
                    </div>
                </div>
            `).join('');
        }

        async function toggleLeaderboard(userId, username, addToLeaderboard) {
            const action = addToLeaderboard ? 'ADD TO LEADERBOARD' : 'REMOVE FROM LEADERBOARD';
            if (!confirm(`${action}: ${username}?\n\n${addToLeaderboard ? 'This user will appear on public rankings.' : 'This user will be hidden from public rankings.'}`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/toggle-leaderboard/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ approved: addToLeaderboard })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update leaderboard status');
                }

                const data = await response.json();
                showNotification(addToLeaderboard ? `üèÜ Added to leaderboard: ${username}` : `üìä Removed from leaderboard: ${username}`, 'success');
                
                await loadData();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        async function toggleAdmin(userId, username, makeAdmin) {
            const action = makeAdmin ? 'give admin role to' : 'remove admin role from';
            if (!confirm(`${makeAdmin ? 'GRANT ADMIN ACCESS' : 'REVOKE ADMIN ACCESS'}: ${username}?\n\nThis will ${action} ${username}.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/toggle-admin/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isAdmin: makeAdmin })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update admin status');
                }

                const data = await response.json();
                showNotification(makeAdmin ? `üëë Admin granted: ${username}` : `üë§ Admin removed: ${username}`, 'success');
                
                await loadData();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        async function toggleVerified(userId, username, verifyUser) {
            const action = verifyUser ? 'VERIFY USER' : 'REMOVE VERIFICATION';
            if (!confirm(`${action}: ${username}?\n\n${verifyUser ? 'This user will be marked as verified (streamer/trusted).' : 'This user will no longer be verified.'}`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/toggle-verified/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ verified: verifyUser })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update verified status');
                }

                const data = await response.json();
                showNotification(verifyUser ? `‚úì Verified: ${username}` : `‚úó Unverified: ${username}`, 'success');
                
                await loadData();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`DELETE USER: ${username}?\n\nThis will permanently delete:\n- User account\n- All quest progress\n- All activities\n\nThis action CANNOT be undone!`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/delete-user/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }

                const data = await response.json();
                showNotification(`üóëÔ∏è Deleted: ${username}`, 'success');
                
                await loadData();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        async function loadReports() {
            try {
                const response = await fetch('/api/admin/reports', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load reports');

                const data = await response.json();
                reports = data.reports;
                
                displayReports();
                updateReportStats();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('reports-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load</p>
                    </div>
                `;
            }
        }

        function updateReportStats() {
            document.getElementById('reports-count').textContent = reports.length;
            document.getElementById('pending-reports').textContent = reports.filter(r => r.status === 'pending').length;
            document.getElementById('bug-reports').textContent = reports.filter(r => r.type === 'bug' || r.type === 'quest-error').length;
            document.getElementById('feature-reports').textContent = reports.filter(r => r.type === 'feature').length;
        }

        function displayReports() {
            const container = document.getElementById('reports-list');
            
            if (reports.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>No reports</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reports.map(report => {
                let typeBadge = 'report-type-bug';
                if (report.type === 'feature') typeBadge = 'report-type-feature';
                if (report.type === 'quest-error') typeBadge = 'report-type-quest-error';
                
                const statusClass = `status-${report.status}`;
                const userName = report.user.displayName || report.user.username;
                
                return `
                    <div class="user-card" id="report-${report.id}">
                        <div class="user-info-section" style="flex: 1;">
                            <div class="name">
                                <span class="report-type-badge ${typeBadge}">${report.type}</span>
                                <span class="report-status ${statusClass}">${report.status}</span>
                                ${report.title}
                            </div>
                            ${report.questName ? `
                                <div class="details" style="margin-top: 4px; color: #c7aa6a; font-size: 13px;">
                                    <i class="fas fa-compass"></i> Quest: ${report.questName}
                                </div>
                            ` : ''}
                            <div class="details" style="margin-top: 8px;">
                                ${report.description}
                            </div>
                            <div class="date" style="margin-top: 6px;">
                                By: <span style="color: #c7aa6a;">${userName}</span> ‚Ä¢ 
                                ${new Date(report.createdAt).toLocaleString()}
                            </div>
                        </div>
                        <div class="action-buttons">
                            ${report.status !== 'resolved' ? `
                                <button class="btn btn-resolve" onclick="resolveReport('${report.id}')">
                                    <i class="fas fa-check"></i> Resolve
                                </button>
                            ` : ''}
                            ${report.status !== 'closed' ? `
                                <button class="btn btn-close" onclick="closeReport('${report.id}')">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            ` : ''}
                            <button class="btn btn-delete" onclick="deleteReport('${report.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function resolveReport(reportId) {
            try {
                const response = await fetch(`/api/admin/reports/${reportId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'resolved' })
                });

                if (!response.ok) throw new Error('Failed to resolve report');

                showNotification('‚úì Report marked as resolved', 'success');
                await loadReports();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to resolve report', 'error');
            }
        }

        async function closeReport(reportId) {
            try {
                const response = await fetch(`/api/admin/reports/${reportId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'closed' })
                });

                if (!response.ok) throw new Error('Failed to close report');

                showNotification('‚úì Report closed', 'success');
                await loadReports();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to close report', 'error');
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('Delete this report permanently?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/reports/${reportId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to delete report');

                showNotification('üóëÔ∏è Report deleted', 'success');
                await loadReports();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to delete report', 'error');
            }
        }

        async function clearAdminLogs() {
            if (!confirm('‚ö†Ô∏è This will permanently delete ALL admin logs. Are you sure?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/logs/clear', {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to clear logs');

                const data = await response.json();
                showNotification(`üóëÔ∏è ${data.message}`, 'success');
                await loadData(); // Reload all data including logs
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to clear admin logs', 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Open quest from log in main app
        function openQuestFromLog(questName, changedFields) {
            // Store quest info in localStorage so main page can pick it up
            localStorage.setItem('openQuestFromAdmin', JSON.stringify({
                questName: questName,
                changedFields: changedFields,
                timestamp: Date.now()
            }));
            
            // Open main page in new tab
            window.open('/', '_blank');
        }

        // ========================================================================
        // ADMIN CHAT
        // ========================================================================

        let chatMessages = [];
        let currentUser = null;

        async function getCurrentUser() {
            try {
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                if (response.ok) {
                    currentUser = await response.json();
                }
            } catch (error) {
                console.error('Error getting current user:', error);
            }
        }

        let lastRenderedMessageId = null;

        function renderChatMessages() {
            const container = document.getElementById('chat-messages');
            if (!currentUser) return;
            
            // Only render new messages
            const messagesToRender = lastRenderedMessageId 
                ? chatMessages.filter(msg => msg.id > lastRenderedMessageId || !lastRenderedMessageId)
                : chatMessages;
            
            if (messagesToRender.length === 0) return;
            
            messagesToRender.forEach(msg => {
                const initials = msg.username ? msg.username.substring(0, 2).toUpperCase() : 'AD';
                const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const messageHtml = `
                    <div class="chat-message" data-message-id="${msg.id}">
                        <div class="chat-avatar">
                            ${msg.avatarUrl ? `<img src="${msg.avatarUrl}" alt="${msg.username}">` : initials}
                        </div>
                        <div class="chat-bubble">
                            <div class="chat-header-info">
                                <span class="chat-name">${msg.username}</span>
                                <span class="chat-time">${time}</span>
                            </div>
                            <div class="chat-text">${escapeHtml(msg.message)}</div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', messageHtml);
                lastRenderedMessageId = msg.id;
            });
            
            // Auto-scroll to bottom only if user is near bottom
            const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
            if (isNearBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !currentUser) return;
            
            try {
                const response = await fetch('/api/admin/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) throw new Error('Failed to send message');
                
                const newMessage = await response.json();
                
                // Add to array and render only if not already there
                if (!chatMessages.find(m => m.id === newMessage.id)) {
                    chatMessages.push(newMessage);
                    renderChatMessages();
                }
                
                input.value = '';
                input.style.height = '40px';
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
        }

        async function loadChatMessages() {
            try {
                const response = await fetch('/api/admin/chat', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load messages');
                
                const fetchedMessages = await response.json();
                
                // Only add new messages that we don't have yet
                const newMessages = fetchedMessages.filter(msg => 
                    !chatMessages.find(existing => existing.id === msg.id)
                );
                
                if (newMessages.length > 0) {
                    chatMessages.push(...newMessages);
                    renderChatMessages();
                }
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        // Chat event listeners
        document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);
        
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // ========================================================================
        // INITIALIZATION
        // ========================================================================

        // Load data on page load
        async function initializeAdmin() {
            await getCurrentUser();
            await loadData();
            await loadChatMessages();
            
            // Reload data every 30 seconds
            setInterval(loadData, 30000);
            
            // Reload chat every 5 seconds
            setInterval(loadChatMessages, 5000);
        }

        initializeAdmin();
    </script>
</body>
</html>
