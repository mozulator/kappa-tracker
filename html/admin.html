<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Kappa Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0d0d0d;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .admin-header {
            background: linear-gradient(135deg, rgba(199, 170, 106, 0.2) 0%, rgba(0, 0, 0, 0.6) 100%);
            border-bottom: 2px solid #3a3a3a;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .admin-header h1 {
            color: #c7aa6a;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            color: #c7aa6a;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #c7aa6a;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(199, 170, 106, 0.2);
        }

        /* New Sidebar Layout */
        .admin-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .admin-sidebar {
            width: 260px;
            background: rgba(20, 20, 20, 0.95);
            border-right: 2px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .sidebar-menu::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-menu::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .sidebar-menu::-webkit-scrollbar-thumb {
            background: rgba(199, 170, 106, 0.3);
            border-radius: 3px;
        }

        .menu-item {
            padding: 16px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #888;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-size: 15px;
            font-weight: 700;
        }

        .menu-item:hover {
            background: rgba(199, 170, 106, 0.05);
            color: #c7aa6a;
        }

        .menu-item.active {
            background: rgba(199, 170, 106, 0.1);
            border-left-color: #c7aa6a;
            color: #c7aa6a;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
            margin-right: auto;
        }

        .admin-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-section {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .content-section.active {
            display: flex;
        }

        .section-header {
            padding: 30px;
            border-bottom: 2px solid #3a3a3a;
            background: rgba(199, 170, 106, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .section-header h2 {
            color: #c7aa6a;
            font-size: 26px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .section-header p {
            color: #888;
            font-size: 14px;
        }

        .section-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .section-content::-webkit-scrollbar {
            width: 10px;
        }

        .section-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .section-content::-webkit-scrollbar-thumb {
            background: rgba(199, 170, 106, 0.3);
            border-radius: 5px;
        }

        /* Dashboard grid for overview */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid #3a3a3a;
            border-radius: 12px;
            padding: 24px;
        }

        .stat-card h3 {
            color: #888;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .stat-card .value {
            color: #c7aa6a;
            font-size: 36px;
            font-weight: 700;
        }

        .dashboard-container {
            display: none; /* Hide old grid layout */
        }

        .panel {
            background: rgba(30, 30, 30, 0.8);
            border: 2px solid #3a3a3a;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: rgba(199, 170, 106, 0.1);
            border-bottom: 2px solid #3a3a3a;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            color: #c7aa6a;
            font-size: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            background: #c7aa6a;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: #c7aa6a;
            border-radius: 4px;
        }

        .user-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .user-card:hover {
            border-color: #c7aa6a;
            background: rgba(0, 0, 0, 0.6);
        }

        .log-item {
            margin-bottom: 12px;
        }

        .log-item:last-child {
            margin-bottom: 0;
        }

        .user-info-section {
            flex: 1;
        }

        .user-info-section .name {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-info-section .details {
            color: #888;
            font-size: 13px;
        }

        .user-info-section .username {
            color: #c7aa6a;
            font-weight: 600;
        }

        .user-info-section .date {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }

        #all-users-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        
        .action-buttons .btn {
            flex: 1;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #c7aa6a;
            color: #c7aa6a;
        }

        .btn:hover {
            background: rgba(199, 170, 106, 0.2);
        }

        .btn-approve {
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #c7aa6a;
            color: #c7aa6a;
        }

        .btn-approve:hover {
            background: rgba(199, 170, 106, 0.2);
        }

        .btn-approve.add-action {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }

        .btn-approve.add-action:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .btn-approve.remove-action {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }

        .btn-approve.remove-action:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .btn-approve.verified {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
            color: #2196F3;
        }

        .btn-approve.verified:hover {
            background: rgba(33, 150, 243, 0.3);
        }

        .btn-delete {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }

        .btn-delete:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .btn-warning {
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #c7aa6a;
            color: #c7aa6a;
        }

        .btn-warning:hover {
            background: rgba(199, 170, 106, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading, .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .loading i, .empty-state i {
            font-size: 36px;
            margin-bottom: 12px;
            color: #555;
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .notification.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stats-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-mini {
            flex: 1;
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #c7aa6a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-mini .value {
            color: #c7aa6a;
            font-size: 24px;
            font-weight: 700;
        }

        .stat-mini .label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .user-email {
            color: #888;
            filter: blur(5px);
            transition: filter 0.2s;
            cursor: help;
        }

        .user-email:hover {
            filter: blur(0px);
        }

        /* Chat Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c7aa6a;
            border-radius: 4px;
        }

        .chat-message {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .chat-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            flex-shrink: 0;
            font-size: 12px;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-bubble {
            background: rgba(199, 170, 106, 0.1);
            border: 1px solid #3a3a3a;
            padding: 6px 10px;
            border-radius: 8px;
            flex: 1;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .chat-name {
            font-weight: 600;
            color: #c7aa6a;
            font-size: 12px;
        }

        .chat-time {
            font-size: 10px;
            color: #666;
        }

        .chat-text {
            color: #ddd;
            font-size: 13px;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .chat-input-area {
            border-top: 2px solid #3a3a3a;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            padding: 10px 14px;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #c7aa6a;
        }

        .chat-send-btn {
            background: #c7aa6a;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: #d4b870;
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 1600px) {
            .dashboard-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                overflow-y: auto;
            }
        }

        .report-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .report-type-bug {
            background: #f44336;
            color: #fff;
        }

        .report-type-feature {
            background: #4CAF50;
            color: #fff;
        }

        .report-type-quest-error {
            background: #ff9800;
            color: #fff;
        }

        .report-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .status-pending {
            background: #ff9800;
            color: #000;
        }

        .status-reviewed {
            background: #2196F3;
            color: #fff;
        }

        .status-resolved {
            background: #4CAF50;
            color: #fff;
        }

        .status-closed {
            background: #666;
            color: #fff;
        }

        .btn-resolve {
            background: #4CAF50;
            color: #fff;
        }

        .btn-resolve:hover {
            background: #45a049;
        }

        .btn-close {
            background: #666;
            color: #fff;
        }

        .btn-close:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <div class="admin-header">
        <h1><i class="fas fa-shield-alt"></i> ADMIN DASHBOARD</h1>
        <div class="nav-links">
            <a href="/"><i class="fas fa-home"></i> Dashboard</a>
            <a href="#" onclick="loadData()"><i class="fas fa-sync"></i> Refresh</a>
        </div>
    </div>

    <div class="admin-container">
        <!-- Sidebar Navigation -->
        <div class="admin-sidebar">
            <div class="sidebar-menu">
                <div class="menu-item active" data-section="overview">
                    <i class="fas fa-chart-line"></i>
                    <span>Overview</span>
                </div>
                <div class="menu-item" data-section="chat">
                    <i class="fas fa-comments"></i>
                    <span>Admin Chat</span>
                </div>
                <div class="menu-item" data-section="logs">
                    <i class="fas fa-history"></i>
                    <span>Admin Logs</span>
                </div>
                <div class="menu-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>All Users</span>
                </div>
                <div class="menu-item" data-section="reports">
                    <i class="fas fa-bug"></i>
                    <span>Bugs & Reports</span>
                </div>
                <div class="menu-item" data-section="banner">
                    <i class="fas fa-bullhorn"></i>
                    <span>Site Banner</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="admin-content">
            <!-- Overview Section -->
            <section id="overview-section" class="content-section active">
                <div class="section-header">
                    <h2><i class="fas fa-chart-line"></i> Overview</h2>
                    <p>Quick statistics and insights</p>
                </div>
                <div class="section-content">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <h3>Total Users</h3>
                            <div class="value" id="overview-total-users">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Leaderboard Users</h3>
                            <div class="value" id="overview-approved-users">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Admin Users</h3>
                            <div class="value" id="overview-admin-users">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Reports</h3>
                            <div class="value" id="overview-total-reports">0</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Chat Section -->
            <section id="chat-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2><i class="fas fa-comments"></i> Admin Chat</h2>
                        <p>Communicate with other administrators</p>
                    </div>
                    <button onclick="purgeAdminChat()" class="btn-danger" style="padding: 10px 20px; font-size: 14px; border-radius: 6px; cursor: pointer; background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545; transition: all 0.3s;">
                        <i class="fas fa-broom"></i> Purge Chat
                    </button>
                </div>
                <div class="section-content" style="padding: 0; display: flex; flex-direction: column;">
                    <div class="panel" style="margin: 0; flex: 1; border: none; border-radius: 0;">
                        <div class="chat-container">
                            <div class="chat-messages" id="chat-messages">
                                <!-- Chat messages will appear here -->
                            </div>
                            <div class="chat-input-area">
                                <div class="chat-input-wrapper">
                                    <textarea id="chat-input" class="chat-input" placeholder="Type your message..." rows="1"></textarea>
                                    <button id="chat-send-btn" class="chat-send-btn">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Logs Section -->
            <section id="logs-section" class="content-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-history"></i> Admin Logs
                        <span class="badge" id="log-count" style="margin-left: 10px;">0</span>
                    </h2>
                    <p>Activity log and system events</p>
                </div>
                <div class="section-content">
                    <div style="margin-bottom: 20px; text-align: right;">
                        <button onclick="clearAdminLogs()" class="btn-danger" style="padding: 10px 20px; font-size: 14px; border-radius: 6px; cursor: pointer; background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545; transition: all 0.3s;">
                            <i class="fas fa-trash"></i> Clear All Logs
                        </button>
                    </div>
                    <div id="admin-log-list">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- All Users Section -->
            <section id="users-section" class="content-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-users"></i> All Users
                        <span class="badge" id="users-count" style="margin-left: 10px;">0</span>
                    </h2>
                    <p>Manage user accounts and permissions</p>
                </div>
                <div class="section-content">
                    <div class="stats-row" style="margin-bottom: 30px;">
                        <div class="stat-mini">
                            <div class="value" id="total-users">0</div>
                            <div class="label">Total Users</div>
                        </div>
                        <div class="stat-mini">
                            <div class="value" id="approved-users">0</div>
                            <div class="label">On Leaderboard</div>
                        </div>
                        <div class="stat-mini">
                            <div class="value" id="admin-users">0</div>
                            <div class="label">Admins</div>
                        </div>
                    </div>
                    
                    <!-- User Filters -->
                    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <input type="text" id="user-search" placeholder="🔍 Search users..." style="flex: 1; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 14px;">
                        <select id="user-sort" style="padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #3a3a3a; border-radius: 6px; color: #fff; font-size: 14px; min-width: 180px;">
                            <option value="date">Sort: Newest First</option>
                            <option value="date-old">Sort: Oldest First</option>
                            <option value="alphabetical">Sort: A-Z</option>
                            <option value="roles">Sort: By Roles</option>
                        </select>
                    </div>
                    
                    <div id="all-users-list">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Bugs & Reports Section -->
            <section id="reports-section" class="content-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-bug"></i> Bugs & Reports
                        <span class="badge" id="bugs-count" style="margin-left: 10px;">0</span>
                    </h2>
                    <p>User feedback and bug reports</p>
                </div>
                <div class="section-content">
                    <div id="bugs-reports-list">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Site Banner Section -->
            <section id="banner-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-bullhorn"></i> Site Banner Message</h2>
                    <p>Manage the global announcement banner</p>
                </div>
                <div class="section-content">
                    <div class="panel">
                        <div class="panel-content" style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="banner-enabled" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #fff;">Enable Banner</span>
                                </label>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #c7aa6a; font-weight: 600;">Banner Message</label>
                                <textarea id="banner-message" placeholder="Enter banner message..." style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(199, 170, 106, 0.3); border-radius: 6px; color: #fff; font-size: 14px; font-family: inherit; min-height: 80px; resize: vertical;" maxlength="500"></textarea>
                                <small style="color: #888;">This message will appear as a banner at the top of the main site when enabled.</small>
                            </div>
                            <button onclick="saveBannerSettings()" style="padding: 10px 20px; background: var(--text-highlight); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                <i class="fas fa-save"></i> Save Banner Settings
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Sidebar Navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                
                // Update menu active state
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // Update content sections
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(`${section}-section`).classList.add('active');
            });
        });
    </script>

    <script>
        let adminLogs = [];
        let allUsers = [];
        let reports = [];
        let lastAdminChatId = null;
        let adminChatTotalCount = 0;
        let adminChatPinnedMessage = null;
        let adminChatEmotes = [];

        async function loadData() {
            await Promise.all([loadAdminLogs(), loadAllUsers(), loadReports(), loadBannerSettings(), load7TVEmotesForAdminChat()]);
        }
        
        async function load7TVEmotesForAdminChat() {
            try {
                const response = await fetch('/api/7tv-emotes');
                const data = await response.json();
                adminChatEmotes = data.emotes || [];
            } catch (error) {
                console.error('Error loading 7TV emotes for admin chat:', error);
            }
        }
        
        async function loadBannerSettings() {
            try {
                const response = await fetch('/api/site-banner', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('banner-enabled').checked = data.enabled || false;
                    document.getElementById('banner-message').value = data.message || '';
                }
            } catch (error) {
                console.error('Error loading banner settings:', error);
            }
        }
        
        async function saveBannerSettings() {
            const enabled = document.getElementById('banner-enabled').checked;
            const message = document.getElementById('banner-message').value.trim();
            
            try {
                const response = await fetch('/api/site-banner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ enabled, message })
                });
                
                if (response.ok) {
                    showNotification('Banner settings saved successfully!', 'success');
                } else {
                    showNotification('Failed to save banner settings', 'error');
                }
            } catch (error) {
                console.error('Error saving banner settings:', error);
                showNotification('Error saving banner settings', 'error');
            }
        }

        async function loadAdminLogs() {
            try {
                const response = await fetch('/api/admin/logs', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Access denied. Admin privileges required.', 'error');
                        setTimeout(() => window.location.href = '/', 2000);
                        return;
                    }
                    throw new Error('Failed to load admin logs');
                }

                const data = await response.json();
                adminLogs = data.logs;
                
                displayAdminLogs();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('admin-log-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load</p>
                    </div>
                `;
            }
        }

        async function loadAllUsers() {
            try {
                const response = await fetch('/api/admin/all-users', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load users');

                const data = await response.json();
                allUsers = data.users;
                
                displayAllUsers();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('all-users-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load</p>
                    </div>
                `;
            }
        }

        function updateStats() {
            document.getElementById('total-users').textContent = allUsers.length;
            document.getElementById('approved-users').textContent = allUsers.filter(u => u.approved).length;
            document.getElementById('admin-users').textContent = allUsers.filter(u => u.isAdmin).length;
            
            // Update overview stats
            document.getElementById('overview-total-users').textContent = allUsers.length;
            document.getElementById('overview-approved-users').textContent = allUsers.filter(u => u.approved).length;
            document.getElementById('overview-admin-users').textContent = allUsers.filter(u => u.isAdmin).length;
        }

        function displayAdminLogs() {
            const container = document.getElementById('admin-log-list');
            const countEl = document.getElementById('log-count');
            
            countEl.textContent = adminLogs.length;

            if (adminLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p>No admin actions logged yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = adminLogs.map(log => {
                const actionIcons = {
                    'approved_user': '<i class="fas fa-trophy" style="color: #4CAF50;"></i>',
                    'removed_user': '<i class="fas fa-ban" style="color: #ff9800;"></i>',
                    'deleted_user': '<i class="fas fa-trash" style="color: #f44336;"></i>',
                    'granted_admin': '<i class="fas fa-crown" style="color: #ffd700;"></i>',
                    'revoked_admin': '<i class="fas fa-user-minus" style="color: #ff9800;"></i>',
                    'verified_user': '<i class="fas fa-circle-check" style="color: #2196F3;"></i>',
                    'unverified_user': '<i class="fas fa-times-circle" style="color: #ff9800;"></i>',
                    'added_to_leaderboard': '<i class="fas fa-trophy" style="color: #4CAF50;"></i>',
                    'removed_from_leaderboard': '<i class="fas fa-user-slash" style="color: #ff9800;"></i>',
                    'fixed_quest': '<i class="fas fa-wrench" style="color: #2196F3;"></i>'
                };
                
                const icon = actionIcons[log.action] || '<i class="fas fa-cog"></i>';
                
                // Parse quest fix description (format: "QuestName|Change1|Change2|...")
                let displayContent = log.description;
                let changesHtml = '';
                
                if (log.action === 'fixed_quest' && log.description.includes('|')) {
                    const parts = log.description.split('|');
                    const questName = parts[0];
                    const changes = parts.slice(1);
                    
                    // Extract field names that were changed for highlighting
                    const changedFields = changes.map(change => {
                        if (change.includes('Trader:')) return 'trader';
                        if (change.includes('Level:')) return 'level';
                        if (change.includes('Map:')) return 'mapName';
                        if (change.includes('Kappa:')) return 'requiredForKappa';
                        if (change.includes('Notes')) return 'notes';
                        if (change.includes('Images:')) return 'images';
                        if (change.includes('Shopping list:')) return 'shoppingList';
                        if (change.includes('Prerequisites')) return 'prerequisiteQuests';
                        // All item-related changes map to requiredItems
                        if (change.includes('Markers:') || 
                            change.includes('Cameras:') || 
                            change.includes('Jammers:') ||
                            change.includes('Keys:') ||
                            change.includes('FIR items:') ||
                            change.includes('Required items')) return 'requiredItems';
                        return null;
                    }).filter(f => f);
                    
                    displayContent = `<strong style="color: #c7aa6a;">Quest:</strong> <a href="#" onclick="openQuestFromLog('${questName.replace(/'/g, "\\'")}', ${JSON.stringify(changedFields).replace(/"/g, '&quot;')}); return false;" style="color: #2196F3; text-decoration: none; border-bottom: 1px dotted #2196F3;">${questName}</a>`;
                    if (changes.length > 0) {
                        changesHtml = `
                            <div style="margin-top: 6px; padding-left: 28px; font-size: 12px; color: #aaa;">
                                ${changes.map(change => `
                                    <div style="margin: 2px 0; padding: 3px 8px; background: rgba(33, 150, 243, 0.1); border-left: 2px solid #2196F3; border-radius: 3px;">
                                        <i class="fas fa-arrow-right" style="font-size: 10px; margin-right: 6px; color: #2196F3;"></i>${change}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }
                
                return `
                    <div class="user-card log-item" style="padding: 12px; border-left: 3px solid ${log.action === 'fixed_quest' ? '#2196F3' : log.action.includes('delete') ? '#f44336' : log.action.includes('admin') ? '#ffd700' : '#4CAF50'};">
                        <div class="user-info-section" style="flex: 1;">
                            <div class="name" style="font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                ${icon}
                                <span>${displayContent}</span>
                            </div>
                            ${changesHtml}
                            <div class="date" style="margin-top: 6px; font-size: 11px; color: #666;">
                                <i class="fas fa-user-shield" style="margin-right: 4px;"></i>
                                <span style="color: #c7aa6a;">${log.adminUsername}</span>
                                <span style="margin: 0 6px;">•</span>
                                <i class="fas fa-clock" style="margin-right: 4px;"></i>
                                ${new Date(log.createdAt).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayAllUsers() {
            const container = document.getElementById('all-users-list');
            const countEl = document.getElementById('users-count');
            const searchInput = document.getElementById('user-search');
            const sortSelect = document.getElementById('user-sort');
            
            // Filter users by search
            let filteredUsers = [...allUsers];
            if (searchInput && searchInput.value.trim()) {
                const searchTerm = searchInput.value.toLowerCase().trim();
                filteredUsers = filteredUsers.filter(user => {
                    const displayName = (user.displayName || user.username).toLowerCase();
                    const username = user.username.toLowerCase();
                    const email = user.email.toLowerCase();
                    return displayName.includes(searchTerm) || username.includes(searchTerm) || email.includes(searchTerm);
                });
            }
            
            // Sort users
            if (sortSelect) {
                const sortValue = sortSelect.value;
                filteredUsers.sort((a, b) => {
                    switch(sortValue) {
                        case 'date': // Newest first
                            return new Date(b.createdAt) - new Date(a.createdAt);
                        case 'date-old': // Oldest first
                            return new Date(a.createdAt) - new Date(b.createdAt);
                        case 'alphabetical': // A-Z
                            const nameA = (a.displayName || a.username).toLowerCase();
                            const nameB = (b.displayName || b.username).toLowerCase();
                            return nameA.localeCompare(nameB);
                        case 'roles': // Admins > Leaderboard > Others
                            if (a.isAdmin !== b.isAdmin) return b.isAdmin ? 1 : -1;
                            if (a.approved !== b.approved) return b.approved ? 1 : -1;
                            return 0;
                        default:
                            return 0;
                    }
                });
            }
            
            countEl.textContent = filteredUsers.length;

            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <p>No users found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredUsers.map(user => `
                <div class="user-card" id="user-${user.id}">
                    <div class="user-info-section">
                        <div class="name">
                            ${user.displayName || user.username}
                            ${user.isAdmin ? '<i class="fas fa-crown" style="color: #ffd700; margin-left: 8px;" title="Admin"></i>' : ''}
                            ${user.verified ? '<i class="fas fa-circle-check" style="color: #2196F3; margin-left: 8px;" title="Verified User"></i>' : ''}
                            ${!user.approved ? '<i class="fas fa-ban" style="color: #ff9800; margin-left: 8px;" title="Not on Leaderboard"></i>' : '<i class="fas fa-trophy" style="color: #4CAF50; margin-left: 8px;" title="On Leaderboard"></i>'}
                        </div>
                        <div class="date">
                            Joined: ${new Date(user.createdAt).toLocaleDateString()} • 
                            Quests: ${user.progress?.totalCompleted || 0}
                        </div>
                    </div>
                    <div class="action-buttons">
                        ${user.approved ? `
                            <button class="btn btn-approve remove-action" onclick="toggleLeaderboard('${user.id}', '${user.username}', false)" title="Remove from Leaderboard">
                                <i class="fas fa-trophy"></i>
                            </button>
                        ` : `
                            <button class="btn btn-approve add-action" onclick="toggleLeaderboard('${user.id}', '${user.username}', true)" title="Add to Leaderboard">
                                <i class="fas fa-trophy"></i>
                            </button>
                        `}
                        ${user.verified ? `
                            <button class="btn btn-approve remove-action" onclick="toggleVerified('${user.id}', '${user.username}', false)" title="Remove Verification">
                                <i class="fas fa-circle-check"></i>
                            </button>
                        ` : `
                            <button class="btn btn-approve add-action" onclick="toggleVerified('${user.id}', '${user.username}', true)" title="Verify User">
                                <i class="fas fa-circle-check"></i>
                            </button>
                        `}
                        ${!user.isAdmin ? `
                            <button class="btn btn-approve add-action" onclick="toggleAdmin('${user.id}', '${user.username}', true)" title="Make Admin">
                                <i class="fas fa-crown"></i>
                            </button>
                            <button class="btn btn-delete" onclick="deleteUser('${user.id}', '${user.username}')" title="Delete User">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button class="btn btn-approve remove-action" onclick="toggleAdmin('${user.id}', '${user.username}', false)" title="Remove Admin">
                                <i class="fas fa-crown"></i>
                            </button>
                        `}
                    </div>
                </div>
            `).join('');
        }

        async function toggleLeaderboard(userId, username, addToLeaderboard) {
            const action = addToLeaderboard ? 'ADD TO LEADERBOARD' : 'REMOVE FROM LEADERBOARD';
            if (!confirm(`${action}: ${username}?\n\n${addToLeaderboard ? 'This user will appear on public rankings.' : 'This user will be hidden from public rankings.'}`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/toggle-leaderboard/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ approved: addToLeaderboard })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update leaderboard status');
                }

                const data = await response.json();
                showNotification(addToLeaderboard ? `🏆 Added to leaderboard: ${username}` : `📊 Removed from leaderboard: ${username}`, 'success');
                
                await loadData();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        async function toggleAdmin(userId, username, makeAdmin) {
            const action = makeAdmin ? 'give admin role to' : 'remove admin role from';
            if (!confirm(`${makeAdmin ? 'GRANT ADMIN ACCESS' : 'REVOKE ADMIN ACCESS'}: ${username}?\n\nThis will ${action} ${username}.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/toggle-admin/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isAdmin: makeAdmin })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update admin status');
                }

                const data = await response.json();
                showNotification(makeAdmin ? `👑 Admin granted: ${username}` : `👤 Admin removed: ${username}`, 'success');
                
                await loadData();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        async function toggleVerified(userId, username, verifyUser) {
            const action = verifyUser ? 'VERIFY USER' : 'REMOVE VERIFICATION';
            if (!confirm(`${action}: ${username}?\n\n${verifyUser ? 'This user will be marked as verified (streamer/trusted).' : 'This user will no longer be verified.'}`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/toggle-verified/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ verified: verifyUser })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update verified status');
                }

                const data = await response.json();
                showNotification(verifyUser ? `✓ Verified: ${username}` : `✗ Unverified: ${username}`, 'success');
                
                await loadData();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`DELETE USER: ${username}?\n\nThis will permanently delete:\n- User account\n- All quest progress\n- All activities\n\nThis action CANNOT be undone!`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/delete-user/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }

                const data = await response.json();
                showNotification(`🗑️ Deleted: ${username}`, 'success');
                
                await loadData();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        async function loadReports() {
            try {
                const response = await fetch('/api/admin/reports', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load reports');

                const data = await response.json();
                reports = data.reports;
                
                displayReports();
                updateReportStats();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('bugs-reports-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load</p>
                    </div>
                `;
            }
        }

        function updateReportStats() {
            const reportCount = reports.length;
            document.getElementById('bugs-count').textContent = reportCount;
            
            // Update overview
            document.getElementById('overview-total-reports').textContent = reportCount;
        }

        function displayReports() {
            const container = document.getElementById('bugs-reports-list');
            
            if (reports.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>No reports</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reports.map(report => {
                let typeBadge = 'report-type-bug';
                if (report.type === 'feature') typeBadge = 'report-type-feature';
                if (report.type === 'quest-error') typeBadge = 'report-type-quest-error';
                
                const statusClass = `status-${report.status}`;
                const userName = report.user.displayName || report.user.username;
                
                return `
                    <div class="user-card" id="report-${report.id}">
                        <div class="user-info-section" style="flex: 1;">
                            <div class="name">
                                <span class="report-type-badge ${typeBadge}">${report.type}</span>
                                <span class="report-status ${statusClass}">${report.status}</span>
                                ${report.type === 'quest-error' && report.questName ? `[${report.questName}] ` : ''}${report.title}
                            </div>
                            ${report.questName ? `
                                <div class="details" style="margin-top: 4px; color: #c7aa6a; font-size: 13px;">
                                    <i class="fas fa-compass"></i> Quest: ${report.questName}
                                </div>
                            ` : ''}
                            <div class="details" style="margin-top: 8px;">
                                ${report.description}
                            </div>
                            <div class="date" style="margin-top: 6px;">
                                By: <span style="color: #c7aa6a;">${userName}</span> • 
                                ${new Date(report.createdAt).toLocaleString()}
                            </div>
                        </div>
                        <div class="action-buttons">
                            ${report.status !== 'resolved' ? `
                                <button class="btn btn-resolve" onclick="resolveReport('${report.id}')">
                                    <i class="fas fa-check"></i> Resolve
                                </button>
                            ` : ''}
                            ${report.status !== 'closed' ? `
                                <button class="btn btn-close" onclick="closeReport('${report.id}')">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            ` : ''}
                            <button class="btn btn-delete" onclick="deleteReport('${report.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function resolveReport(reportId) {
            try {
                const response = await fetch(`/api/admin/reports/${reportId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'resolved' })
                });

                if (!response.ok) throw new Error('Failed to resolve report');

                showNotification('✓ Report marked as resolved', 'success');
                await loadReports();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to resolve report', 'error');
            }
        }

        async function closeReport(reportId) {
            try {
                const response = await fetch(`/api/admin/reports/${reportId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'closed' })
                });

                if (!response.ok) throw new Error('Failed to close report');

                showNotification('✓ Report closed', 'success');
                await loadReports();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to close report', 'error');
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('Delete this report permanently?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/reports/${reportId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to delete report');

                showNotification('🗑️ Report deleted', 'success');
                await loadReports();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to delete report', 'error');
            }
        }

        async function clearAdminLogs() {
            if (!confirm('⚠️ This will permanently delete ALL admin logs. Are you sure?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/logs/clear', {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to clear logs');

                const data = await response.json();
                showNotification(`🗑️ ${data.message}`, 'success');
                await loadData(); // Reload all data including logs
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to clear admin logs', 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Open quest from log in main app
        function openQuestFromLog(questName, changedFields) {
            // Store quest info in localStorage so main page can pick it up
            localStorage.setItem('openQuestFromAdmin', JSON.stringify({
                questName: questName,
                changedFields: changedFields,
                timestamp: Date.now()
            }));
            
            // Open main page in new tab
            window.open('/', '_blank');
        }

        // ========================================================================
        // ADMIN CHAT
        // ========================================================================

        let chatMessages = [];
        let currentUser = null;

        async function getCurrentUser() {
            try {
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                if (response.ok) {
                    currentUser = await response.json();
                }
            } catch (error) {
                console.error('Error getting current user:', error);
            }
        }

        let lastRenderedMessageId = null;

        function renderChatMessages() {
            const container = document.getElementById('chat-messages');
            if (!currentUser) return;
            
            // Clear and re-render all messages to handle deletions
            container.innerHTML = '';
            lastRenderedMessageId = null;
            
            // Render pinned message if exists
            if (adminChatPinnedMessage) {
                const initials = adminChatPinnedMessage.username ? adminChatPinnedMessage.username.substring(0, 2).toUpperCase() : 'AD';
                const time = new Date(adminChatPinnedMessage.timestamp).toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const pinnedHtml = `
                    <div class="pinned-message" style="background: rgba(199, 170, 106, 0.15); border: 2px solid rgba(199, 170, 106, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                            <i class="fas fa-thumbtack" style="color: #c7aa6a;"></i>
                            <span style="color: #c7aa6a; font-weight: 600; font-size: 12px; text-transform: uppercase;">Pinned Message</span>
                            <button onclick="unpinAdminChatMessage('${adminChatPinnedMessage.id}')" class="pin-btn" title="Unpin message" style="margin-left: auto; padding: 4px 8px; font-size: 11px; background: rgba(199, 170, 106, 0.2); border: 1px solid #c7aa6a; color: #c7aa6a; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-times"></i> Unpin
                            </button>
                        </div>
                        <div style="display: flex; gap: 10px; min-width: 0;">
                            <div class="chat-avatar" style="width: 32px; height: 32px; flex-shrink: 0;">
                                ${adminChatPinnedMessage.avatarUrl ? `<img src="${adminChatPinnedMessage.avatarUrl}" alt="${adminChatPinnedMessage.username}" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(adminChatPinnedMessage.username)}&background=1a1a1a&color=c7aa6a&size=64'">` : initials}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                                    <span style="color: #c7aa6a; font-weight: 600; font-size: 13px;">${adminChatPinnedMessage.username}</span>
                                    <span style="color: #666; font-size: 11px;">${time}</span>
                                </div>
                                <div style="color: #ddd; font-size: 13px; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap;">${replaceAdminChatEmotes(adminChatPinnedMessage.message)}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', pinnedHtml);
            }
            
            chatMessages.forEach(msg => {
                const initials = msg.username ? msg.username.substring(0, 2).toUpperCase() : 'AD';
                const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const isPinned = adminChatPinnedMessage && adminChatPinnedMessage.id === msg.id;
                
                const messageHtml = `
                    <div class="chat-message" data-message-id="${msg.id}">
                        <div class="chat-avatar">
                            ${msg.avatarUrl ? `<img src="${msg.avatarUrl}" alt="${msg.username}" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(msg.username)}&background=1a1a1a&color=c7aa6a&size=64'">` : initials}
                        </div>
                        <div class="chat-bubble">
                            <div class="chat-header-info">
                                <span class="chat-name">${msg.username}</span>
                                <span class="chat-time">${time}</span>
                                ${!isPinned ? `
                                    <button onclick="pinAdminChatMessage('${msg.id}')" class="pin-btn" title="Pin message" style="margin-left: auto; padding: 4px 8px; font-size: 11px;">
                                        <i class="fas fa-thumbtack"></i>
                                    </button>
                                ` : ''}
                                <button onclick="deleteAdminChatMessage('${msg.id}')" class="delete-btn" title="Delete message" style="padding: 4px 8px; font-size: 11px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="chat-text">${replaceAdminChatEmotes(msg.message)}</div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', messageHtml);
                lastRenderedMessageId = msg.id;
            });
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function replaceAdminChatEmotes(text) {
            let result = escapeHtml(text);
            
            if (adminChatEmotes.length === 0) return result;
            
            // Default: replace all emotes with normal size (use 1x resolution)
            adminChatEmotes.forEach(emote => {
                const regex = new RegExp(`\\b${emote.name}\\b`, 'g');
                const emoteUrl = emote.url1x || emote.url;
                result = result.replace(regex, `<img src="${emoteUrl}" alt="${emote.name}" title="${emote.name}" style="height: 24px; vertical-align: middle; display: inline-block; margin: 0 2px;">`);
            });
            
            return result;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !currentUser) return;
            
            try {
                const response = await fetch('/api/admin/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) throw new Error('Failed to send message');
                
                const newMessage = await response.json();
                
                // Add to array and render only if not already there
                if (!chatMessages.find(m => m.id === newMessage.id)) {
                    chatMessages.push(newMessage);
                    renderChatMessages();
                }
                
                input.value = '';
                input.style.height = '40px';
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
        }

        async function loadChatMessages() {
            try {
                const url = lastAdminChatId 
                    ? `/api/admin/chat?after=${lastAdminChatId}`
                    : '/api/admin/chat';
                    
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load messages');
                
                const data = await response.json();
                const newMessages = data.messages || [];
                const totalCount = data.totalCount || 0;
                adminChatPinnedMessage = data.pinnedMessage || null;
                
                // Check if chat was purged (total count is 0 but we have messages locally)
                if (totalCount === 0 && chatMessages.length > 0) {
                    console.log('Admin chat was purged, clearing local messages');
                    chatMessages = [];
                    lastAdminChatId = null;
                    adminChatTotalCount = 0;
                    adminChatPinnedMessage = null;
                    renderChatMessages();
                    return;
                }
                
                // Check for deleted messages by validating our current messages still exist
                if (lastAdminChatId && chatMessages.length > 0) {
                    const serverMessageIds = new Set(data.allRecentIds || []);
                    if (serverMessageIds.size > 0) {
                        const beforeCount = chatMessages.length;
                        chatMessages = chatMessages.filter(m => serverMessageIds.has(m.id));
                        const afterCount = chatMessages.length;
                        
                        if (beforeCount !== afterCount) {
                            console.log(`Removed ${beforeCount - afterCount} deleted messages from admin chat`);
                            renderChatMessages();
                        }
                    }
                }
                
                // Add new messages
                if (newMessages.length > 0) {
                    const existingIds = new Set(chatMessages.map(m => m.id));
                    const uniqueNewMessages = newMessages.filter(m => !existingIds.has(m.id));
                    
                    if (uniqueNewMessages.length > 0) {
                        chatMessages.push(...uniqueNewMessages);
                        if (chatMessages.length > 0) {
                            lastAdminChatId = chatMessages[chatMessages.length - 1].id;
                        }
                        renderChatMessages();
                    }
                } else if (!lastAdminChatId && newMessages.length === 0) {
                    // Initial load with no messages
                    renderChatMessages();
                }
                
                adminChatTotalCount = totalCount;
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }
        
        async function deleteAdminChatMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) return;
            
            try {
                const response = await fetch(`/api/admin/chat/${messageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Remove message from local array
                    chatMessages = chatMessages.filter(m => m.id !== messageId);
                    renderChatMessages();
                    showNotification('Message deleted successfully', 'success');
                } else {
                    showNotification('Failed to delete message', 'error');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Error deleting message', 'error');
            }
        }
        
        async function purgeAdminChat() {
            if (!confirm('Are you sure you want to purge all admin chat messages? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/chat/purge/all', {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    chatMessages = [];
                    lastAdminChatId = null;
                    adminChatTotalCount = 0;
                    adminChatPinnedMessage = null;
                    renderChatMessages();
                    showNotification('Admin chat purged successfully', 'success');
                } else {
                    const error = await response.json();
                    showNotification('Failed to purge admin chat: ' + (error.details || error.error), 'error');
                }
            } catch (error) {
                console.error('Error purging admin chat:', error);
                showNotification('Error purging admin chat', 'error');
            }
        }
        
        async function pinAdminChatMessage(messageId) {
            try {
                const response = await fetch(`/api/admin/chat/${messageId}/pin`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Update pinned message immediately from local array
                    const message = chatMessages.find(m => m.id === messageId);
                    if (message) {
                        adminChatPinnedMessage = message;
                        renderChatMessages();
                        showNotification('Message pinned successfully', 'success');
                    }
                } else {
                    showNotification('Failed to pin message', 'error');
                }
            } catch (error) {
                console.error('Error pinning message:', error);
                showNotification('Error pinning message', 'error');
            }
        }
        
        async function unpinAdminChatMessage(messageId) {
            try {
                const response = await fetch(`/api/admin/chat/${messageId}/unpin`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    adminChatPinnedMessage = null;
                    renderChatMessages();
                    showNotification('Message unpinned successfully', 'success');
                } else {
                    showNotification('Failed to unpin message', 'error');
                }
            } catch (error) {
                console.error('Error unpinning message:', error);
                showNotification('Error unpinning message', 'error');
            }
        }

        // Chat event listeners
        document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);
        
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // ========================================================================
        // INITIALIZATION
        // ========================================================================

        // Load data on page load
        async function initializeAdmin() {
            await getCurrentUser();
            await loadData();
            await loadChatMessages();
            
            // Setup user filter event listeners
            const userSearch = document.getElementById('user-search');
            const userSort = document.getElementById('user-sort');
            
            if (userSearch) {
                userSearch.addEventListener('input', () => {
                    displayAllUsers();
                });
            }
            
            if (userSort) {
                userSort.addEventListener('change', () => {
                    displayAllUsers();
                });
            }
            
            // Reload data every 30 seconds
            setInterval(loadData, 30000);
            
            // Reload chat every 5 seconds
            setInterval(loadChatMessages, 5000);
        }

        initializeAdmin();
    </script>
</body>
</html>
